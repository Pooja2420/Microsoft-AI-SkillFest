Note
Access to this page requires authorization. You can trysigning inorchanging directories.
Access to this page requires authorization. You can trychanging directories.
Workspace Managed Virtual Network Isolation
Article
2025-04-03
21 contributors
In this article
APPLIES TO:Azure CLI ml extension v2 (current)Python SDK azure-ai-ml v2 (current)
Azure Machine Learning provides support for managed virtual network (managed virtual network) isolation. Managed virtual network isolation streamlines and automates your network isolation configuration with a built-in, workspace-level Azure Machine Learning managed virtual network. The managed virtual network secures your managed Azure Machine Learning resources, such as compute instances, compute clusters, serverless compute, and managed online endpoints.
Securing your workspace with amanaged networkprovides network isolation foroutboundaccess from the workspace and managed computes. AnAzure Virtual Network that you create and manageis used to provide network isolationinboundaccess to the workspace. For example, a private endpoint for the workspace is created in your Azure Virtual Network. Any clients connecting to the virtual network can access the workspace through the private endpoint. When running jobs on managed computes, the managed network restricts what the compute can access.
Managed Virtual Network Architecture
When you enable managed virtual network isolation, a managed virtual network is created for the workspace. Managed compute resources you create for the workspace automatically use this managed virtual network. The managed virtual network can use private endpoints for Azure resources that are used by your workspace, such as Azure Storage, Azure Key Vault, and Azure Container Registry.
There are two different configuration modes for outbound traffic from the managed virtual network:
Tip
Regardless of the outbound mode you use, traffic to Azure resources can be configured to use a private endpoint. For example, you might allow all outbound traffic to the internet, but restrict communication with Azure resources by adding outbound rules for the resources.
1: You can use outbound rules withallow only approved outboundmode to achieve the same result as using allow internet outbound. The differences are:
You must add rules for each outbound connection you need to allow.
Adding FQDN outbound rulesincrease your costsas this rule type uses Azure Firewall. For more information, seePricing
The default rules forallow only approved outboundare designed to minimize the risk of data exfiltration. Any outbound rules you add might increase your risk.
The managed virtual network is preconfigured withrequired default rules. It's also configured for private endpoint connections to your workspace, workspace's default storage, container registry, and key vaultif they're configured as privateorthe workspace isolation mode is set to allow only approved outbound. After choosing the isolation mode, you only need to consider other outbound requirements you might need to add.
The following diagram shows a managed virtual network configured toallow internet outbound:

The following diagram shows a managed virtual network configured toallow only approved outbound:
Note
In this configuration, the storage, key vault, and container registry used by the workspace are flagged as private. Since they're flagged as private, a private endpoint is used to communicate with them.

Note
Once a managed VNet workspace is configured toallow internet outbound, the workspace can't be reconfigured todisabled. Similarly, once a managed VNet workspace is configured toallow only approved outbound, the workspace can't be reconfigured toallow internet outbound. Keep this in mind when selecting the isolation mode for managed VNet in your workspace.
Azure Machine Learning studio
If you want to use the integrated notebook or create datasets in the default storage account from studio, your client needs access to the default storage account. Create aprivate endpointorservice endpointfor the default storage account in the Azure Virtual Network that the clients use.
Part of Azure Machine Learning studio runs locally in the client's web browser, and communicates directly with the default storage for the workspace. Creating a private endpoint or service endpoint (for the default storage account) in the client's virtual network ensures that the client can communicate with the storage account.
If the workspace associated Azure storage account has public network access disabled, ensure the private endpoint created in the client virtual network is granted the Reader role to your workspace managed identity. This applies to both blog and file storage private endpoints. The role isn't required for the private endpoint created by the managed virtual network.
For more information on creating a private endpoint or service endpoint, see theConnect privately to a storage accountandService Endpointsarticles.
Secured associated resources
If you add the following services to the virtual network by using either a service endpoint or a private endpoint (disabling the public access), allow trusted Microsoft services to access these services:
Prerequisites
Before following the steps in this article, make sure you have the following prerequisites:
Azure CLI
Python SDK
Azure portal
An Azure subscription. If you don't have an Azure subscription, create a free account before you begin. Try thefree or paid version of Azure Machine Learning.
An Azure subscription. If you don't have an Azure subscription, create a free account before you begin. Try thefree or paid version of Azure Machine Learning.
TheMicrosoft.Networkresource provider must be registered for your Azure subscription. This resource provider is used by the workspace when creating private endpoints for the managed virtual network.For information on registering resource providers, seeResolve errors for resource provider registration.
TheMicrosoft.Networkresource provider must be registered for your Azure subscription. This resource provider is used by the workspace when creating private endpoints for the managed virtual network.
For information on registering resource providers, seeResolve errors for resource provider registration.
The Azure identity you use when deploying a managed network requires the followingAzure role-based access control (Azure RBAC)actions to create private endpoints:Microsoft.MachineLearningServices/workspaces/privateEndpointConnections/readMicrosoft.MachineLearningServices/workspaces/privateEndpointConnections/write
The Azure identity you use when deploying a managed network requires the followingAzure role-based access control (Azure RBAC)actions to create private endpoints:
Microsoft.MachineLearningServices/workspaces/privateEndpointConnections/read
Microsoft.MachineLearningServices/workspaces/privateEndpointConnections/read
Microsoft.MachineLearningServices/workspaces/privateEndpointConnections/write
Microsoft.MachineLearningServices/workspaces/privateEndpointConnections/write
TheAzure CLIand themlextension to the Azure CLI. For more information, seeInstall, set up, and use the CLI (v2).TipAzure Machine Learning managed VNet was introduced on May 23rd, 2023. If you have an older version of the ml extension, you might need to update it for the examples in this article work. To update the extension, use the following Azure CLI command:az extension update -n ml
TheAzure CLIand themlextension to the Azure CLI. For more information, seeInstall, set up, and use the CLI (v2).
ml
Tip
Azure Machine Learning managed VNet was introduced on May 23rd, 2023. If you have an older version of the ml extension, you might need to update it for the examples in this article work. To update the extension, use the following Azure CLI command:
az extension update -n ml
az extension update -n ml
The CLI examples in this article assume that you're using the Bash (or compatible) shell. For example, from a Linux system orWindows Subsystem for Linux.
The CLI examples in this article assume that you're using the Bash (or compatible) shell. For example, from a Linux system orWindows Subsystem for Linux.
The Azure CLI examples in this article usewsto represent the name of the workspace, andrgto represent the name of the resource group. Change these values as needed when using the commands with your Azure subscription.
The Azure CLI examples in this article usewsto represent the name of the workspace, andrgto represent the name of the resource group. Change these values as needed when using the commands with your Azure subscription.
ws
rg
An Azure subscription. If you don't have an Azure subscription, create a free account before you begin. Try thefree or paid version of Azure Machine Learning.
An Azure subscription. If you don't have an Azure subscription, create a free account before you begin. Try thefree or paid version of Azure Machine Learning.
TheMicrosoft.Networkresource provider must be registered for your Azure subscription. This resource provider is used by the workspace when creating private endpoints for the managed virtual network.For information on registering resource providers, seeResolve errors for resource provider registration.
TheMicrosoft.Networkresource provider must be registered for your Azure subscription. This resource provider is used by the workspace when creating private endpoints for the managed virtual network.
For information on registering resource providers, seeResolve errors for resource provider registration.
The Azure identity you use when deploying a managed network requires the followingAzure role-based access control (Azure RBAC)actions to create private endpoints:Microsoft.MachineLearningServices/workspaces/privateEndpointConnections/readMicrosoft.MachineLearningServices/workspaces/privateEndpointConnections/write
The Azure identity you use when deploying a managed network requires the followingAzure role-based access control (Azure RBAC)actions to create private endpoints:
Microsoft.MachineLearningServices/workspaces/privateEndpointConnections/read
Microsoft.MachineLearningServices/workspaces/privateEndpointConnections/read
Microsoft.MachineLearningServices/workspaces/privateEndpointConnections/write
Microsoft.MachineLearningServices/workspaces/privateEndpointConnections/write
The Azure Machine Learning Python SDK v2. For more information on the SDK, seeInstall the Python SDK v2 for Azure Machine Learning.TipAzure Machine Learning managed VNet was introduced on May 23rd, 2023. If you have an older version of the SDK installed, you might need to update it for the examples in this article to work. To update the SDK, use the following command:pip install --upgrade azure-ai-ml azure-identity
The Azure Machine Learning Python SDK v2. For more information on the SDK, seeInstall the Python SDK v2 for Azure Machine Learning.
Tip
Azure Machine Learning managed VNet was introduced on May 23rd, 2023. If you have an older version of the SDK installed, you might need to update it for the examples in this article to work. To update the SDK, use the following command:
pip install --upgrade azure-ai-ml azure-identity
pip install --upgrade azure-ai-ml azure-identity
The examples in this article assume that your code begins with the following Python. This code imports the classes required when creating a workspace with managed virtual network, sets variables for your Azure subscription and resource group, and creates theml_client:from azure.ai.ml import MLClient
from azure.ai.ml.entities import (
    Workspace,
    ManagedNetwork,
    IsolationMode,
    ServiceTagDestination,
    PrivateEndpointDestination,
    FqdnDestination
)
from azure.identity import DefaultAzureCredential

# Replace with the values for your Azure subscription and resource group.
subscription_id = "<SUBSCRIPTION_ID>"
resource_group = "<RESOURCE_GROUP>"

# get a handle to the subscription
ml_client = MLClient(DefaultAzureCredential(), subscription_id=subscription_id, resource_group_name=resource_group)
The examples in this article assume that your code begins with the following Python. This code imports the classes required when creating a workspace with managed virtual network, sets variables for your Azure subscription and resource group, and creates theml_client:
ml_client
from azure.ai.ml import MLClient
from azure.ai.ml.entities import (
    Workspace,
    ManagedNetwork,
    IsolationMode,
    ServiceTagDestination,
    PrivateEndpointDestination,
    FqdnDestination
)
from azure.identity import DefaultAzureCredential

# Replace with the values for your Azure subscription and resource group.
subscription_id = "<SUBSCRIPTION_ID>"
resource_group = "<RESOURCE_GROUP>"

# get a handle to the subscription
ml_client = MLClient(DefaultAzureCredential(), subscription_id=subscription_id, resource_group_name=resource_group)
from azure.ai.ml import MLClient
from azure.ai.ml.entities import (
    Workspace,
    ManagedNetwork,
    IsolationMode,
    ServiceTagDestination,
    PrivateEndpointDestination,
    FqdnDestination
)
from azure.identity import DefaultAzureCredential

# Replace with the values for your Azure subscription and resource group.
subscription_id = "<SUBSCRIPTION_ID>"
resource_group = "<RESOURCE_GROUP>"

# get a handle to the subscription
ml_client = MLClient(DefaultAzureCredential(), subscription_id=subscription_id, resource_group_name=resource_group)
An Azure subscription. If you don't have an Azure subscription, create a free account before you begin. Try thefree or paid version of Azure Machine Learning.
An Azure subscription. If you don't have an Azure subscription, create a free account before you begin. Try thefree or paid version of Azure Machine Learning.
TheMicrosoft.Networkresource provider must be registered for your Azure subscription. This resource provider is used by the workspace when creating private endpoints for the managed virtual network.For information on registering resource providers, seeResolve errors for resource provider registration.
TheMicrosoft.Networkresource provider must be registered for your Azure subscription. This resource provider is used by the workspace when creating private endpoints for the managed virtual network.
For information on registering resource providers, seeResolve errors for resource provider registration.
The Azure identity you use when deploying a managed network requires the followingAzure role-based access control (Azure RBAC)actions to create private endpoints:Microsoft.MachineLearningServices/workspaces/privateEndpointConnections/readMicrosoft.MachineLearningServices/workspaces/privateEndpointConnections/write
The Azure identity you use when deploying a managed network requires the followingAzure role-based access control (Azure RBAC)actions to create private endpoints:
Microsoft.MachineLearningServices/workspaces/privateEndpointConnections/read
Microsoft.MachineLearningServices/workspaces/privateEndpointConnections/read
Microsoft.MachineLearningServices/workspaces/privateEndpointConnections/write
Microsoft.MachineLearningServices/workspaces/privateEndpointConnections/write
Note
To establish private endpoint connections in managed virtual networks using Azure Machine Learning, the workspace managed identity, whether system-assigned or user-assigned, must have permissions to approve the Private Endpoint connections on the target resources. Previously, this was done through automatic role assignments by the Azure Machine Learning service. However, there are security concerns about the automatic role assignment. To improve security, starting April 30th, 2025, we will discontinue this automatic permission grant logic. We recommend assigning theAzure AI Enterprise Network Connection Approverrole or a custom role with the necessary private endpoint connection permissions on the target resource types and grant this role to the Azure Machine Learning workspace's managed identity to allow Azure Machine Learning services to approve Private Endpoint connections to the target Azure resources.
Here's the list of private endpoint target resource types covered by theAzure AI Enterprise Network Connection Approverrole:
Azure Application Gateway
Azure Monitor
Azure AI Search
Event Hubs
Azure SQL Database
Azure Storage
Azure Machine Learning workspace
Azure Machine Learning registry
Azure AI Foundry
Azure Key Vault
Azure CosmosDB
Azure Database for MySQL
Azure Database for PostgreSQL
Azure AI Services
Azure Cache for Redis
Container Registry
API Management
If you would like to create a custom role instead, seeAzure AI Enterprise Network Connection Approver roleto add the specific actions for each resource type.
For creating private endpoint outbound rules to target resource types not covered by theAzure AI Enterprise Network Connection Approverrole, such as Azure Data Factory, Azure Databricks, and Azure Function Apps, a custom scoped-down role is recommended, defined only by the actions necessary to approve private endpoint connections on the target resource types.
For creating Private Endpoint outbound rules to default workspace resources, the required permissions are automatically covered by the role assignments granted during workspace creation, so no additional action is needed.
Configure a managed virtual network to allow internet outbound
Tip
The creation of the managed VNet is deferred until a compute resource is created or provisioning is manually started. When you allow automatic creation, it can take around30 minutesto create the first compute resource as it is also provisioning the network. For more information, seeManually provision the network.
Important
If you plan to submit serverless Spark jobs, you must manually start provisioning. For more information, see theconfigure for serverless Spark jobssection.
Azure CLI
Python SDK
Azure portal
To configure a managed virtual network that allows internet outbound communications, you can use either the--managed-network allow_internet_outboundparameter or a YAML configuration file that contains the following entries:
--managed-network allow_internet_outbound
managed_network:
  isolation_mode: allow_internet_outbound
managed_network:
  isolation_mode: allow_internet_outbound
You can also defineoutbound rulesto other Azure services that the workspace relies on. These rules defineprivate endpointsthat allow an Azure resource to securely communicate with the managed virtual network. The following rule demonstrates adding a private endpoint to an Azure Blob resource.
managed_network:
  isolation_mode: allow_internet_outbound
  outbound_rules:
  - name: added-perule
    destination:
      service_resource_id: /subscriptions/<SUBSCRIPTION_ID>/resourceGroups/<RESOURCE_GROUP>/providers/Microsoft.Storage/storageAccounts/<STORAGE_ACCOUNT_NAME>
      spark_enabled: true
      subresource_target: blob
    type: private_endpoint
managed_network:
  isolation_mode: allow_internet_outbound
  outbound_rules:
  - name: added-perule
    destination:
      service_resource_id: /subscriptions/<SUBSCRIPTION_ID>/resourceGroups/<RESOURCE_GROUP>/providers/Microsoft.Storage/storageAccounts/<STORAGE_ACCOUNT_NAME>
      spark_enabled: true
      subresource_target: blob
    type: private_endpoint
You can configure a managed virtual network using either theaz ml workspace createoraz ml workspace updatecommands:
az ml workspace create
az ml workspace update
Create a new workspace:The following example creates a new workspace. The--managed-network allow_internet_outboundparameter configures a managed virtual network for the workspace:az ml workspace create --name ws --resource-group rg --managed-network allow_internet_outboundTo create a workspace using a YAML file instead, use the--fileparameter and specify the YAML file that contains the configuration settings:az ml workspace create --file workspace.yaml --resource-group rg --name wsThe following YAML example defines a workspace with a managed virtual network:name: myworkspace
location: EastUS
managed_network:
  isolation_mode: allow_internet_outbound
Create a new workspace:
The following example creates a new workspace. The--managed-network allow_internet_outboundparameter configures a managed virtual network for the workspace:
--managed-network allow_internet_outbound
az ml workspace create --name ws --resource-group rg --managed-network allow_internet_outbound
az ml workspace create --name ws --resource-group rg --managed-network allow_internet_outbound
To create a workspace using a YAML file instead, use the--fileparameter and specify the YAML file that contains the configuration settings:
--file
az ml workspace create --file workspace.yaml --resource-group rg --name ws
az ml workspace create --file workspace.yaml --resource-group rg --name ws
The following YAML example defines a workspace with a managed virtual network:
name: myworkspace
location: EastUS
managed_network:
  isolation_mode: allow_internet_outbound
name: myworkspace
location: EastUS
managed_network:
  isolation_mode: allow_internet_outbound
Update an existing workspace:WarningBefore updating an existing workspace to use a managed virtual network, you must delete all computing resources for the workspace. This includes compute instance, compute cluster, and managed online endpoints.The following example updates an existing workspace. The--managed-network allow_internet_outboundparameter configures a managed virtual network for the workspace:az ml workspace update --name ws --resource-group rg --managed-network allow_internet_outboundTo update an existing workspace using the YAML file, use the--fileparameter and specify the YAML file that contains the configuration settings:az ml workspace update --file workspace.yaml --name ws --resource-group MyGroupThe following YAML example defines a managed virtual network for the workspace. It also demonstrates how to add a private endpoint connection to a resource used by the workspace; in this example, a private endpoint for a blob store:name: myworkspace
managed_network:
  isolation_mode: allow_internet_outbound
  outbound_rules:
  - name: added-perule
    destination:
      service_resource_id: /subscriptions/<SUBSCRIPTION_ID>/resourceGroups/<RESOURCE_GROUP>/providers/Microsoft.Storage/storageAccounts/<STORAGE_ACCOUNT_NAME>
      spark_enabled: true
      subresource_target: blob
    type: private_endpoint
Update an existing workspace:
Warning
Before updating an existing workspace to use a managed virtual network, you must delete all computing resources for the workspace. This includes compute instance, compute cluster, and managed online endpoints.
The following example updates an existing workspace. The--managed-network allow_internet_outboundparameter configures a managed virtual network for the workspace:
--managed-network allow_internet_outbound
az ml workspace update --name ws --resource-group rg --managed-network allow_internet_outbound
az ml workspace update --name ws --resource-group rg --managed-network allow_internet_outbound
To update an existing workspace using the YAML file, use the--fileparameter and specify the YAML file that contains the configuration settings:
--file
az ml workspace update --file workspace.yaml --name ws --resource-group MyGroup
az ml workspace update --file workspace.yaml --name ws --resource-group MyGroup
The following YAML example defines a managed virtual network for the workspace. It also demonstrates how to add a private endpoint connection to a resource used by the workspace; in this example, a private endpoint for a blob store:
name: myworkspace
managed_network:
  isolation_mode: allow_internet_outbound
  outbound_rules:
  - name: added-perule
    destination:
      service_resource_id: /subscriptions/<SUBSCRIPTION_ID>/resourceGroups/<RESOURCE_GROUP>/providers/Microsoft.Storage/storageAccounts/<STORAGE_ACCOUNT_NAME>
      spark_enabled: true
      subresource_target: blob
    type: private_endpoint
name: myworkspace
managed_network:
  isolation_mode: allow_internet_outbound
  outbound_rules:
  - name: added-perule
    destination:
      service_resource_id: /subscriptions/<SUBSCRIPTION_ID>/resourceGroups/<RESOURCE_GROUP>/providers/Microsoft.Storage/storageAccounts/<STORAGE_ACCOUNT_NAME>
      spark_enabled: true
      subresource_target: blob
    type: private_endpoint
To configure a managed virtual network that allows internet outbound communications, use theManagedNetworkclass to define a network withIsolationMode.ALLOW_INTERNET_OUTBOUND. You can then use theManagedNetworkobject to create a new workspace or update an existing one. To defineoutbound rulesto Azure services that the workspace relies on, use thePrivateEndpointDestinationclass to define a new private endpoint to the service.
ManagedNetwork
IsolationMode.ALLOW_INTERNET_OUTBOUND
ManagedNetwork
PrivateEndpointDestination
Create a new workspace:The following example creates a new workspace namedmyworkspace, with an outbound rule namedmyrulethat adds a private endpoint for an Azure Blob store:# Basic managed VNet configuration
network = ManagedNetwork(IsolationMode.ALLOW_INTERNET_OUTBOUND)

# Workspace configuration
ws = Workspace(
    name="myworkspace",
    location="eastus",
    managed_network=network
)

# Example private endpoint outbound to a blob
rule_name = "myrule"
service_resource_id = "/subscriptions/<SUBSCRIPTION_ID>/resourceGroups/<RESOURCE_GROUP>/providers/Microsoft.Storage/storageAccounts/<STORAGE_ACCOUNT_NAME>"
subresource_target = "blob"
spark_enabled = True

# Add the outbound 
ws.managed_network.outbound_rules = [PrivateEndpointDestination(
    name=rule_name, 
    service_resource_id=service_resource_id, 
    subresource_target=subresource_target, 
    spark_enabled=spark_enabled)]

# Create the workspace
ws = ml_client.workspaces.begin_create(ws).result()
Create a new workspace:
The following example creates a new workspace namedmyworkspace, with an outbound rule namedmyrulethat adds a private endpoint for an Azure Blob store:
myworkspace
myrule
# Basic managed VNet configuration
network = ManagedNetwork(IsolationMode.ALLOW_INTERNET_OUTBOUND)

# Workspace configuration
ws = Workspace(
    name="myworkspace",
    location="eastus",
    managed_network=network
)

# Example private endpoint outbound to a blob
rule_name = "myrule"
service_resource_id = "/subscriptions/<SUBSCRIPTION_ID>/resourceGroups/<RESOURCE_GROUP>/providers/Microsoft.Storage/storageAccounts/<STORAGE_ACCOUNT_NAME>"
subresource_target = "blob"
spark_enabled = True

# Add the outbound 
ws.managed_network.outbound_rules = [PrivateEndpointDestination(
    name=rule_name, 
    service_resource_id=service_resource_id, 
    subresource_target=subresource_target, 
    spark_enabled=spark_enabled)]

# Create the workspace
ws = ml_client.workspaces.begin_create(ws).result()
# Basic managed VNet configuration
network = ManagedNetwork(IsolationMode.ALLOW_INTERNET_OUTBOUND)

# Workspace configuration
ws = Workspace(
    name="myworkspace",
    location="eastus",
    managed_network=network
)

# Example private endpoint outbound to a blob
rule_name = "myrule"
service_resource_id = "/subscriptions/<SUBSCRIPTION_ID>/resourceGroups/<RESOURCE_GROUP>/providers/Microsoft.Storage/storageAccounts/<STORAGE_ACCOUNT_NAME>"
subresource_target = "blob"
spark_enabled = True

# Add the outbound 
ws.managed_network.outbound_rules = [PrivateEndpointDestination(
    name=rule_name, 
    service_resource_id=service_resource_id, 
    subresource_target=subresource_target, 
    spark_enabled=spark_enabled)]

# Create the workspace
ws = ml_client.workspaces.begin_create(ws).result()
Update an existing workspace:WarningBefore updating an existing workspace to use a managed virtual network, you must delete all computing resources for the workspace. This includes compute instance, compute cluster, and managed online endpoints.The following example demonstrates how to create a managed virtual network for an existing Azure Machine Learning workspace namedmyworkspace:# Get the existing workspace
ml_client = MLClient(DefaultAzureCredential(), subscription_id=subscription_id, resource_group_name=resource_group, workspace_name="myworkspace")
ws = ml_client.workspaces.get()

# Basic managed VNet configuration
ws.managed_network = ManagedNetwork(IsolationMode.ALLOW_INTERNET_OUTBOUND)

# Example private endpoint outbound to a blob
rule_name = "myrule"
service_resource_id = "/subscriptions/<SUBSCRIPTION_ID>/resourceGroups/<RESOURCE_GROUP>/providers/Microsoft.Storage/storageAccounts/<STORAGE_ACCOUNT_NAME>"
subresource_target = "blob"
spark_enabled = True

# Add the outbound 
ws.managed_network.outbound_rules = [PrivateEndpointDestination(
    name=rule_name, 
    service_resource_id=service_resource_id, 
    subresource_target=subresource_target, 
    spark_enabled=spark_enabled)]

# Create the workspace
ml_client.workspaces.begin_update(ws)
Update an existing workspace:
Warning
Before updating an existing workspace to use a managed virtual network, you must delete all computing resources for the workspace. This includes compute instance, compute cluster, and managed online endpoints.
The following example demonstrates how to create a managed virtual network for an existing Azure Machine Learning workspace namedmyworkspace:
myworkspace
# Get the existing workspace
ml_client = MLClient(DefaultAzureCredential(), subscription_id=subscription_id, resource_group_name=resource_group, workspace_name="myworkspace")
ws = ml_client.workspaces.get()

# Basic managed VNet configuration
ws.managed_network = ManagedNetwork(IsolationMode.ALLOW_INTERNET_OUTBOUND)

# Example private endpoint outbound to a blob
rule_name = "myrule"
service_resource_id = "/subscriptions/<SUBSCRIPTION_ID>/resourceGroups/<RESOURCE_GROUP>/providers/Microsoft.Storage/storageAccounts/<STORAGE_ACCOUNT_NAME>"
subresource_target = "blob"
spark_enabled = True

# Add the outbound 
ws.managed_network.outbound_rules = [PrivateEndpointDestination(
    name=rule_name, 
    service_resource_id=service_resource_id, 
    subresource_target=subresource_target, 
    spark_enabled=spark_enabled)]

# Create the workspace
ml_client.workspaces.begin_update(ws)
# Get the existing workspace
ml_client = MLClient(DefaultAzureCredential(), subscription_id=subscription_id, resource_group_name=resource_group, workspace_name="myworkspace")
ws = ml_client.workspaces.get()

# Basic managed VNet configuration
ws.managed_network = ManagedNetwork(IsolationMode.ALLOW_INTERNET_OUTBOUND)

# Example private endpoint outbound to a blob
rule_name = "myrule"
service_resource_id = "/subscriptions/<SUBSCRIPTION_ID>/resourceGroups/<RESOURCE_GROUP>/providers/Microsoft.Storage/storageAccounts/<STORAGE_ACCOUNT_NAME>"
subresource_target = "blob"
spark_enabled = True

# Add the outbound 
ws.managed_network.outbound_rules = [PrivateEndpointDestination(
    name=rule_name, 
    service_resource_id=service_resource_id, 
    subresource_target=subresource_target, 
    spark_enabled=spark_enabled)]

# Create the workspace
ml_client.workspaces.begin_update(ws)
Create a new workspace:Sign in to theAzure portal, and choose Azure Machine Learning from Create a resource menu.Provide the required information on theBasicstab.From theNetworkingtab, selectPrivate with Internet Outbound.To add anoutbound rule, selectAdd user-defined outbound rulesfrom theNetworkingtab. From theWorkspace outbound rulessidebar, provide the following information:Rule name: A name for the rule. The name must be unique for this workspace.Destination type: Private Endpoint is the only option when the network isolation is private with internet outbound. Azure Machine Learning managed virtual network doesn't support creating a private endpoint to all Azure resource types. For a list of supported resources, see thePrivate endpointssection.Subscription: The subscription that contains the Azure resource you want to add a private endpoint for.Resource group: The resource group that contains the Azure resource you want to add a private endpoint for.Resource type: The type of the Azure resource.Resource name: The name of the Azure resource.Sub Resource: The sub resource of the Azure resource type.Spark enabled: Select this option if you want to enable serverless Spark jobs for the workspace. This option is only available if the resource type is Azure Storage.SelectSaveto save the rule. You can continue usingAdd user-defined outbound rulesto add rules.Continue creating the workspace as normal.
Create a new workspace:
Sign in to theAzure portal, and choose Azure Machine Learning from Create a resource menu.
Sign in to theAzure portal, and choose Azure Machine Learning from Create a resource menu.
Provide the required information on theBasicstab.
Provide the required information on theBasicstab.
From theNetworkingtab, selectPrivate with Internet Outbound.
From theNetworkingtab, selectPrivate with Internet Outbound.

To add anoutbound rule, selectAdd user-defined outbound rulesfrom theNetworkingtab. From theWorkspace outbound rulessidebar, provide the following information:Rule name: A name for the rule. The name must be unique for this workspace.Destination type: Private Endpoint is the only option when the network isolation is private with internet outbound. Azure Machine Learning managed virtual network doesn't support creating a private endpoint to all Azure resource types. For a list of supported resources, see thePrivate endpointssection.Subscription: The subscription that contains the Azure resource you want to add a private endpoint for.Resource group: The resource group that contains the Azure resource you want to add a private endpoint for.Resource type: The type of the Azure resource.Resource name: The name of the Azure resource.Sub Resource: The sub resource of the Azure resource type.Spark enabled: Select this option if you want to enable serverless Spark jobs for the workspace. This option is only available if the resource type is Azure Storage.SelectSaveto save the rule. You can continue usingAdd user-defined outbound rulesto add rules.
To add anoutbound rule, selectAdd user-defined outbound rulesfrom theNetworkingtab. From theWorkspace outbound rulessidebar, provide the following information:
Rule name: A name for the rule. The name must be unique for this workspace.
Destination type: Private Endpoint is the only option when the network isolation is private with internet outbound. Azure Machine Learning managed virtual network doesn't support creating a private endpoint to all Azure resource types. For a list of supported resources, see thePrivate endpointssection.
Subscription: The subscription that contains the Azure resource you want to add a private endpoint for.
Resource group: The resource group that contains the Azure resource you want to add a private endpoint for.
Resource type: The type of the Azure resource.
Resource name: The name of the Azure resource.
Sub Resource: The sub resource of the Azure resource type.
Spark enabled: Select this option if you want to enable serverless Spark jobs for the workspace. This option is only available if the resource type is Azure Storage.

SelectSaveto save the rule. You can continue usingAdd user-defined outbound rulesto add rules.
Continue creating the workspace as normal.
Continue creating the workspace as normal.
Update an existing workspace:WarningBefore updating an existing workspace to use a managed virtual network, you must delete all computing resources for the workspace. This includes compute instance, compute cluster, and managed online endpoints.Sign in to theAzure portal, and select the Azure Machine Learning workspace that you want to enable managed virtual network isolation for.SelectNetworking,Workspace managed outbound access, and thenAllow Internet Outbound.Toaddanoutbound rule, selectAdd user-defined outbound rules. From theWorkspace outbound rulessidebar, provide the same information as used when creating a workspace in the 'Create a new workspace' section.Todeletean outbound rule, selectdeletefor the rule.SelectSaveat the top of the page to save the changes to the managed virtual network.
Update an existing workspace:
Warning
Before updating an existing workspace to use a managed virtual network, you must delete all computing resources for the workspace. This includes compute instance, compute cluster, and managed online endpoints.
Sign in to theAzure portal, and select the Azure Machine Learning workspace that you want to enable managed virtual network isolation for.
Sign in to theAzure portal, and select the Azure Machine Learning workspace that you want to enable managed virtual network isolation for.
SelectNetworking,Workspace managed outbound access, and thenAllow Internet Outbound.Toaddanoutbound rule, selectAdd user-defined outbound rules. From theWorkspace outbound rulessidebar, provide the same information as used when creating a workspace in the 'Create a new workspace' section.Todeletean outbound rule, selectdeletefor the rule.
SelectNetworking,Workspace managed outbound access, and thenAllow Internet Outbound.

Toaddanoutbound rule, selectAdd user-defined outbound rules. From theWorkspace outbound rulessidebar, provide the same information as used when creating a workspace in the 'Create a new workspace' section.
Toaddanoutbound rule, selectAdd user-defined outbound rules. From theWorkspace outbound rulessidebar, provide the same information as used when creating a workspace in the 'Create a new workspace' section.

Todeletean outbound rule, selectdeletefor the rule.
Todeletean outbound rule, selectdeletefor the rule.

SelectSaveat the top of the page to save the changes to the managed virtual network.
SelectSaveat the top of the page to save the changes to the managed virtual network.
Configure a managed virtual network to allow only approved outbound
Tip
The managed VNet is automatically provisioned when you create a compute resource. When you allow automatic creation, it can take around30 minutesto create the first compute resource as it is also provisioning the network. If you configured FQDN outbound rules, the first FQDN rule adds around10 minutesto the provisioning time. For more information, seeManually provision the network.
Important
If you plan to submit serverless Spark jobs, you must manually start provisioning. For more information, see theconfigure for serverless Spark jobssection.
Azure CLI
Python SDK
Azure portal
To configure a managed virtual network that allows only approved outbound communications, you can use either the--managed-network allow_only_approved_outboundparameter or a YAML configuration file that contains the following entries:
--managed-network allow_only_approved_outbound
managed_network:
  isolation_mode: allow_only_approved_outbound
managed_network:
  isolation_mode: allow_only_approved_outbound
You can also defineoutbound rulesto define approved outbound communication. An outbound rule can be created for a type ofservice_tag,fqdn, andprivate_endpoint. The following rule demonstrates adding a private endpoint to an Azure Blob resource, a service tag to Azure Data Factory, and an FQDN topypi.org:
service_tag
fqdn
private_endpoint
pypi.org
Important
Adding an outbound for a service tag or FQDN is only valid when the managed VNet is configured toallow_only_approved_outbound.
allow_only_approved_outbound
If you add outbound rules, Microsoft can't guarantee data exfiltration.
Warning
FQDN outbound rules are implemented using Azure Firewall. If you use outbound FQDN rules, charges for Azure Firewall are added to your billing. For more information, seePricing.
managed_network:
  isolation_mode: allow_only_approved_outbound
  outbound_rules:
  - name: added-servicetagrule
    destination:
      port_ranges: 80, 8080
      protocol: TCP
      service_tag: DataFactory
    type: service_tag
  - name: add-fqdnrule
    destination: 'pypi.org'
    type: fqdn
  - name: added-perule
    destination:
      service_resource_id: /subscriptions/<SUBSCRIPTION_ID>/resourceGroups/<RESOURCE_GROUP>/providers/Microsoft.Storage/storageAccounts/<STORAGE_ACCOUNT_NAME>
      spark_enabled: true
      subresource_target: blob
    type: private_endpoint
managed_network:
  isolation_mode: allow_only_approved_outbound
  outbound_rules:
  - name: added-servicetagrule
    destination:
      port_ranges: 80, 8080
      protocol: TCP
      service_tag: DataFactory
    type: service_tag
  - name: add-fqdnrule
    destination: 'pypi.org'
    type: fqdn
  - name: added-perule
    destination:
      service_resource_id: /subscriptions/<SUBSCRIPTION_ID>/resourceGroups/<RESOURCE_GROUP>/providers/Microsoft.Storage/storageAccounts/<STORAGE_ACCOUNT_NAME>
      spark_enabled: true
      subresource_target: blob
    type: private_endpoint
You can configure a managed virtual network using either theaz ml workspace createoraz ml workspace updatecommands:
az ml workspace create
az ml workspace update
Create a new workspace:The following example uses the--managed-network allow_only_approved_outboundparameter to configure the managed virtual network:az ml workspace create --name ws --resource-group rg --managed-network allow_only_approved_outboundThe following YAML file defines a workspace with a managed virtual network:name: myworkspace
location: EastUS
managed_network:
  isolation_mode: allow_only_approved_outboundTo create a workspace using the YAML file, use the--fileparameter:az ml workspace create --file workspace.yaml --resource-group rg --name ws
Create a new workspace:
The following example uses the--managed-network allow_only_approved_outboundparameter to configure the managed virtual network:
--managed-network allow_only_approved_outbound
az ml workspace create --name ws --resource-group rg --managed-network allow_only_approved_outbound
az ml workspace create --name ws --resource-group rg --managed-network allow_only_approved_outbound
The following YAML file defines a workspace with a managed virtual network:
name: myworkspace
location: EastUS
managed_network:
  isolation_mode: allow_only_approved_outbound
name: myworkspace
location: EastUS
managed_network:
  isolation_mode: allow_only_approved_outbound
To create a workspace using the YAML file, use the--fileparameter:
--file
az ml workspace create --file workspace.yaml --resource-group rg --name ws
az ml workspace create --file workspace.yaml --resource-group rg --name ws
Update an existing workspaceWarningBefore updating an existing workspace to use a managed virtual network, you must delete all computing resources for the workspace. This includes compute instance, compute cluster, and managed online endpoints.The following example uses the--managed-network allow_only_approved_outboundparameter to configure the managed virtual network for an existing workspace:az ml workspace update --name ws --resource-group rg --managed-network allow_only_approved_outboundThe following YAML file defines a managed virtual network for the workspace. It also demonstrates how to add an approved outbound to the managed virtual network. In this example, an outbound rule is added for both a service tag:WarningFQDN outbound rules are implemented using Azure Firewall. If you use outbound FQDN rules, charges for Azure Firewall are added to your billing. For more information, seePricing.name: myworkspace_dep
managed_network:
  isolation_mode: allow_only_approved_outbound
  outbound_rules:
  - name: added-servicetagrule
    destination:
      port_ranges: 80, 8080
      protocol: TCP
      service_tag: DataFactory
    type: service_tag
  - name: add-fqdnrule
    destination: 'pypi.org'
    type: fqdn
  - name: added-perule
    destination:
      service_resource_id: /subscriptions/<SUBSCRIPTION_ID>/resourceGroups/<RESOURCE_GROUP>/providers/Microsoft.Storage/storageAccounts/<STORAGE_ACCOUNT_NAME>
      spark_enabled: true
      subresource_target: blob
    type: private_endpoint
Update an existing workspace
Warning
Before updating an existing workspace to use a managed virtual network, you must delete all computing resources for the workspace. This includes compute instance, compute cluster, and managed online endpoints.
The following example uses the--managed-network allow_only_approved_outboundparameter to configure the managed virtual network for an existing workspace:
--managed-network allow_only_approved_outbound
az ml workspace update --name ws --resource-group rg --managed-network allow_only_approved_outbound
az ml workspace update --name ws --resource-group rg --managed-network allow_only_approved_outbound
The following YAML file defines a managed virtual network for the workspace. It also demonstrates how to add an approved outbound to the managed virtual network. In this example, an outbound rule is added for both a service tag:
Warning
FQDN outbound rules are implemented using Azure Firewall. If you use outbound FQDN rules, charges for Azure Firewall are added to your billing. For more information, seePricing.
name: myworkspace_dep
managed_network:
  isolation_mode: allow_only_approved_outbound
  outbound_rules:
  - name: added-servicetagrule
    destination:
      port_ranges: 80, 8080
      protocol: TCP
      service_tag: DataFactory
    type: service_tag
  - name: add-fqdnrule
    destination: 'pypi.org'
    type: fqdn
  - name: added-perule
    destination:
      service_resource_id: /subscriptions/<SUBSCRIPTION_ID>/resourceGroups/<RESOURCE_GROUP>/providers/Microsoft.Storage/storageAccounts/<STORAGE_ACCOUNT_NAME>
      spark_enabled: true
      subresource_target: blob
    type: private_endpoint
name: myworkspace_dep
managed_network:
  isolation_mode: allow_only_approved_outbound
  outbound_rules:
  - name: added-servicetagrule
    destination:
      port_ranges: 80, 8080
      protocol: TCP
      service_tag: DataFactory
    type: service_tag
  - name: add-fqdnrule
    destination: 'pypi.org'
    type: fqdn
  - name: added-perule
    destination:
      service_resource_id: /subscriptions/<SUBSCRIPTION_ID>/resourceGroups/<RESOURCE_GROUP>/providers/Microsoft.Storage/storageAccounts/<STORAGE_ACCOUNT_NAME>
      spark_enabled: true
      subresource_target: blob
    type: private_endpoint
To configure a managed virtual network that allows only approved outbound communications, use theManagedNetworkclass to define a network withIsolationMode.ALLOw_ONLY_APPROVED_OUTBOUND. You can then use theManagedNetworkobject to create a new workspace or update an existing one. To defineoutbound rules, use the following classes:
ManagedNetwork
IsolationMode.ALLOw_ONLY_APPROVED_OUTBOUND
ManagedNetwork
PrivateEndpointDestination
ServiceTagDestination
FqdnDestination
Create a new workspace:The following example creates a new workspace namedmyworkspace, with several outbound rules:myrule- Adds a private endpoint for an Azure Blob store.datafactory- Adds a service tag rule to communicate with Azure Data Factory.ImportantAdding an outbound for a service tag or FQDN is only valid when the managed VNet is configured toIsolationMode.ALLOW_ONLY_APPROVED_OUTBOUND.If you add outbound rules, Microsoft can't guarantee data exfiltration.WarningFQDN outbound rules are implemented using Azure Firewall. If you use outbound FQDN rules, charges for Azure Firewall are added to your billing. For more information, seePricing.# Basic managed VNet configuration
network = ManagedNetwork(IsolationMode.ALLOW_ONLY_APPROVED_OUTBOUND)

# Workspace configuration
ws = Workspace(
    name="myworkspace",
    location="eastus",
    managed_network=network
)

# Append some rules
ws.managed_network.outbound_rules = []
# Example private endpoint outbound to a blob
rule_name = "myrule"
service_resource_id = "/subscriptions/<SUBSCRIPTION_ID>/resourceGroups/<RESOURCE_GROUP>/providers/Microsoft.Storage/storageAccounts/<STORAGE_ACCOUNT_NAME>"
subresource_target = "blob"
spark_enabled = True
ws.managed_network.outbound_rules.append(
    PrivateEndpointDestination(
        name=rule_name, 
        service_resource_id=service_resource_id, 
        subresource_target=subresource_target, 
        spark_enabled=spark_enabled
    )
)

# Example service tag rule
rule_name = "datafactory"
service_tag = "DataFactory"
protocol = "TCP"
port_ranges = "80, 8080-8089"
ws.managed_network.outbound_rules.append(
    ServiceTagDestination(
        name=rule_name, 
        service_tag=service_tag, 
        protocol=protocol, 
        port_ranges=port_ranges
    )
)

# Example FQDN rule
ws.managed_network.outbound_rules.append(
    FqdnDestination(
        name="fqdnrule", 
        destination="pypi.org"
    )
)

# Create the workspace
ws = ml_client.workspaces.begin_create(ws).result()
Create a new workspace:
The following example creates a new workspace namedmyworkspace, with several outbound rules:
myworkspace
myrule- Adds a private endpoint for an Azure Blob store.
myrule
datafactory- Adds a service tag rule to communicate with Azure Data Factory.
datafactory
Important
Adding an outbound for a service tag or FQDN is only valid when the managed VNet is configured toIsolationMode.ALLOW_ONLY_APPROVED_OUTBOUND.
IsolationMode.ALLOW_ONLY_APPROVED_OUTBOUND
If you add outbound rules, Microsoft can't guarantee data exfiltration.
Warning
FQDN outbound rules are implemented using Azure Firewall. If you use outbound FQDN rules, charges for Azure Firewall are added to your billing. For more information, seePricing.
# Basic managed VNet configuration
network = ManagedNetwork(IsolationMode.ALLOW_ONLY_APPROVED_OUTBOUND)

# Workspace configuration
ws = Workspace(
    name="myworkspace",
    location="eastus",
    managed_network=network
)

# Append some rules
ws.managed_network.outbound_rules = []
# Example private endpoint outbound to a blob
rule_name = "myrule"
service_resource_id = "/subscriptions/<SUBSCRIPTION_ID>/resourceGroups/<RESOURCE_GROUP>/providers/Microsoft.Storage/storageAccounts/<STORAGE_ACCOUNT_NAME>"
subresource_target = "blob"
spark_enabled = True
ws.managed_network.outbound_rules.append(
    PrivateEndpointDestination(
        name=rule_name, 
        service_resource_id=service_resource_id, 
        subresource_target=subresource_target, 
        spark_enabled=spark_enabled
    )
)

# Example service tag rule
rule_name = "datafactory"
service_tag = "DataFactory"
protocol = "TCP"
port_ranges = "80, 8080-8089"
ws.managed_network.outbound_rules.append(
    ServiceTagDestination(
        name=rule_name, 
        service_tag=service_tag, 
        protocol=protocol, 
        port_ranges=port_ranges
    )
)

# Example FQDN rule
ws.managed_network.outbound_rules.append(
    FqdnDestination(
        name="fqdnrule", 
        destination="pypi.org"
    )
)

# Create the workspace
ws = ml_client.workspaces.begin_create(ws).result()
# Basic managed VNet configuration
network = ManagedNetwork(IsolationMode.ALLOW_ONLY_APPROVED_OUTBOUND)

# Workspace configuration
ws = Workspace(
    name="myworkspace",
    location="eastus",
    managed_network=network
)

# Append some rules
ws.managed_network.outbound_rules = []
# Example private endpoint outbound to a blob
rule_name = "myrule"
service_resource_id = "/subscriptions/<SUBSCRIPTION_ID>/resourceGroups/<RESOURCE_GROUP>/providers/Microsoft.Storage/storageAccounts/<STORAGE_ACCOUNT_NAME>"
subresource_target = "blob"
spark_enabled = True
ws.managed_network.outbound_rules.append(
    PrivateEndpointDestination(
        name=rule_name, 
        service_resource_id=service_resource_id, 
        subresource_target=subresource_target, 
        spark_enabled=spark_enabled
    )
)

# Example service tag rule
rule_name = "datafactory"
service_tag = "DataFactory"
protocol = "TCP"
port_ranges = "80, 8080-8089"
ws.managed_network.outbound_rules.append(
    ServiceTagDestination(
        name=rule_name, 
        service_tag=service_tag, 
        protocol=protocol, 
        port_ranges=port_ranges
    )
)

# Example FQDN rule
ws.managed_network.outbound_rules.append(
    FqdnDestination(
        name="fqdnrule", 
        destination="pypi.org"
    )
)

# Create the workspace
ws = ml_client.workspaces.begin_create(ws).result()
Update an existing workspace:WarningBefore updating an existing workspace to use a managed virtual network, you must delete all computing resources for the workspace. This includes compute instance, compute cluster, and managed online endpoints.The following example demonstrates how to create a managed virtual network for an existing Azure Machine Learning workspace namedmyworkspace. The example also adds several outbound rules for the managed virtual network:myrule- Adds a private endpoint for an Azure Blob store.datafactory- Adds a service tag rule to communicate with Azure Data Factory.TipAdding an outbound for a service tag or FQDN is only valid when the managed VNet is configured toIsolationMode.ALLOW_ONLY_APPROVED_OUTBOUND.WarningFQDN outbound rules are implemented using Azure Firewall. If you use outbound FQDN rules, charges for Azure Firewall are added to your billing. For more information, seePricing.# Get the existing workspace
ml_client = MLClient(DefaultAzureCredential(), subscription_id=subscription_id, resource_group_name=resource_group, workspace_name="myworkspace")
ws = ml_client.workspaces.get()

# Basic managed VNet configuration
ws.managed_network = ManagedNetwork(IsolationMode.ALLOW_ONLY_APPROVED_OUTBOUND)

# Append some rules
ws.managed_network.outbound_rules = []
# Example private endpoint outbound to a blob
rule_name = "myrule"
service_resource_id = "/subscriptions/<SUBSCRIPTION_ID>/resourceGroups/<RESOURCE_GROUP>/providers/Microsoft.Storage/storageAccounts/<STORAGE_ACCOUNT_NAME>"
subresource_target = "blob"
spark_enabled = True
ws.managed_network.outbound_rules.append(
    PrivateEndpointDestination(
        name=rule_name, 
        service_resource_id=service_resource_id, 
        subresource_target=subresource_target, 
        spark_enabled=spark_enabled
    )
)

# Example service tag rule
rule_name = "datafactory"
service_tag = "DataFactory"
protocol = "TCP"
port_ranges = "80, 8080-8089"
ws.managed_network.outbound_rules.append(
    ServiceTagDestination(
        name=rule_name, 
        service_tag=service_tag, 
        protocol=protocol, 
        port_ranges=port_ranges
    )
)

# Example FQDN rule
ws.managed_network.outbound_rules.append(
    FqdnDestination(
        name="fqdnrule", 
        destination="pypi.org"
    )
)

# Update the workspace
ml_client.workspaces.begin_update(ws)
Update an existing workspace:
Warning
Before updating an existing workspace to use a managed virtual network, you must delete all computing resources for the workspace. This includes compute instance, compute cluster, and managed online endpoints.
The following example demonstrates how to create a managed virtual network for an existing Azure Machine Learning workspace namedmyworkspace. The example also adds several outbound rules for the managed virtual network:
myworkspace
myrule- Adds a private endpoint for an Azure Blob store.
myrule
datafactory- Adds a service tag rule to communicate with Azure Data Factory.
datafactory
Tip
Adding an outbound for a service tag or FQDN is only valid when the managed VNet is configured toIsolationMode.ALLOW_ONLY_APPROVED_OUTBOUND.
IsolationMode.ALLOW_ONLY_APPROVED_OUTBOUND
Warning
FQDN outbound rules are implemented using Azure Firewall. If you use outbound FQDN rules, charges for Azure Firewall are added to your billing. For more information, seePricing.
# Get the existing workspace
ml_client = MLClient(DefaultAzureCredential(), subscription_id=subscription_id, resource_group_name=resource_group, workspace_name="myworkspace")
ws = ml_client.workspaces.get()

# Basic managed VNet configuration
ws.managed_network = ManagedNetwork(IsolationMode.ALLOW_ONLY_APPROVED_OUTBOUND)

# Append some rules
ws.managed_network.outbound_rules = []
# Example private endpoint outbound to a blob
rule_name = "myrule"
service_resource_id = "/subscriptions/<SUBSCRIPTION_ID>/resourceGroups/<RESOURCE_GROUP>/providers/Microsoft.Storage/storageAccounts/<STORAGE_ACCOUNT_NAME>"
subresource_target = "blob"
spark_enabled = True
ws.managed_network.outbound_rules.append(
    PrivateEndpointDestination(
        name=rule_name, 
        service_resource_id=service_resource_id, 
        subresource_target=subresource_target, 
        spark_enabled=spark_enabled
    )
)

# Example service tag rule
rule_name = "datafactory"
service_tag = "DataFactory"
protocol = "TCP"
port_ranges = "80, 8080-8089"
ws.managed_network.outbound_rules.append(
    ServiceTagDestination(
        name=rule_name, 
        service_tag=service_tag, 
        protocol=protocol, 
        port_ranges=port_ranges
    )
)

# Example FQDN rule
ws.managed_network.outbound_rules.append(
    FqdnDestination(
        name="fqdnrule", 
        destination="pypi.org"
    )
)

# Update the workspace
ml_client.workspaces.begin_update(ws)
# Get the existing workspace
ml_client = MLClient(DefaultAzureCredential(), subscription_id=subscription_id, resource_group_name=resource_group, workspace_name="myworkspace")
ws = ml_client.workspaces.get()

# Basic managed VNet configuration
ws.managed_network = ManagedNetwork(IsolationMode.ALLOW_ONLY_APPROVED_OUTBOUND)

# Append some rules
ws.managed_network.outbound_rules = []
# Example private endpoint outbound to a blob
rule_name = "myrule"
service_resource_id = "/subscriptions/<SUBSCRIPTION_ID>/resourceGroups/<RESOURCE_GROUP>/providers/Microsoft.Storage/storageAccounts/<STORAGE_ACCOUNT_NAME>"
subresource_target = "blob"
spark_enabled = True
ws.managed_network.outbound_rules.append(
    PrivateEndpointDestination(
        name=rule_name, 
        service_resource_id=service_resource_id, 
        subresource_target=subresource_target, 
        spark_enabled=spark_enabled
    )
)

# Example service tag rule
rule_name = "datafactory"
service_tag = "DataFactory"
protocol = "TCP"
port_ranges = "80, 8080-8089"
ws.managed_network.outbound_rules.append(
    ServiceTagDestination(
        name=rule_name, 
        service_tag=service_tag, 
        protocol=protocol, 
        port_ranges=port_ranges
    )
)

# Example FQDN rule
ws.managed_network.outbound_rules.append(
    FqdnDestination(
        name="fqdnrule", 
        destination="pypi.org"
    )
)

# Update the workspace
ml_client.workspaces.begin_update(ws)
Create a new workspace:Sign in to theAzure portal, and choose Azure Machine Learning from Create a resource menu.Provide the required information on theBasicstab.From theNetworkingtab, selectPrivate with Approved Outbound.To add anoutbound rule, selectAdd user-defined outbound rulesfrom theNetworkingtab. From theWorkspace outbound rulessidebar, provide the following information:Rule name: A name for the rule. The name must be unique for this workspace.Destination type: Private Endpoint, Service Tag, or FQDN. Service Tag and FQDN are only available when the network isolation is private with approved outbound.If the destination type isPrivate Endpoint, provide the following information:Subscription: The subscription that contains the Azure resource you want to add a private endpoint for.Resource group: The resource group that contains the Azure resource you want to add a private endpoint for.Resource type: The type of the Azure resource.Resource name: The name of the Azure resource.Sub Resource: The sub resource of the Azure resource type.Spark enabled: Select this option if you want to enable serverless Spark jobs for the workspace. This option is only available if the resource type is Azure Storage.TipAzure Machine Learning managed VNet doesn't support creating a private endpoint to all Azure resource types. For a list of supported resources, see thePrivate endpointssection.If the destination type isService Tag, provide the following information:Service tag: The service tag to add to the approved outbound rules.Protocol: The protocol to allow for the service tag.Port ranges: The port ranges to allow for the service tag.If the destination type isFQDN, provide the following information:WarningFQDN outbound rules are implemented using Azure Firewall. If you use outbound FQDN rules, charges for Azure Firewall are added to your billing. For more information, seePricing.FQDN destination: The fully qualified domain name to add to the approved outbound rules.SelectSaveto save the rule. You can continue usingAdd user-defined outbound rulesto add rules.Continue creating the workspace as normal.
Create a new workspace:
Sign in to theAzure portal, and choose Azure Machine Learning from Create a resource menu.
Sign in to theAzure portal, and choose Azure Machine Learning from Create a resource menu.
Provide the required information on theBasicstab.
Provide the required information on theBasicstab.
From theNetworkingtab, selectPrivate with Approved Outbound.
From theNetworkingtab, selectPrivate with Approved Outbound.

To add anoutbound rule, selectAdd user-defined outbound rulesfrom theNetworkingtab. From theWorkspace outbound rulessidebar, provide the following information:Rule name: A name for the rule. The name must be unique for this workspace.Destination type: Private Endpoint, Service Tag, or FQDN. Service Tag and FQDN are only available when the network isolation is private with approved outbound.If the destination type isPrivate Endpoint, provide the following information:Subscription: The subscription that contains the Azure resource you want to add a private endpoint for.Resource group: The resource group that contains the Azure resource you want to add a private endpoint for.Resource type: The type of the Azure resource.Resource name: The name of the Azure resource.Sub Resource: The sub resource of the Azure resource type.Spark enabled: Select this option if you want to enable serverless Spark jobs for the workspace. This option is only available if the resource type is Azure Storage.TipAzure Machine Learning managed VNet doesn't support creating a private endpoint to all Azure resource types. For a list of supported resources, see thePrivate endpointssection.If the destination type isService Tag, provide the following information:Service tag: The service tag to add to the approved outbound rules.Protocol: The protocol to allow for the service tag.Port ranges: The port ranges to allow for the service tag.If the destination type isFQDN, provide the following information:WarningFQDN outbound rules are implemented using Azure Firewall. If you use outbound FQDN rules, charges for Azure Firewall are added to your billing. For more information, seePricing.FQDN destination: The fully qualified domain name to add to the approved outbound rules.SelectSaveto save the rule. You can continue usingAdd user-defined outbound rulesto add rules.
To add anoutbound rule, selectAdd user-defined outbound rulesfrom theNetworkingtab. From theWorkspace outbound rulessidebar, provide the following information:
Rule name: A name for the rule. The name must be unique for this workspace.
Destination type: Private Endpoint, Service Tag, or FQDN. Service Tag and FQDN are only available when the network isolation is private with approved outbound.
If the destination type isPrivate Endpoint, provide the following information:
Subscription: The subscription that contains the Azure resource you want to add a private endpoint for.
Resource group: The resource group that contains the Azure resource you want to add a private endpoint for.
Resource type: The type of the Azure resource.
Resource name: The name of the Azure resource.
Sub Resource: The sub resource of the Azure resource type.
Spark enabled: Select this option if you want to enable serverless Spark jobs for the workspace. This option is only available if the resource type is Azure Storage.
Tip
Azure Machine Learning managed VNet doesn't support creating a private endpoint to all Azure resource types. For a list of supported resources, see thePrivate endpointssection.

If the destination type isService Tag, provide the following information:
Service tag: The service tag to add to the approved outbound rules.
Protocol: The protocol to allow for the service tag.
Port ranges: The port ranges to allow for the service tag.

If the destination type isFQDN, provide the following information:
Warning
FQDN outbound rules are implemented using Azure Firewall. If you use outbound FQDN rules, charges for Azure Firewall are added to your billing. For more information, seePricing.
FQDN destination: The fully qualified domain name to add to the approved outbound rules.

SelectSaveto save the rule. You can continue usingAdd user-defined outbound rulesto add rules.
Continue creating the workspace as normal.
Continue creating the workspace as normal.
Update an existing workspace:WarningBefore updating an existing workspace to use a managed virtual network, you must delete all computing resources for the workspace. This includes compute instance, compute cluster, and managed online endpoints.Sign in to theAzure portal, and select the Azure Machine Learning workspace that you want to enable managed virtual network isolation for.SelectNetworking,Workspace managed outbound access, and then selectPrivate with Approved Outbound.Toaddanoutbound rule, selectAdd user-defined outbound rulesfrom theNetworkingtab. From theWorkspace outbound rulessidebar, provide the same information as when creating a workspace in the previous 'Create a new workspace' section.Todeletean outbound rule, selectdeletefor the rule.SelectSaveat the top of the page to save the changes to the managed virtual network.
Update an existing workspace:
Warning
Before updating an existing workspace to use a managed virtual network, you must delete all computing resources for the workspace. This includes compute instance, compute cluster, and managed online endpoints.
Sign in to theAzure portal, and select the Azure Machine Learning workspace that you want to enable managed virtual network isolation for.
Sign in to theAzure portal, and select the Azure Machine Learning workspace that you want to enable managed virtual network isolation for.
SelectNetworking,Workspace managed outbound access, and then selectPrivate with Approved Outbound.Toaddanoutbound rule, selectAdd user-defined outbound rulesfrom theNetworkingtab. From theWorkspace outbound rulessidebar, provide the same information as when creating a workspace in the previous 'Create a new workspace' section.Todeletean outbound rule, selectdeletefor the rule.
SelectNetworking,Workspace managed outbound access, and then selectPrivate with Approved Outbound.

Toaddanoutbound rule, selectAdd user-defined outbound rulesfrom theNetworkingtab. From theWorkspace outbound rulessidebar, provide the same information as when creating a workspace in the previous 'Create a new workspace' section.
Toaddanoutbound rule, selectAdd user-defined outbound rulesfrom theNetworkingtab. From theWorkspace outbound rulessidebar, provide the same information as when creating a workspace in the previous 'Create a new workspace' section.
Todeletean outbound rule, selectdeletefor the rule.
Todeletean outbound rule, selectdeletefor the rule.

SelectSaveat the top of the page to save the changes to the managed virtual network.
SelectSaveat the top of the page to save the changes to the managed virtual network.
Configure for serverless Spark jobs
Tip
The steps in this section are only needed if you plan to submitserverless Spark jobs. If you aren't going to be submitting serverless Spark jobs, you can skip this section.
To enable theserverless Spark jobsfor the managed virtual network, you must perform the following actions:
Configure a managed virtual network for the workspace and add an outbound private endpoint for the Azure Storage Account.
After you configure the managed virtual network, provision it and flag it to allow Spark jobs.
Configure an outbound private endpoint.Azure CLIPython SDKAzure portalUse a YAML file to define the managed virtual network configuration and add a private endpoint for the Azure Storage Account. Also setspark_enabled: true:TipThis example is for a managed VNet configured usingisolation_mode: allow_internet_outboundto allow internet traffic.  If you want to allow only approved outbound traffic, useisolation_mode: allow_only_approved_outbound.name: myworkspace
managed_network:
  isolation_mode: allow_internet_outbound
  outbound_rules:
  - name: added-perule
    destination:
      service_resource_id: /subscriptions/<SUBSCRIPTION_ID>/resourceGroups/<RESOURCE_GROUP>/providers/Microsoft.Storage/storageAccounts/<STORAGE_ACCOUNT_NAME>
      spark_enabled: true
      subresource_target: blob
    type: private_endpointYou can use a YAML configuration file with theaz ml workspace updatecommand by specifying the--fileparameter and the name of the YAML file. For example, the following command updates an existing workspace using a YAML file namedworkspace_pe.yml:az ml workspace update --file workspace_pe.yml --resource_group rg --name wsNoteWhenAllow Only Approved Outboundis enabled (isolation_mode: allow_only_approved_outbound), conda package dependencies defined in Spark session configuration fails to install. To resolve this problem, upload a self-contained Python package wheel with no external dependencies to an Azure storage account and create private endpoint to this storage account. Use the path to Python package wheel aspy_filesparameter in your Spark job. Setting an FQDN outbound rule won't bypass this issue as FQDN rule propagation isn't supported by Spark.The following example demonstrates how to create a managed virtual network for an existing Azure Machine Learning workspace namedmyworkspace. It also adds a private endpoint for the Azure Storage Account and setsspark_enabled=true:TipThe following example is for a managed VNet configured usingIsolationMode.ALLOW_INTERNET_OUTBOUNDto allow internet traffic. If you want to allow only approved outbound traffic, useIsolationMode.ALLOW_ONLY_APPROVED_OUTBOUND.# Get the existing workspace
ml_client = MLClient(DefaultAzureCredential(), subscription_id, resource_group, "myworkspace")
ws = ml_client.workspaces.get()

# Basic managed VNet configuration
ws.managed_network = ManagedNetwork(IsolationMode.ALLOW_INTERNET_OUTBOUND)

# Example private endpoint outbound to a blob
rule_name = "myrule"
service_resource_id = "/subscriptions/<SUBSCRIPTION_ID>/resourceGroups/<RESOURCE_GROUP>/providers/Microsoft.Storage/storageAccounts/<STORAGE_ACCOUNT_NAME>"
subresource_target = "blob"
spark_enabled = True

# Add the outbound 
ws.managed_network.outbound_rules = [PrivateEndpointDestination(
    name=rule_name, 
    service_resource_id=service_resource_id, 
    subresource_target=subresource_target, 
    spark_enabled=spark_enabled)]

# Create the workspace
ml_client.workspaces.begin_update(ws)NoteWhenAllow Only Approved Outboundis enabled (isolation_mode: allow_only_approved_outbound), conda package dependencies defined in Spark session configuration fails to install. To resolve this problem, upload a self-contained Python package wheel with no external dependencies to an Azure storage account and create private endpoint to this storage account. Use the path to Python package wheel aspy_filesparameter in the Spark job.If the workspace was created withIsolationMode.ALLOW_INTERNET_OUTBOUND, it canât be updated later to useIsolationMode.ALLOW_ONLY_APPROVED_OUTBOUND.Sign in to theAzure portal, and select the Azure Machine Learning workspace.SelectNetworking, then selectAdd user-defined outbound rules. Add a rule for the Azure Storage Account, and make sure thatSpark enabledis selected.SelectSaveto save the rule, then selectSavefrom the top ofNetworkingto save the changes to the manged virtual network.
Configure an outbound private endpoint.
Azure CLI
Python SDK
Azure portal
Use a YAML file to define the managed virtual network configuration and add a private endpoint for the Azure Storage Account. Also setspark_enabled: true:
spark_enabled: true
Tip
This example is for a managed VNet configured usingisolation_mode: allow_internet_outboundto allow internet traffic.  If you want to allow only approved outbound traffic, useisolation_mode: allow_only_approved_outbound.
isolation_mode: allow_internet_outbound
isolation_mode: allow_only_approved_outbound
name: myworkspace
managed_network:
  isolation_mode: allow_internet_outbound
  outbound_rules:
  - name: added-perule
    destination:
      service_resource_id: /subscriptions/<SUBSCRIPTION_ID>/resourceGroups/<RESOURCE_GROUP>/providers/Microsoft.Storage/storageAccounts/<STORAGE_ACCOUNT_NAME>
      spark_enabled: true
      subresource_target: blob
    type: private_endpoint
name: myworkspace
managed_network:
  isolation_mode: allow_internet_outbound
  outbound_rules:
  - name: added-perule
    destination:
      service_resource_id: /subscriptions/<SUBSCRIPTION_ID>/resourceGroups/<RESOURCE_GROUP>/providers/Microsoft.Storage/storageAccounts/<STORAGE_ACCOUNT_NAME>
      spark_enabled: true
      subresource_target: blob
    type: private_endpoint
You can use a YAML configuration file with theaz ml workspace updatecommand by specifying the--fileparameter and the name of the YAML file. For example, the following command updates an existing workspace using a YAML file namedworkspace_pe.yml:
az ml workspace update
--file
workspace_pe.yml
az ml workspace update --file workspace_pe.yml --resource_group rg --name ws
az ml workspace update --file workspace_pe.yml --resource_group rg --name ws
Note
WhenAllow Only Approved Outboundis enabled (isolation_mode: allow_only_approved_outbound), conda package dependencies defined in Spark session configuration fails to install. To resolve this problem, upload a self-contained Python package wheel with no external dependencies to an Azure storage account and create private endpoint to this storage account. Use the path to Python package wheel aspy_filesparameter in your Spark job. Setting an FQDN outbound rule won't bypass this issue as FQDN rule propagation isn't supported by Spark.
isolation_mode: allow_only_approved_outbound
py_files
The following example demonstrates how to create a managed virtual network for an existing Azure Machine Learning workspace namedmyworkspace. It also adds a private endpoint for the Azure Storage Account and setsspark_enabled=true:
myworkspace
spark_enabled=true
Tip
The following example is for a managed VNet configured usingIsolationMode.ALLOW_INTERNET_OUTBOUNDto allow internet traffic. If you want to allow only approved outbound traffic, useIsolationMode.ALLOW_ONLY_APPROVED_OUTBOUND.
IsolationMode.ALLOW_INTERNET_OUTBOUND
IsolationMode.ALLOW_ONLY_APPROVED_OUTBOUND
# Get the existing workspace
ml_client = MLClient(DefaultAzureCredential(), subscription_id, resource_group, "myworkspace")
ws = ml_client.workspaces.get()

# Basic managed VNet configuration
ws.managed_network = ManagedNetwork(IsolationMode.ALLOW_INTERNET_OUTBOUND)

# Example private endpoint outbound to a blob
rule_name = "myrule"
service_resource_id = "/subscriptions/<SUBSCRIPTION_ID>/resourceGroups/<RESOURCE_GROUP>/providers/Microsoft.Storage/storageAccounts/<STORAGE_ACCOUNT_NAME>"
subresource_target = "blob"
spark_enabled = True

# Add the outbound 
ws.managed_network.outbound_rules = [PrivateEndpointDestination(
    name=rule_name, 
    service_resource_id=service_resource_id, 
    subresource_target=subresource_target, 
    spark_enabled=spark_enabled)]

# Create the workspace
ml_client.workspaces.begin_update(ws)
# Get the existing workspace
ml_client = MLClient(DefaultAzureCredential(), subscription_id, resource_group, "myworkspace")
ws = ml_client.workspaces.get()

# Basic managed VNet configuration
ws.managed_network = ManagedNetwork(IsolationMode.ALLOW_INTERNET_OUTBOUND)

# Example private endpoint outbound to a blob
rule_name = "myrule"
service_resource_id = "/subscriptions/<SUBSCRIPTION_ID>/resourceGroups/<RESOURCE_GROUP>/providers/Microsoft.Storage/storageAccounts/<STORAGE_ACCOUNT_NAME>"
subresource_target = "blob"
spark_enabled = True

# Add the outbound 
ws.managed_network.outbound_rules = [PrivateEndpointDestination(
    name=rule_name, 
    service_resource_id=service_resource_id, 
    subresource_target=subresource_target, 
    spark_enabled=spark_enabled)]

# Create the workspace
ml_client.workspaces.begin_update(ws)
Note
WhenAllow Only Approved Outboundis enabled (isolation_mode: allow_only_approved_outbound), conda package dependencies defined in Spark session configuration fails to install. To resolve this problem, upload a self-contained Python package wheel with no external dependencies to an Azure storage account and create private endpoint to this storage account. Use the path to Python package wheel aspy_filesparameter in the Spark job.
isolation_mode: allow_only_approved_outbound
py_files
If the workspace was created withIsolationMode.ALLOW_INTERNET_OUTBOUND, it canât be updated later to useIsolationMode.ALLOW_ONLY_APPROVED_OUTBOUND.
IsolationMode.ALLOW_INTERNET_OUTBOUND
IsolationMode.ALLOW_ONLY_APPROVED_OUTBOUND
Sign in to theAzure portal, and select the Azure Machine Learning workspace.
Sign in to theAzure portal, and select the Azure Machine Learning workspace.
SelectNetworking, then selectAdd user-defined outbound rules. Add a rule for the Azure Storage Account, and make sure thatSpark enabledis selected.
SelectNetworking, then selectAdd user-defined outbound rules. Add a rule for the Azure Storage Account, and make sure thatSpark enabledis selected.

SelectSaveto save the rule, then selectSavefrom the top ofNetworkingto save the changes to the manged virtual network.
SelectSaveto save the rule, then selectSavefrom the top ofNetworkingto save the changes to the manged virtual network.
Provision the managed virtual network.NoteIf your workspace haspublic network access enabled, you must disable it before provisioning the managed VNet. If you don't disable public network access when provisioning the managed VNet, the private endpoints for the workspace might not be created automatically in the managed VNet. Otherwise, you would have to manually configure the private endpoint outbound rule for the workspace after the provisioning.Azure CLIPython SDKAzure portalThe following example shows how to provision a managed virtual network for serverless Spark jobs by using the--include-sparkparameter.az ml workspace provision-network -g my_resource_group -n my_workspace_name --include-sparkThe following example shows how to provision a managed virtual network for serverless Spark jobs:# Connect to a workspace named "myworkspace"
ml_client = MLClient(DefaultAzureCredential(), subscription_id=subscription_id, resource_group_name=resource_group, workspace_name="myworkspace")

# whether to provision Spark vnet as well
include_spark = True

provision_network_result = ml_client.workspaces.begin_provision_network(workspace_name=ws_name, include_spark=include_spark).result()Use theAzure CLIorPython SDKtabs to learn how to manually provision the managed virtual network with serverless Spark support.
Provision the managed virtual network.
Note
If your workspace haspublic network access enabled, you must disable it before provisioning the managed VNet. If you don't disable public network access when provisioning the managed VNet, the private endpoints for the workspace might not be created automatically in the managed VNet. Otherwise, you would have to manually configure the private endpoint outbound rule for the workspace after the provisioning.
Azure CLI
Python SDK
Azure portal
The following example shows how to provision a managed virtual network for serverless Spark jobs by using the--include-sparkparameter.
--include-spark
az ml workspace provision-network -g my_resource_group -n my_workspace_name --include-spark
az ml workspace provision-network -g my_resource_group -n my_workspace_name --include-spark
The following example shows how to provision a managed virtual network for serverless Spark jobs:
# Connect to a workspace named "myworkspace"
ml_client = MLClient(DefaultAzureCredential(), subscription_id=subscription_id, resource_group_name=resource_group, workspace_name="myworkspace")

# whether to provision Spark vnet as well
include_spark = True

provision_network_result = ml_client.workspaces.begin_provision_network(workspace_name=ws_name, include_spark=include_spark).result()
# Connect to a workspace named "myworkspace"
ml_client = MLClient(DefaultAzureCredential(), subscription_id=subscription_id, resource_group_name=resource_group, workspace_name="myworkspace")

# whether to provision Spark vnet as well
include_spark = True

provision_network_result = ml_client.workspaces.begin_provision_network(workspace_name=ws_name, include_spark=include_spark).result()
Use theAzure CLIorPython SDKtabs to learn how to manually provision the managed virtual network with serverless Spark support.
Manually provision a managed VNet
The managed virtual network is automatically provisioned when you create a compute instance. When you rely on automatic provisioning, it can take around30 minutesto create the first compute instance as it is also provisioning the network. If you configured FQDN outbound rules (only available with allow only approved mode), the first FQDN rule adds around10 minutesto the provisioning time. If you have a large set of outbound rules to be provisioned in the managed network, it can take longer for provisioning to complete. The increased provisioning time can cause your first compute instance creation to time out.
To reduce the wait time and avoid potential timeout errors, we recommend manually provisioning the managed network. Then wait until the provisioning completes before you create a compute instance.
Alternatively, you can use theprovision_network_nowflag to provision the managed network as part of workspace creation.
provision_network_now
Note
To create an online deployment, you must manually provision the managed network, or create a compute instance first which will automatically provision it.
Azure CLI
Python SDK
Azure portal
The following example shows how to provision a managed virtual network during workspace creation.
az ml workspace create -n myworkspace -g my_resource_group --managed-network AllowInternetOutbound --provision-network-now
az ml workspace create -n myworkspace -g my_resource_group --managed-network AllowInternetOutbound --provision-network-now
The following example shows how to manually provision a managed virtual network.
Tip
If you plan to submit serverless Spark jobs, add the--include-sparkparameter.
--include-spark
az ml workspace provision-network -g my_resource_group -n my_workspace_name
az ml workspace provision-network -g my_resource_group -n my_workspace_name
To verify that the provisioning completed, use the following command:
az ml workspace show -n my_workspace_name -g my_resource_group --query managed_network
az ml workspace show -n my_workspace_name -g my_resource_group --query managed_network
To provision the managed network during workspace creation, set theprovision_network_nowflag toTrue.
provision_network_now
True
provision_network_now: True
provision_network_now: True
The following example shows how to provision a managed virtual network:
# Connect to a workspace named "myworkspace"
ml_client = MLClient(DefaultAzureCredential(), subscription_id=subscription_id, resource_group_name=resource_group, workspace_name="myworkspace")

# whether to provision Spark vnet as well
include_spark = True

provision_network_result = ml_client.workspaces.begin_provision_network(workspace_name=ws_name, include_spark=include_spark).result()
# Connect to a workspace named "myworkspace"
ml_client = MLClient(DefaultAzureCredential(), subscription_id=subscription_id, resource_group_name=resource_group, workspace_name="myworkspace")

# whether to provision Spark vnet as well
include_spark = True

provision_network_result = ml_client.workspaces.begin_provision_network(workspace_name=ws_name, include_spark=include_spark).result()
To verify that the workspace has been provisioned, useml_client.workspaces.get()to get the workspace information. Themanaged_networkproperty contains the status of the managed network.
ml_client.workspaces.get()
managed_network
ws = ml_client.workspaces.get()
print(ws.managed_network.status)
ws = ml_client.workspaces.get()
print(ws.managed_network.status)
During workspace creation, selectProvision managed network proactively at creationto provision the managed network. Charges are incurred from network resources, such as private endpoints, once the virtual network is provisioned. This configuration option is only available during workspace creation.
Configure image builds
When the Azure Container Registry for your workspace is behind a virtual network, it can't be used to directly build Docker images. Instead, configure your workspace to use a compute cluster or compute instance to build images.
Important
The compute resource used to build Docker images needs to be able to access the package repositories that are used to train and deploy your models. If you're using a network configured to allow only approved outbound, you might need to addrules that allow access to public reposoruse private Python packages.
Azure CLI
Python SDK
Azure portal
To update a workspace to use a compute cluster or compute instance to build Docker images, use theaz ml workspace updatecommand with the--image-build-computeparameter:
az ml workspace update
--image-build-compute
az ml workspace update --name ws --resource-group rg --image-build-compute mycompute
az ml workspace update --name ws --resource-group rg --image-build-compute mycompute
The following example demonstrates how to update a workspace to use a compute cluster to build images:
# import required libraries
from azure.ai.ml import MLClient
from azure.identity import DefaultAzureCredential

subscription_id = "<your subscription ID>"
resource_group = "<your resource group name>"
workspace = "<your workspace name>"

ml_client = MLClient(
    DefaultAzureCredential(), subscription_id=subscription_id, resource_group_name=resource_group, workspace_name=workspace
)

# Get workspace info
ws=ml_client.workspaces.get(name=workspace)
# Update to use cpu-cluster for image builds
ws.image_build_compute="mycompute"
ml_client.workspaces.begin_update(ws)
# To switch back to using ACR to build (if ACR is not in the virtual network):
# ws.image_build_compute = ''
# ml_client.workspaces.begin_update(ws)
# import required libraries
from azure.ai.ml import MLClient
from azure.identity import DefaultAzureCredential

subscription_id = "<your subscription ID>"
resource_group = "<your resource group name>"
workspace = "<your workspace name>"

ml_client = MLClient(
    DefaultAzureCredential(), subscription_id=subscription_id, resource_group_name=resource_group, workspace_name=workspace
)

# Get workspace info
ws=ml_client.workspaces.get(name=workspace)
# Update to use cpu-cluster for image builds
ws.image_build_compute="mycompute"
ml_client.workspaces.begin_update(ws)
# To switch back to using ACR to build (if ACR is not in the virtual network):
# ws.image_build_compute = ''
# ml_client.workspaces.begin_update(ws)
Currently there isn't a way to set the image build compute from the Azure portal. Use theAzure CLIorPython SDKtabs to learn how to manually configure image builds.
Manage outbound rules
Azure CLI
Python SDK
Azure portal
To list the managed virtual network outbound rules for a workspace, use the following command:
az ml workspace outbound-rule list --workspace-name ws --resource-group rg
az ml workspace outbound-rule list --workspace-name ws --resource-group rg
To view the details of a managed virtual network outbound rule, use the following command:
az ml workspace outbound-rule show --rule rule-name --workspace-name ws --resource-group rg
az ml workspace outbound-rule show --rule rule-name --workspace-name ws --resource-group rg
To remove an outbound rule from the managed virtual network, use the following command:
az ml workspace outbound-rule remove --rule rule-name --workspace-name ws --resource-group rg
az ml workspace outbound-rule remove --rule rule-name --workspace-name ws --resource-group rg
The following example demonstrates how to manage outbound rules for a workspace namedmyworkspace:
myworkspace
# Connect to the workspace
ml_client = MLClient(DefaultAzureCredential(), subscription_id=subscription_id, resource_group_name=resource_group, workspace_name="myworkspace")

# Specify the rule name
rule_name = "<some-rule-name>"

# Get a rule by name
rule = ml_client._workspace_outbound_rules.get(resource_group, ws_name, rule_name)

# List rules for a workspace
rule_list = ml_client._workspace_outbound_rules.list(resource_group, ws_name)

# Delete a rule from a workspace
ml_client._workspace_outbound_rules.begin_remove(resource_group, ws_name, rule_name).result()
# Connect to the workspace
ml_client = MLClient(DefaultAzureCredential(), subscription_id=subscription_id, resource_group_name=resource_group, workspace_name="myworkspace")

# Specify the rule name
rule_name = "<some-rule-name>"

# Get a rule by name
rule = ml_client._workspace_outbound_rules.get(resource_group, ws_name, rule_name)

# List rules for a workspace
rule_list = ml_client._workspace_outbound_rules.list(resource_group, ws_name)

# Delete a rule from a workspace
ml_client._workspace_outbound_rules.begin_remove(resource_group, ws_name, rule_name).result()
Sign in to theAzure portal, and select the Azure Machine Learning workspace that you want to enable managed virtual network isolation for.
Sign in to theAzure portal, and select the Azure Machine Learning workspace that you want to enable managed virtual network isolation for.
SelectNetworking. TheWorkspace Outbound accesssection allows you to manage outbound rules.
SelectNetworking. TheWorkspace Outbound accesssection allows you to manage outbound rules.

Toaddanoutbound rule, selectAdd user-defined outbound rulesfrom theNetworkingtab. From theWorkspace outbound rulessidebar, provide the following information:
Toaddanoutbound rule, selectAdd user-defined outbound rulesfrom theNetworkingtab. From theWorkspace outbound rulessidebar, provide the following information:
Toenableordisablea rule, use the toggle in theActivecolumn.
Toenableordisablea rule, use the toggle in theActivecolumn.
Todeletean outbound rule, selectdeletefor the rule.
Todeletean outbound rule, selectdeletefor the rule.
List of required rules
Private endpoints:
When the isolation mode for the managed virtual network isAllow internet outbound, private endpoint outbound rules are automatically created as required rules from the managed virtual network for the workspace and associated resourceswith public network access disabled(Key Vault, Storage Account, Container Registry, Azure Machine Learning workspace).
Allow internet outbound
When the isolation mode for the managed virtual network isAllow only approved outbound, private endpoint outbound rules are automatically created as required rules from the managed virtual network for the workspace and associated resourcesregardless of public network access mode for those resources(Key Vault, Storage Account, Container Registry, Azure Machine Learning workspace).
Allow only approved outbound
These rules are automatically added to the managed virtual network.
For Azure Machine Learning to run normally, there are a set of required service tags, required in either a managed or custom virtual network set-up. There are no alternatives to replacing certain required service tags. The following table describes each required service tag and its purpose within Azure Machine Learning.
AzureMachineLearning
AzureMachineLearning
AzureActiveDirectory
BatchNodeManagement.region
AzureResourceManager
AzureFrontDoor.FirstParty
MicrosoftContainerRegistry
AzureMonitor
VirtualNetwork
Note
Service tags as the ONLY security boundary isn't sufficient. For tenant level isolation, use private endpoints when possible.
List of scenario specific outbound rules
Scenario: Access public machine learning packages
To allow installation ofPython packages for training and deployment, add outboundFQDNrules to allow traffic to the following host names:
Warning
FQDN outbound rules are implemented using Azure Firewall. If you use outbound FQDN rules, charges for Azure Firewall are added to your billing. For more information, seePricing.
Note
The following list doesn't contain all of the hosts required for all Python resources on the internet, only the most commonly used. For example, if you need access to a GitHub repository or other host, you must identify and add the required hosts for that scenario.
anaconda.com
*.anaconda.com
*.anaconda.org
pypi.org
*.pythonhosted.org
pytorch.org
*.pytorch.org
*.tensorflow.org
Scenario: Use Visual Studio Code desktop or web with compute instance
If you plan to useVisual Studio Codewith Azure Machine Learning, add outboundFQDNrules to allow traffic to the following hosts:
Note
This isn't a complete list of the hosts required for all Visual Studio Code resources on the internet, only the most commonly used. For example, if you need access to a GitHub repository or other host, you must identify and add the required hosts for that scenario. For a complete list of host names, seeNetwork Connections in Visual Studio Code.
*.vscode.dev
*.vscode-unpkg.net
*.vscode-cdn.net
*.vscodeexperiments.azureedge.net
default.exp-tas.com
code.visualstudio.com
update.code.visualstudio.com
*.vo.msecnd.net
marketplace.visualstudio.com
vscode.blob.core.windows.net
*.gallerycdn.vsassets.io
vscode.download.prss.microsoft.com
Scenario: Use batch endpoints or ParallelRunStep
If you plan to useAzure Machine Learning batch endpointsfor deployment orParallelRunStep, add outboundprivate endpointrules to allow traffic to the following sub resources for the default storage account:
queue
queue
table
table
Scenario: Use prompt flow with Azure OpenAI, content safety, and Azure AI Search
Private endpoint to Azure AI Services
Private endpoint to Azure AI Search
Scenario: Use HuggingFace models
If you plan to useHuggingFace modelswith Azure Machine Learning, add outboundFQDNrules to allow traffic to the following hosts:
Warning
FQDN outbound rules are implemented using Azure Firewall. If you use outbound FQDN rules, charges for Azure Firewall are added to your billing. For more information, seePricing.
docker.io
docker.io
*.docker.io
*.docker.io
*.docker.com
*.docker.com
production.cloudflare.docker.com
production.cloudflare.docker.com
cdn.auth0.com
cdn.auth0.com
cdn-lfs.huggingface.co
cdn-lfs.huggingface.co
Scenario: Enable access from selected IP Addresses
If you want to enable access from specific IP addresses, use the following actions:
Add an outboundprivate endpointrule to allow traffic to the Azure Machine Learning workspace. This rule allows compute instances created in the managed virtual network to access the workspace.TipYou can't add this rule during workspace creation, as the workspace doesn't exist yet.
Add an outboundprivate endpointrule to allow traffic to the Azure Machine Learning workspace. This rule allows compute instances created in the managed virtual network to access the workspace.
Tip
You can't add this rule during workspace creation, as the workspace doesn't exist yet.
Enable public network access to the workspace. For more information, seepublic network access enabled.
Enable public network access to the workspace. For more information, seepublic network access enabled.
Add your IP addresses to the firewall for Azure Machine Learning. For more information, seeenable access only from IP ranges.NoteOnly IPv4 addresses are supported.
Add your IP addresses to the firewall for Azure Machine Learning. For more information, seeenable access only from IP ranges.
Note
Only IPv4 addresses are supported.
For more information, seeConfigure private link.
Private endpoints
Private endpoints are currently supported for the following Azure services:
Azure Machine Learning
Azure Machine Learning registries
Azure Storage (all sub resource types)
Azure Container Registry
Azure Key Vault
Azure AI services
Azure AI Search (formerly Cognitive Search)
Azure SQL Server
Azure Data Factory
Azure Cosmos DB (all sub resource types)
Azure Event Hubs
Azure Redis Cache
Azure Databricks
Azure Database for MariaDB
Azure Database for PostgreSQL Single Server
Azure Database for PostgreSQL Flexible Server
Azure Database for MySQL
Azure API Management
When you create a private endpoint, you provide theresource typeandsubresourcethat the endpoint connects to. Some resources have multiple types and subresources. For more information, seewhat is a private endpoint.
When you create a private endpoint for Azure Machine Learning dependency resources, such as Azure Storage, Azure Container Registry, and Azure Key Vault, the resource can be in a different Azure subscription. However, the resource must be in the same tenant as the Azure Machine Learning workspace.
When configuring private endpoints for the workspace, they are only created when the firstcompute is createdor when managed virtual network provisioning is forced. For more information on forcing the managed virtual network provisioning, seeManually provision the network.
Approval of private endpoints
To establish Private Endpoint connections in managed virtual networks using Azure Machine Learning, the workspace managed identity, whether system-assigned or user-assigned, must have permissions to approve the Private Endpoint connections on the target resources. Previously, this was done through automatic role assignments by the Azure Machine Learning service. However, there are security concerns about the automatic role assignment. To improve security, starting April 30th, 2025, we will discontinue this automatic permission grant logic. We recommend assigning the Azure AI Enterprise Network Connection Approver role or a custom role with the necessary Private Endpoint connection permissions on the target resource types and grant this role to the Azure Machine Learning workspace's managed identity to allow Azure Machine Learning services to approve Private Endpoint connections to the target Azure resources.
Here's the list of private endpoint target resource types covered by covered by  the Azure AI Enterprise Network Connection Approver role:
Azure Application Gateway
Azure Monitor
Azure AI Search
Event Hubs
Azure SQL Database
Azure Storage
Azure Machine Learning workspace
Azure Machine Learning registry
Azure AI Foundry
Azure Key Vault
Azure CosmosDB
Azure Database for MySQL
Azure Database for PostgreSQL
Azure AI Services
Azure Cache for Redis
Container Registry
API Management
For creating Private Endpoint outbound rules to target resource types not covered by the Azure AI Enterprise Network Connection Approver role, such as Azure Data Factory, Azure Databricks, and Azure Function Apps, a custom scoped-down role is recommended, defined only by the actions necessary to approve private endpoint connections on the target resource types.
For creating Private Endpoint outbound rules to default workspace resources, the required permissions are automatically covered by the role assignments granted during workspace creation, so no additional action is needed.
Select an Azure Firewall version for allowed only approved outbound
An Azure Firewall is deployed if an FQDN outbound rule is created while in theallow only approved outboundmode. Charges for the Azure Firewall are included in your billing. By default, aStandardversion of AzureFirewall is created. Optionally, you can select to use aBasicversion. You can change the firewall version used as needed. To figure out which version is best for you, visitChoose the right Azure Firewall version.
Important
The firewall isn't created until you add an outbound FQDN rule. For more information on pricing, seeAzure Firewall pricingand view prices for thestandardversion.
Use the following tabs to learn how to select the firewall version for your managed virtual network.
Azure portal
Azure CLI
Python SDK
After selecting the allow only approved outbound mode, an option to select the Azure Firewall version (SKU) appears. SelectStandardto use the standard version orBasicto use the basic version. SelectSaveto save your configuration.
To configure the firewall version from the CLI, use a YAML file and specify thefirewall_sku. The following example demonstrates a YAML file that sets the firewall SKU tobasic:
firewall_sku
basic
name: test-ws
resource_group: test-rg
location: eastus2 
managed_network:
  isolation_mode: allow_only_approved_outbound
  outbound_rules:
  - category: required
    destination: 'contoso.com'
    name: contosofqdn
    type: fqdn
  firewall_sku: basic
tags: {}
name: test-ws
resource_group: test-rg
location: eastus2 
managed_network:
  isolation_mode: allow_only_approved_outbound
  outbound_rules:
  - category: required
    destination: 'contoso.com'
    name: contosofqdn
    type: fqdn
  firewall_sku: basic
tags: {}
To configure the firewall version from the Python SDK, set thefirewall_skuproperty of theManagedNetworkobject. The following example demonstrates how to set the firewall SKU tobasic:
firewall_sku
ManagedNetwork
basic
network = ManagedNetwork(isolation_mode=IsolationMode.ALLOW_INTERNET_OUTBOUND,
                         firewall_sku='basic')
network = ManagedNetwork(isolation_mode=IsolationMode.ALLOW_INTERNET_OUTBOUND,
                         firewall_sku='basic')
Pricing
The Azure Machine Learning managed virtual network feature is free. However, you're charged for the following resources that are used by the managed virtual network:
Azure Private Link - Private endpoints used to secure communications between the managed virtual network and Azure resources relies on Azure Private Link. For more information on pricing, seeAzure Private Link pricing.
Azure Private Link - Private endpoints used to secure communications between the managed virtual network and Azure resources relies on Azure Private Link. For more information on pricing, seeAzure Private Link pricing.
FQDN outbound rules - FQDN outbound rules are implemented using Azure Firewall. If you use outbound FQDN rules, charges for Azure Firewall are added to your billing. A standard version of Azure Firewall is used by default. For information on selecting the basic version, seeSelect an Azure Firewall version.ImportantThe firewall isn't created until you add an outbound FQDN rule. For more information on pricing, seeAzure Firewall pricingand view prices for thestandardversion.
FQDN outbound rules - FQDN outbound rules are implemented using Azure Firewall. If you use outbound FQDN rules, charges for Azure Firewall are added to your billing. A standard version of Azure Firewall is used by default. For information on selecting the basic version, seeSelect an Azure Firewall version.
Important
The firewall isn't created until you add an outbound FQDN rule. For more information on pricing, seeAzure Firewall pricingand view prices for thestandardversion.
Limitations
Once you enable managed virtual network isolation of your workspace (either allow internet outbound or allow only approved outbound), you can't disable it.
Managed virtual network uses private endpoint connection to access your private resources. You can't have a private endpoint and a service endpoint at the same time for your Azure resources, such as a storage account. We recommend using private endpoints in all scenarios.
The managed virtual network is deleted when the workspace is deleted.
Make sure there are noscope lockson the Azure Machine Learning resources and resource group. Internal operations related to managed virtual network might be blocked.
Data exfiltration protection is automatically enabled for the only approved outbound mode. If you add other outbound rules, such as to FQDNs, Microsoft can't guarantee that you're protected from data exfiltration to those outbound destinations.
Creating a compute cluster in a different region than the workspace isn't supported when using a managed virtual network.
Kubernetes and attached VMs aren't supported in an Azure Machine Learning managed virtual network.
Using FQDN outbound rules increases the cost of the managed virtual network because FQDN rules use Azure Firewall. For more information, seePricing.
FQDN outbound rules only support ports 80 and 443.
If your compute instance is in a managed network and is configured for no public IP, use theaz ml compute connect-sshcommand to connect to it using SSH.
az ml compute connect-ssh
When using Managed virtual network, you can't deploy compute resources inside your custom virtual network. Compute resources can only be created inside the managed virtual network.
If your managed network is configured toallow only approved outbound, you can't use an FQDN rule to access Azure Storage Accounts. You must use a private endpoint instead.
Ensure to allowlist Microsoft-managed private endpoints created for the managed virtual network in your custom policy.
Migration of compute resources
If you have an existing workspace and want to enable managed virtual network for it, there's currently no supported migration path for existing manged compute resources. You'll need to delete all existing managed compute resources and recreate them after enabling the managed virtual network. The following list contains the compute resources that must be deleted and recreated:
Compute cluster
Compute instance
Managed online endpoints
Next steps
Troubleshoot managed virtual network
Configure managed computes in a managed virtual network
Feedback
Was this page helpful?
Additional resources