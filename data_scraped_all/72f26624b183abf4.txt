Note
Access to this page requires authorization. You can trysigning inorchanging directories.
Access to this page requires authorization. You can trychanging directories.
Bring your own key (BYOK) details for Azure Information Protection
Article
2022-08-02
13 contributors
In this article
Note
Are you looking forMicrosoft Purview Information Protection, formerly Microsoft Information Protection (MIP)?
The Azure Information Protection add-in isretiredand replaced with labels that arebuilt in to your Microsoft 365 apps and services. Learn more about thesupport status of other Azure Information Protection components.
TheMicrosoft Purview Information Protection client(without the add-in) isgenerally available.
Organizations with an Azure Information Protection subscription can choose to configure their tenant with their own key, instead of a default key generated by Microsoft. This configuration is often referred to as Bring Your Own Key (BYOK).
BYOK andusage loggingwork seamlessly with applications that integrate with the Azure Rights Management service used by Azure Information Protection.
Supported applications include:
Cloud services, such as Microsoft SharePoint or Microsoft 365
Cloud services, such as Microsoft SharePoint or Microsoft 365
On-premises servicesrunning Exchange and SharePoint applications that use the Azure Rights Management service via the RMS connector
On-premises servicesrunning Exchange and SharePoint applications that use the Azure Rights Management service via the RMS connector
Client applications, such as Office 2019, Office 2016, and Office 2013
Client applications, such as Office 2019, Office 2016, and Office 2013
Tip
If needed, apply additional security to specific documents using an additional on-premises key. For more information, seeDouble Key Encryption (DKE) protection(unified labeling client only).
Azure Key Vault key storage
Customer-generated keys must be stored in the Azure Key Vault for BYOK protection.
Note
Using HSM-protected keys in the Azure Key Vault requires anAzure Key Vault Premium service tier, which incurs an additional monthly subscription fee.
Sharing key vaults and subscriptions
We recommend using adedicated key vaultfor your tenant key. Dedicated key vaults help to ensure that calls by other services do not causeservice limitsto be exceeded. Exceeding service limits on the key vault where your tenant key is stored may cause response time throttling for Azure Rights Management service.
As different services have varying key management requirements, Microsoft also recommends usinga dedicated Azure subscriptionfor your key vault. Dedicated Azure subscriptions:
Help safeguard against misconfigurations
Help safeguard against misconfigurations
Are more secure when different services have different administrators
Are more secure when different services have different administrators
To share an Azure subscription with other services that use Azure Key Vault, make sure that the subscription shares a common set of administrators. Confirming that all administrators who use the subscription have a solid understanding of every key they can access, means they are less likely to misconfigure your keys.
Example: Using a shared Azure subscription when the administrators for your Azure Information Protection tenant key are the same individuals that administer your keys for Office 365 Customer Key and CRM online. If the key administrators for these services are different, we recommend using dedicated subscriptions.
Benefits of using Azure Key Vault
Azure Key Vault provides a centralized and consistent key management solution for many cloud-based and on-premises services that use encryption.
In addition to managing keys, Azure Key Vault offers your security administrators the same management experience to store, access, and manage certificates and secrets (such as passwords) for other services and applications that use encryption.
Storing your tenant key in the Azure Key Vault provides the following advantages:
For the latest updates and to learn how other services useAzure Key Vault, visit theAzure Key Vault team blog.
Usage logging for BYOK
Usage logs are generated by every application that makes requests to the Azure Rights Management service.
Although usage logging is optional, we recommend using the near real-time usage logs from Azure Information Protection to see exactly how and when your tenant key is being used.
For more information about key usage logging for BYOK, seeLogging and analyzing the protection usage from Azure Information Protection.
Tip
For additional assurance, Azure Information Protection usage logging can be cross referenced withAzure Key Vault logging. Key Vault logs provide a reliable method to independently monitor that your key is only used by Azure Rights Management service.
If necessary, immediately revoke access to your key by removing permissions on the key vault.
Options for creating and storing your key
Note
For more information about the Managed HSM offering, and how to set up a vault and a key, see theAzure Key Vault documentation.
Additional instructions on granting key authorization are described below.
BYOK supports keys that are created either in Azure Key Vault or on-premises.
If you create your key on-premises, you must then transfer or import it into your Key Vault and configure Azure Information Protection to use the key. Perform any additional key management from within Azure Key Vault.
Options to create and store your own key:
Created in Azure Key Vault. Create and store your key in Azure Key Vault as an HSM-protected key or a software-protected key.
Created in Azure Key Vault. Create and store your key in Azure Key Vault as an HSM-protected key or a software-protected key.
Created on-premises. Create your key on-premises and transfer it to Azure Key Vault using one of the following options:HSM-protected key, transferred as an HSM-protected key. The most typical method chosen.While this method has the most administrative overhead, it may be required for your organization to follow specific regulations. The HSMs used by Azure Key Vault haveFIPS 140 validation.Software-protected key that is converted and transferred to Azure Key Vault as an HSM-protected key. This method is supported only whenmigrating from Active Directory Rights Management Services (AD RMS).Created on-premises as a software-protected key and transferred to Azure Key Vault as a software-protected key. This method requires a .PFX certificate file.
Created on-premises. Create your key on-premises and transfer it to Azure Key Vault using one of the following options:
HSM-protected key, transferred as an HSM-protected key. The most typical method chosen.While this method has the most administrative overhead, it may be required for your organization to follow specific regulations. The HSMs used by Azure Key Vault haveFIPS 140 validation.
HSM-protected key, transferred as an HSM-protected key. The most typical method chosen.
While this method has the most administrative overhead, it may be required for your organization to follow specific regulations. The HSMs used by Azure Key Vault haveFIPS 140 validation.
Software-protected key that is converted and transferred to Azure Key Vault as an HSM-protected key. This method is supported only whenmigrating from Active Directory Rights Management Services (AD RMS).
Software-protected key that is converted and transferred to Azure Key Vault as an HSM-protected key. This method is supported only whenmigrating from Active Directory Rights Management Services (AD RMS).
Created on-premises as a software-protected key and transferred to Azure Key Vault as a software-protected key. This method requires a .PFX certificate file.
Created on-premises as a software-protected key and transferred to Azure Key Vault as a software-protected key. This method requires a .PFX certificate file.
For example, do the following to use a key created on-premises:
Generate your tenant key on your premises, in line with your organization's IT and security policies. This key is the master copy. It remains on-premises, and you are required for its backup.
Generate your tenant key on your premises, in line with your organization's IT and security policies. This key is the master copy. It remains on-premises, and you are required for its backup.
Create a copy of the master key, and securely transfer it from your HSM to Azure Key Vault. Throughout this process, the master copy of the key never leaves the hardware protection boundary.
Create a copy of the master key, and securely transfer it from your HSM to Azure Key Vault. Throughout this process, the master copy of the key never leaves the hardware protection boundary.
Once transferred, the copy of the key is protected by Azure Key Vault.
Exporting your trusted publishing domain
If you ever decide to stop using Azure Information Protection, you'll need a trusted publishing domain (TPD) to decrypt content that was protected by Azure Information Protection.
However, exporting your TPD isn't supported if you're using BYOK for your Azure Information Protection key.
To prepare for this scenario, make sure to create a suitable TPD ahead of time. For more information, seeHow to prepare an Azure Information Protection "Cloud Exit" plan.
Implementing BYOK for your Azure Information Protection tenant key
Use the following steps to implement BYOK:
Review BYOK prerequisites
Choose a Key Vault location
Create and configure your key
Prerequisites for BYOK
BYOK prerequisites vary, depending on your system configuration. Verify that your system complies with the following prerequisites as needed:
Your Azure Information Protection tenant must have an Azure subscription. If you don't have one yet, you can sign up for afree account. However, to use an HSM-protected key, you must have the Azure Key Vault Premium service tier.
The free Azure subscription that provides access to Microsoft Entra configuration and Azure Rights Management custom template configuration isnotsufficient for using Azure Key Vault.
To confirm whether you have an Azure subscription that is compatible with BYOK, do the following to verify, usingAzure PowerShellcmdlets:
Start an Azure PowerShell session as an administrator.
Start an Azure PowerShell session as an administrator.
Sign in as a global admin for your Azure Information Protection tenant usingConnect-AzAccount.
Sign in as a global admin for your Azure Information Protection tenant usingConnect-AzAccount.
Connect-AzAccount
Copy the token displayed to your clipboard. Then, in a browser, go tohttps://microsoft.com/deviceloginand enter the copied token.For more information, seeSign in with Azure PowerShell.
Copy the token displayed to your clipboard. Then, in a browser, go tohttps://microsoft.com/deviceloginand enter the copied token.
For more information, seeSign in with Azure PowerShell.
In your PowerShell session, enterGet-AzSubscription, and confirm that the following values are displayed:Your subscription name and IDYour Azure Information Protection tenant IDConfirmation that the state is enabledIf no values are displayed and you are returned to the prompt, you do not have an Azure subscription that can be used for BYOK.
In your PowerShell session, enterGet-AzSubscription, and confirm that the following values are displayed:
Get-AzSubscription
Your subscription name and ID
Your Azure Information Protection tenant ID
Confirmation that the state is enabled
If no values are displayed and you are returned to the prompt, you do not have an Azure subscription that can be used for BYOK.
Choosing your key vault location
When you create a key vault to contain the key to be used as your tenant key for Azure Information, you must specify a location. This location is an Azure region, or Azure instance.
Make your choice first for compliance, and then to minimize network latency:
If you have chosen the BYOK key method for compliance reasons, those compliance requirements might also mandate which Azure region or instance can be used to store your Azure Information Protection tenant key.
If you have chosen the BYOK key method for compliance reasons, those compliance requirements might also mandate which Azure region or instance can be used to store your Azure Information Protection tenant key.
All cryptographic calls for protection chain to your Azure Information Protection key. Therefore, you may want to minimize the network latency these calls require by creating your key vault in the same Azure region or instance as your Azure Information Protection tenant.
All cryptographic calls for protection chain to your Azure Information Protection key. Therefore, you may want to minimize the network latency these calls require by creating your key vault in the same Azure region or instance as your Azure Information Protection tenant.
To identify the location of your Azure Information Protection tenant, use theGet-AipServiceConfigurationâ PowerShell cmdlet and identify the region from the URLs. For example:
LicensingIntranetDistributionPointUrl : https://5c6bb73b-1038-4eec-863d-49bded473437.rms.na.aadrm.com/_wmcs/licensing
LicensingIntranetDistributionPointUrl : https://5c6bb73b-1038-4eec-863d-49bded473437.rms.na.aadrm.com/_wmcs/licensing
The region is identifiable fromrms.na.aadrm.com, and for this example, it is in North America.
The following table lists recommended Azure regions and instances for minimizing network latency:
Create and configure your key
Important
For information specific for Managed HSMs, seeEnabling key authorization for Managed HSM keys via Azure CLI.
Create an Azure Key Vault and the key you want to use for Azure Information Protection. For more information, see theAzure Key Vault documentation.
Note the following for configuring your Azure Key Vault and key for BYOK:
Key length requirements
Creating an HSM-protected key on-premises and transferring it to your key vault
Configuring Azure Information Protection with your key ID
Authorizing the Azure Rights Management service to use your key
When creating your key, make sure that the key length is either 2048 bits (recommended) or 1024 bits. Other key lengths are not supported by Azure Information Protection.
Note
1024-bit keys are not considered to offer an adequate level of protection for active tenant keys.
Microsoft doesn't endorse the use of lower key lengths, such as 1024-bit RSA keys, and the associated use of protocols that offer inadequate levels of protection, such as SHA-1.
To create an HSM-protected key on-premises and transfer it to your key vault as an HSM-protected key, follow the procedures in the Azure Key Vault documentation:How to generate and transfer HSM-protected keys for Azure Key Vault.
For Azure Information Protection to use the transferred key, all Key Vault operations must be permitted for the key, including:
encrypt
decrypt
wrapKey
unwrapKey
sign
verify
By default, all Key Vault operations are permitted.
To check the permitted operations for a specific key, run the following PowerShell command:
(Get-AzKeyVaultKey -VaultName <key vault name> -Name <key name>).Attributes.KeyOps
(Get-AzKeyVaultKey -VaultName <key vault name> -Name <key name>).Attributes.KeyOps
If necessary, add permitted operations by usingUpdate-AzKeyVaultKeyand theKeyOpsparameter.
Keys stored in the Azure Key Vault each have a key ID.
The key ID is a URL that contains the name of the key vault, the keys container, the name of the key, and the key version. For example:https://contosorms-kv.vault.azure.net/keys/contosorms-byok/aaaabbbbcccc111122223333
https://contosorms-kv.vault.azure.net/keys/contosorms-byok/aaaabbbbcccc111122223333
Configure Azure Information Protection to use your key by specifying its key vault URL.
The Azure Rights Management service must be authorized to use your key. Azure Key Vault administrators can enable this authorization using the Azure portal or Azure PowerShell.
Sign in to the Azure portal, and go toKey vaults><your key vault name>>Access policies>Add new.
Sign in to the Azure portal, and go toKey vaults><your key vault name>>Access policies>Add new.
From theAdd access policypane, from theConfigure from template (optional)list box, selectAzure Information Protection BYOK, and then clickOK.The selected template has the following configuration:TheSelect principalvalue is set toMicrosoft Rights Management Services.Selectedkey permissionsincludeGet,Decrypt, andSign.
From theAdd access policypane, from theConfigure from template (optional)list box, selectAzure Information Protection BYOK, and then clickOK.
The selected template has the following configuration:
TheSelect principalvalue is set toMicrosoft Rights Management Services.
Selectedkey permissionsincludeGet,Decrypt, andSign.
Run the Key Vault PowerShell cmdlet,Set-AzKeyVaultAccessPolicy, and grant permissions to the Azure Rights Management service principal using the GUID00000012-0000-0000-c000-000000000000.
For example:
Set-AzKeyVaultAccessPolicy -VaultName 'ContosoRMS-kv' -ResourceGroupName 'ContosoRMS-byok-rg' -ServicePrincipalName 00000012-0000-0000-c000-000000000000 -PermissionsToKeys decrypt,sign,get
Set-AzKeyVaultAccessPolicy -VaultName 'ContosoRMS-kv' -ResourceGroupName 'ContosoRMS-byok-rg' -ServicePrincipalName 00000012-0000-0000-c000-000000000000 -PermissionsToKeys decrypt,sign,get
To grant the Azure Rights Management service principal user permissions as aManaged HSM Cryptouser, run the following command:
az keyvault role assignment create --hsm-name "ContosoMHSM" --role "Managed HSM Crypto User" --assignee-principal-type ServicePrincipal --assignee https://aadrm.com/ --scope /keys/contosomhskey
az keyvault role assignment create --hsm-name "ContosoMHSM" --role "Managed HSM Crypto User" --assignee-principal-type ServicePrincipal --assignee https://aadrm.com/ --scope /keys/contosomhskey
Where:
ContosoMHSMis a sample HSM name. When running this command, replace this value with your own HSM name.
TheManaged HSM Crypto Useruser role allows the user to decrypt, sign, and get permissions to the key, which are all required for the Managed HSM functionality.
Configure Azure Information Protection to use your key
Once you've completed all of the steps above, you're ready to configure Azure Information Protection to use this key as your organization's tenant key.
Using Azure RMS cmdlets, run the following commands:
Connect to the Azure Rights Management service and sign in:Connect-AipService
Connect to the Azure Rights Management service and sign in:
Connect-AipService
Connect-AipService
Run theUse-AipServiceKeyVaultKey cmdlet, specifying the key URL. For example:Use-AipServiceKeyVaultKey -KeyVaultKeyUrl "https://contosorms-kv.vault.azure.net/keys/contosorms-byok/<key-version>"ImportantIn this example,<key-version>is the version of the key you want to use. If you do not specify the version, the current version of the key is used by default, and the command may appear to work. However, if your key is later updated or renewed, the Azure Rights Management service will stop working for your tenant, even if you run theUse-AipServiceKeyVaultKeycommand again.Use theGet-AzKeyVaultKeycommand as needed to get the version number of the current key.For example:Get-AzKeyVaultKey -VaultName 'contosorms-kv' -KeyName 'contosorms-byok'To confirm that the key URL is set correctly for Azure Information Protection, run theGet-AzKeyVaultKeycommand in the Azure Key Vault to display the key URL.
Run theUse-AipServiceKeyVaultKey cmdlet, specifying the key URL. For example:
Use-AipServiceKeyVaultKey -KeyVaultKeyUrl "https://contosorms-kv.vault.azure.net/keys/contosorms-byok/<key-version>"
Use-AipServiceKeyVaultKey -KeyVaultKeyUrl "https://contosorms-kv.vault.azure.net/keys/contosorms-byok/<key-version>"
Important
In this example,<key-version>is the version of the key you want to use. If you do not specify the version, the current version of the key is used by default, and the command may appear to work. However, if your key is later updated or renewed, the Azure Rights Management service will stop working for your tenant, even if you run theUse-AipServiceKeyVaultKeycommand again.
<key-version>
Use theGet-AzKeyVaultKeycommand as needed to get the version number of the current key.
For example:Get-AzKeyVaultKey -VaultName 'contosorms-kv' -KeyName 'contosorms-byok'
Get-AzKeyVaultKey -VaultName 'contosorms-kv' -KeyName 'contosorms-byok'
To confirm that the key URL is set correctly for Azure Information Protection, run theGet-AzKeyVaultKeycommand in the Azure Key Vault to display the key URL.
If the Azure Rights Management service is already activated, runSet-AipServiceKeyPropertiesto tell Azure Information Protection to use this key as the active tenant key for the Azure Rights Management service.
If the Azure Rights Management service is already activated, runSet-AipServiceKeyPropertiesto tell Azure Information Protection to use this key as the active tenant key for the Azure Rights Management service.
Azure Information Protection is now configured to use your key instead of the default Microsoft-created key that was automatically created for your tenant.
Next steps
Once you've configured BYOK protection, continue toGetting started with your tenant root keyfor more information about using and managing your key.
Feedback
Was this page helpful?
Additional resources