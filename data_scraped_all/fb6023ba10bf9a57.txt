Note
Access to this page requires authorization. You can trysigning inorchanging directories.
Access to this page requires authorization. You can trychanging directories.
Associate a virtual machine scale set to Uniform Orchestration to a capacity reservation group
Article
2024-09-09
8 contributors
In this article
Applies to:âï¸ Uniform scale set
Azure Virtual Machine Scale Sets has two modes:
Uniform Orchestration: In this mode, virtual machine scale sets use a virtual machine (VM) profile or a template to scale up to the capacity you want. Although there's some ability to manage or customize individual VM instances, Uniform Orchestration uses identical VM instances. These instances are exposed through the virtual machine scale set's VM APIs and aren't compatible with the API commands that are standard for Azure infrastructure as a service (IaaS) VMs. Because the scale set performs all the actual VM operations, reservations are associated to the virtual machine scale set directly. After the scale set is associated to the reservation, all the subsequent VM allocations are done against the reservation.
Flexible Orchestration: In this mode, you get more flexibility to manage the individual virtual machine scale set VM instances. They can use the standard Azure IaaS VM APIs instead of by using the scale set interface. To use reservations with Flexible Orchestration mode, define both the virtual machine scale set property and the capacity reservation property on each VM.
To learn more about these modes, seeVirtual Machine Scale Sets orchestration modes.
This content applies to the Uniform Orchestration mode. For Flexible Orchestration mode, seeAssociate a virtual machine scale set with Flexible Orchestration to a capacity reservation group.
Limitations of scale sets in Uniform Orchestration
For virtual machine scale sets in Uniform Orchestration to be compatible with capacity reservation, thesinglePlacementGroupproperty must be set toFalse.
singlePlacementGroup
False
TheStatic Fixed Spreadingavailability option for multizone uniform scale sets isn't supported with capacity reservation. This option requires the use of five fault domains. However, the reservations only support up to three fault domains for general purpose sizes. The approach we recommend is to use theMax Spreadingoption that spreads VMs across as many fault domains as possible within each zone. If needed, configure a custom fault domain configuration of three or less.
There are some other restrictions when you use capacity reservations. For the complete list, see theoverview of capacity reservations.
Associate a new virtual machine scale set to a capacity reservation group
Important
Starting November 2023, virtual machine scale sets created by using PowerShell and the Azure CLI default to Flexible Orchestration mode if no orchestration mode is specified. For more information about this change and what actions you should take, seeBreaking Change for VMSS PowerShell/CLI Customers - Microsoft Community Hub.
API
CLI
PowerShell
ARM template
To associate a new uniform virtual machine scale set to a capacity reservation group, construct the followingPUTrequest to theMicrosoft.Computeprovider:
PUT
Microsoft.Compute
PUT https://management.azure.com/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Compute/virtualMachineScaleSets/{VMScaleSetName}?api-version=2021-04-01
PUT https://management.azure.com/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Compute/virtualMachineScaleSets/{VMScaleSetName}?api-version=2021-04-01
Add thecapacityReservationGroupproperty in thevirtualMachineProfileproperty:
capacityReservationGroup
virtualMachineProfile
{ 
â¯â¯â¯â¯"name":â¯"<VMScaleSetName>", 
â¯â¯â¯â¯"id":â¯"/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Compute/virtualMachineScaleSets/{VMScaleSetName}", 
â¯â¯â¯â¯"type":â¯"Microsoft.Compute/virtualMachineScaleSets", 
â¯â¯â¯â¯"location":â¯"eastus", 
â¯â¯â¯â¯"sku":â¯{ 
â¯â¯â¯â¯â¯â¯â¯â¯"name":â¯"Standard_D2s_v3", 
â¯â¯â¯â¯â¯â¯â¯â¯"tier":â¯"Standard", 
â¯â¯â¯â¯â¯â¯â¯â¯"capacity":â¯3 
}, 
"properties":â¯{ 
    "virtualMachineProfile":â¯{ 
        "capacityReservation":â¯{ 
            "capacityReservationGroup":{ 
                "id":"subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Compute/CapacityReservationGroup/{CapacityReservationGroupName}" 
            } 
â¯â¯â¯â¯â¯    }, 
        "osProfile":â¯{ 
            â¦ 
        }, 
        "storageProfile":â¯{ 
            â¦ 
        }, 
        "networkProfile":â¯{ 
            â¦,
            "extensionProfile":â¯{ 
                â¦ 
            } 
        } 
    }
{ 
â¯â¯â¯â¯"name":â¯"<VMScaleSetName>", 
â¯â¯â¯â¯"id":â¯"/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Compute/virtualMachineScaleSets/{VMScaleSetName}", 
â¯â¯â¯â¯"type":â¯"Microsoft.Compute/virtualMachineScaleSets", 
â¯â¯â¯â¯"location":â¯"eastus", 
â¯â¯â¯â¯"sku":â¯{ 
â¯â¯â¯â¯â¯â¯â¯â¯"name":â¯"Standard_D2s_v3", 
â¯â¯â¯â¯â¯â¯â¯â¯"tier":â¯"Standard", 
â¯â¯â¯â¯â¯â¯â¯â¯"capacity":â¯3 
}, 
"properties":â¯{ 
    "virtualMachineProfile":â¯{ 
        "capacityReservation":â¯{ 
            "capacityReservationGroup":{ 
                "id":"subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Compute/CapacityReservationGroup/{CapacityReservationGroupName}" 
            } 
â¯â¯â¯â¯â¯    }, 
        "osProfile":â¯{ 
            â¦ 
        }, 
        "storageProfile":â¯{ 
            â¦ 
        }, 
        "networkProfile":â¯{ 
            â¦,
            "extensionProfile":â¯{ 
                â¦ 
            } 
        } 
    }
Useaz vmss createto create a new virtual machine scale set and add thecapacity-reservation-groupproperty to associate the scale set to an existing capacity reservation group. The following example creates a uniform scale set for a Standard_Ds1_v2 VM in the East US location and associates the scale set to a capacity reservation group.
az vmss create
capacity-reservation-group
az vmss create 
--resource-group myResourceGroup 
--name myVMSS 
--location eastus 
--orchestration-mode Uniform
--vm-sku Standard_Ds1_v2 
--image Ubuntu2204 
--capacity-reservation-group /subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Compute/capacityReservationGroups/{capacityReservationGroupName}
az vmss create 
--resource-group myResourceGroup 
--name myVMSS 
--location eastus 
--orchestration-mode Uniform
--vm-sku Standard_Ds1_v2 
--image Ubuntu2204 
--capacity-reservation-group /subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Compute/capacityReservationGroups/{capacityReservationGroupName}
UseNew-AzVmssto create a new virtual machine scale set and add theCapacityReservationGroupIdproperty to associate the scale set to an existing capacity reservation group. The following example creates a uniform scale set for a Standard_Ds1_v2 VM in the East US location and associates the scale set to a capacity reservation group.
New-AzVmss
CapacityReservationGroupId
$vmssName = <"VMSSNAME">
$vmPassword = ConvertTo-SecureString <"PASSWORD"> -AsPlainText -Force
$vmCred = New-Object System.Management.Automation.PSCredential(<"USERNAME">, $vmPassword)
New-AzVmss
âCredential $vmCred
-VMScaleSetName $vmssName
-ResourceGroupName "myResourceGroup"
-CapacityReservationGroupId "/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Compute/capacityReservationGroups/{capacityReservationGroupName}"
-OrchestrationMode "Uniform"
-PlatformFaultDomainCount 2
$vmssName = <"VMSSNAME">
$vmPassword = ConvertTo-SecureString <"PASSWORD"> -AsPlainText -Force
$vmCred = New-Object System.Management.Automation.PSCredential(<"USERNAME">, $vmPassword)
New-AzVmss
âCredential $vmCred
-VMScaleSetName $vmssName
-ResourceGroupName "myResourceGroup"
-CapacityReservationGroupId "/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Compute/capacityReservationGroups/{capacityReservationGroupName}"
-OrchestrationMode "Uniform"
-PlatformFaultDomainCount 2
To learn more, see the Azure PowerShell commandNew-AzVmss.
Anâ¯Azure Resource Manager template (ARM template)â¯is a JSON file that defines the infrastructure and configuration for your project. The template uses declarative syntax. In declarative syntax, you describe your intended deployment without writing the sequence of programming commands to create the deployment.
ARM templates let you deploy groups of related resources. In a single template, you can create capacity reservation group and capacity reservations. You can deploy templates through the Azure portal, the Azure CLI, or Azure PowerShell, or from continuous integration/continuous delivery (CI/CD) pipelines.
To associate a Virtual Machine Scale Set with a Capacity Reservation Group, see the following ARM template. Replace the resource names with your own. The following example creates a VM scale set of SKU D2s_v3 and associates to a capacity reservation group.
{
   "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
   "contentVersion": "1.0.0.0",
   "parameters": {
       "vmSku": {
           "type": "string",
           "defaultValue": "Standard_D2s_v3",
           "metadata": {
               "description": "Size of VMs in the VM Scale Set."
           }
       },
       "windowsOSVersion": {
           "type": "string",
           "defaultValue": "2019-Datacenter",
           "allowedValues": [
               "2008-R2-SP1",
               "2012-Datacenter",
               "2012-R2-Datacenter",
               "2016-Datacenter",
               "2019-Datacenter"
           ],
           "metadata": {
               "description": "The Windows version for the VM. This will pick a fully patched image of this given Windows version. Allowed values: 2008-R2-SP1, 2012-Datacenter, 2012-R2-Datacenter & 2016-Datacenter, 2019-Datacenter."
           }
       },
       "vmssName": {
           "type": "string",
           "minLength": 3,
           "maxLength": 61,
           "metadata": {
               "description": "String used as a base for naming resources. Must be 3-61 characters in length and globally unique across Azure. A hash is prepended to this string for some resources, and resource-specific information is appended."
           }
       },
       "instanceCount": {
           "type": "int",
           "defaultValue": 1,
           "minValue": 1,
           "maxValue": 100,
           "metadata": {
               "description": "Number of VM instances (100 or less)."
           }
       },
       "singlePlacementGroup": {
           "type": "bool",
           "defaultValue": false,
           "metadata": {
               "description": "When true this limits the scale set to a single placement group, of max size 100 virtual machines. NOTE: If singlePlacementGroup is true, it may be modified to false. However, if singlePlacementGroup is false, it may not be modified to true."
           }
       },
       "adminUsername": {
           "type": "string",
           "defaultValue": "vmssadmin",
           "metadata": {
               "description": "Admin username on all VMs."
           }
       },
       "adminPassword": {
           "type": "securestring",
           "metadata": {
               "description": "Admin password on all VMs."
           }
       },
       "_artifactsLocation": {
           "type": "string",
           "defaultValue": "https://raw.githubusercontent.com/Azure/azure-quickstart-templates/master/201-vmss-windows-webapp-dsc-autoscale/",
           "metadata": {
               "description": "The base URI where artifacts required by this template are located. For example, if stored on a public GitHub repo, you'd use the following URI: https://raw.githubusercontent.com/Azure/azure-quickstart-templates/master/201-vmss-windows-webapp-dsc-autoscale/."
           }
       },
       "_artifactsLocationSasToken": {
           "type": "securestring",
           "defaultValue": "",
           "metadata": {
               "description": "The sasToken required to access _artifactsLocation.  If your artifacts are stored on a public repo or public storage account you can leave this blank."
           }
       },
       "powershelldscZip": {
           "type": "string",
           "defaultValue": "DSC/InstallIIS.zip",
           "metadata": {
               "description": "Location of the PowerShell DSC zip file relative to the URI specified in the _artifactsLocation, i.e. DSC/IISInstall.ps1.zip"
           }
       },
       "webDeployPackage": {
           "type": "string",
           "defaultValue": "WebDeploy/DefaultASPWebApp.v1.0.zip",
           "metadata": {
               "description": "Location of the  of the WebDeploy package zip file relative to the URI specified in _artifactsLocation, i.e. WebDeploy/DefaultASPWebApp.v1.0.zip"
           }
       },
       "powershelldscUpdateTagVersion": {
           "type": "string",
           "defaultValue": "1.0",
           "metadata": {
               "description": "Version number of the DSC deployment. Changing this value on subsequent deployments will trigger the extension to run."
           }
       },
       "location": {
           "type": "string",
           "defaultValue": "[resourceGroup().location]",
           "metadata": {
               "description": "Location for all resources."
           }
       },
       "platformFaultDomainCount": {
           "type": "int",
           "defaultValue": 1,
           "metadata": {
               "description": "Fault Domain count for each placement group."
           }
       }
   },
   "variables": {
       "namingInfix": "[toLower(substring(concat(parameters('vmssName'), uniqueString(resourceGroup().id)), 0, 9))]",
       "longNamingInfix": "[toLower(parameters('vmssName'))]",
       "addressPrefix": "10.0.0.0/16",
       "subnetPrefix": "10.0.0.0/24",
       "virtualNetworkName": "[concat(variables('namingInfix'), 'vnet')]",
       "publicIPAddressName": "[concat(variables('namingInfix'), 'pip')]",
       "subnetName": "[concat(variables('namingInfix'), 'subnet')]",
       "loadBalancerName": "[concat(variables('namingInfix'), 'lb')]",
       "publicIPAddressID": "[resourceId('Microsoft.Network/publicIPAddresses',variables('publicIPAddressName'))]",
       "lbProbeID": "[resourceId('Microsoft.Network/loadBalancers/probes',variables('loadBalancerName'), 'tcpProbe')]",
       "natPoolName": "[concat(variables('namingInfix'), 'natpool')]",
       "bePoolName": "[concat(variables('namingInfix'), 'bepool')]",
       "lbPoolID": "[resourceId('Microsoft.Network/loadBalancers/backendAddressPools',variables('loadBalancerName'),variables('bePoolName'))]",
       "natStartPort": 50000,
       "natEndPort": 50119,
       "natBackendPort": 3389,
       "nicName": "[concat(variables('namingInfix'), 'nic')]",
       "ipConfigName": "[concat(variables('namingInfix'), 'ipconfig')]",
       "frontEndIPConfigID": "[resourceId('Microsoft.Network/loadBalancers/frontendIPConfigurations',variables('loadBalancerName'),'loadBalancerFrontEnd')]",
       "osType": {
           "publisher": "MicrosoftWindowsServer",
           "offer": "WindowsServer",
           "sku": "[parameters('windowsOSVersion')]",
           "version": "latest"
       },
       "imageReference": {
           "publisher": "MicrosoftWindowsServer",
           "offer": "WindowsServer",
           "sku": "[parameters('windowsOSVersion')]",
           "version": "latest"
         },
       "webDeployPackageFullPath": "[uri(parameters('_artifactsLocation'), concat(parameters('webDeployPackage'), parameters('_artifactsLocationSasToken')))]",
       "powershelldscZipFullPath": "[uri(parameters('_artifactsLocation'), concat(parameters('powershelldscZip'), parameters('_artifactsLocationSasToken')))]"
   },
   "resources": [
       {
           "type": "Microsoft.Network/loadBalancers",
           "apiVersion": "2020-06-01",
           "name": "[variables('loadBalancerName')]",
           "location": "[parameters('location')]",
           "dependsOn": [
               "[resourceId('Microsoft.Network/publicIPAddresses', variables('publicIPAddressName'))]"
           ],
           "properties": {
               "frontendIPConfigurations": [
                   {
                       "name": "LoadBalancerFrontEnd",
                       "properties": {
                           "publicIPAddress": {
                               "id": "[variables('publicIPAddressID')]"
                           }
                       }
                   }
               ],
               "backendAddressPools": [
                   {
                       "name": "[variables('bePoolName')]"
                   }
               ],
               "inboundNatPools": [
                   {
                       "name": "[variables('natPoolName')]",
                       "properties": {
                           "frontendIPConfiguration": {
                               "id": "[variables('frontEndIPConfigID')]"
                           },
                           "protocol": "Tcp",
                           "frontendPortRangeStart": "[variables('natStartPort')]",
                           "frontendPortRangeEnd": "[variables('natEndPort')]",
                           "backendPort": "[variables('natBackendPort')]"
                       }
                   }
               ],
               "loadBalancingRules": [
                   {
                       "name": "LBRule",
                       "properties": {
                           "frontendIPConfiguration": {
                               "id": "[variables('frontEndIPConfigID')]"
                           },
                           "backendAddressPool": {
                               "id": "[variables('lbPoolID')]"
                           },
                           "protocol": "Tcp",
                           "frontendPort": 80,
                           "backendPort": 80,
                           "enableFloatingIP": false,
                           "idleTimeoutInMinutes": 5,
                           "probe": {
                               "id": "[variables('lbProbeID')]"
                           }
                       }
                   }
               ],
               "probes": [
                   {
                       "name": "tcpProbe",
                       "properties": {
                           "protocol": "Tcp",
                           "port": 80,
                           "intervalInSeconds": 5,
                           "numberOfProbes": 2
                       }
                   }
               ]
           }
       },
       {
           "type": "Microsoft.Compute/virtualMachineScaleSets",
           "apiVersion": "2020-06-01",
           "name": "[variables('namingInfix')]",
           "location": "[parameters('location')]",
           "sku": {
               "name": "[parameters('vmSku')]",
               "tier": "Standard",
               "capacity": "[parameters('instanceCount')]"
           },
           "dependsOn": [
               "[resourceId('Microsoft.Network/loadBalancers', variables('loadBalancerName'))]",
               "[resourceId('Microsoft.Network/virtualNetworks', variables('virtualNetworkName'))]"
           ],
           "properties": {
               "overprovision": true,
               "upgradePolicy": {
                   "mode": "Automatic"
               },
               "singlePlacementGroup": "[parameters('singlePlacementGroup')]",
               "platformFaultDomainCount": "[parameters('platformFaultDomainCount')]",
               "virtualMachineProfile": {
                   "storageProfile": {
                       "osDisk": {
                           "caching": "ReadWrite",
                           "createOption": "FromImage"
                       },
                       "imageReference": "[variables('imageReference')]"
                   },
                   "osProfile": {
                       "computerNamePrefix": "[variables('namingInfix')]",
                       "adminUsername": "[parameters('adminUsername')]",
                       "adminPassword": "[parameters('adminPassword')]"
                   },
                   "networkProfile": {
                       "networkInterfaceConfigurations": [
                           {
                               "name": "[variables('nicName')]",
                               "properties": {
                                   "primary": true,
                                   "ipConfigurations": [
                                       {
                                           "name": "[variables('ipConfigName')]",
                                           "properties": {
                                               "subnet": {
                                                   "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('virtualNetworkName'), variables('subnetName'))]"
                                               },
                                               "loadBalancerBackendAddressPools": [
                                                   {
                                                       "id": "[variables('lbPoolID')]"
                                                   }
                                               ],
                                               "loadBalancerInboundNatPools": [
                                                   {
                                                       "id": "[resourceId('Microsoft.Network/loadBalancers/inboundNatPools', variables('loadBalancerName'),  variables('natPoolName'))]"
                                                   }
                                               ]
                                           }
                                       }
                                   ]
                               }
                           }
                       ]
                   },
                   "capacityReservation": {
                     "capacityReservationGroup": {
                        "id":"subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Compute/capacityReservationGroups/{CapacityReservationGroupName}"
                     }
                   }
               }
           }
       },
       {
           "type": "Microsoft.Network/publicIPAddresses",
           "apiVersion": "2020-06-01",
           "name": "[variables('publicIPAddressName')]",
           "location": "[parameters('location')]",
           "properties": {
               "publicIPAllocationMethod": "Static",
               "dnsSettings": {
                   "domainNameLabel": "[variables('longNamingInfix')]"
               }
           }
       },
       {
           "type": "Microsoft.Network/virtualNetworks",
           "apiVersion": "2020-06-01",
           "name": "[variables('virtualNetworkName')]",
           "location": "[parameters('location')]",
           "properties": {
               "addressSpace": {
                   "addressPrefixes": [
                       "[variables('addressPrefix')]"
                   ]
               },
               "subnets": [
                   {
                       "name": "[variables('subnetName')]",
                       "properties": {
                           "addressPrefix": "[variables('subnetPrefix')]"
                       }
                   }
               ]
           }
       },
       {
           "type": "Microsoft.Insights/autoscaleSettings",
           "apiVersion": "2015-04-01",
           "name": "autoscalehost",
           "location": "[parameters('location')]",
           "dependsOn": [
               "[resourceId('Microsoft.Compute/virtualMachineScaleSets/', variables('namingInfix'))]"
           ],
           "properties": {
               "name": "autoscalehost",
               "targetResourceUri": "[resourceId('Microsoft.Compute/virtualMachineScaleSets', variables('namingInfix'))]",
               "enabled": true,
               "profiles": [
                   {
                       "name": "Profile1",
                       "capacity": {
                           "minimum": "1",
                           "maximum": "10",
                           "default": "1"
                       },
                       "rules": [
                           {
                               "metricTrigger": {
                                   "metricName": "Percentage CPU",
                                   "metricResourceUri": "[resourceId('Microsoft.Compute/virtualMachineScaleSets', variables('namingInfix'))]",
                                   "timeGrain": "PT1M",
                                   "statistic": "Average",
                                   "timeWindow": "PT5M",
                                   "timeAggregation": "Average",
                                   "operator": "GreaterThan",
                                   "threshold": 50
                               },
                               "scaleAction": {
                                   "direction": "Increase",
                                   "type": "ChangeCount",
                                   "value": "1",
                                   "cooldown": "PT5M"
                               }
                           },
                           {
                               "metricTrigger": {
                                   "metricName": "Percentage CPU",
                                   "metricResourceUri": "[resourceId('Microsoft.Compute/virtualMachineScaleSets', variables('namingInfix'))]",
                                   "timeGrain": "PT1M",
                                   "statistic": "Average",
                                   "timeWindow": "PT5M",
                                   "timeAggregation": "Average",
                                   "operator": "LessThan",
                                   "threshold": 30
                               },
                               "scaleAction": {
                                   "direction": "Decrease",
                                   "type": "ChangeCount",
                                   "value": "1",
                                   "cooldown": "PT5M"
                               }
                           }
                       ]
                   }
               ]
           }
       }
   ],
   "outputs": {
       "applicationUrl": {
           "type": "string",
           "value": "[concat('http://', reference(variables('publicIPAddressName')).dnsSettings.fqdn, '/MyApp')]"
       }
   }
}
{
   "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
   "contentVersion": "1.0.0.0",
   "parameters": {
       "vmSku": {
           "type": "string",
           "defaultValue": "Standard_D2s_v3",
           "metadata": {
               "description": "Size of VMs in the VM Scale Set."
           }
       },
       "windowsOSVersion": {
           "type": "string",
           "defaultValue": "2019-Datacenter",
           "allowedValues": [
               "2008-R2-SP1",
               "2012-Datacenter",
               "2012-R2-Datacenter",
               "2016-Datacenter",
               "2019-Datacenter"
           ],
           "metadata": {
               "description": "The Windows version for the VM. This will pick a fully patched image of this given Windows version. Allowed values: 2008-R2-SP1, 2012-Datacenter, 2012-R2-Datacenter & 2016-Datacenter, 2019-Datacenter."
           }
       },
       "vmssName": {
           "type": "string",
           "minLength": 3,
           "maxLength": 61,
           "metadata": {
               "description": "String used as a base for naming resources. Must be 3-61 characters in length and globally unique across Azure. A hash is prepended to this string for some resources, and resource-specific information is appended."
           }
       },
       "instanceCount": {
           "type": "int",
           "defaultValue": 1,
           "minValue": 1,
           "maxValue": 100,
           "metadata": {
               "description": "Number of VM instances (100 or less)."
           }
       },
       "singlePlacementGroup": {
           "type": "bool",
           "defaultValue": false,
           "metadata": {
               "description": "When true this limits the scale set to a single placement group, of max size 100 virtual machines. NOTE: If singlePlacementGroup is true, it may be modified to false. However, if singlePlacementGroup is false, it may not be modified to true."
           }
       },
       "adminUsername": {
           "type": "string",
           "defaultValue": "vmssadmin",
           "metadata": {
               "description": "Admin username on all VMs."
           }
       },
       "adminPassword": {
           "type": "securestring",
           "metadata": {
               "description": "Admin password on all VMs."
           }
       },
       "_artifactsLocation": {
           "type": "string",
           "defaultValue": "https://raw.githubusercontent.com/Azure/azure-quickstart-templates/master/201-vmss-windows-webapp-dsc-autoscale/",
           "metadata": {
               "description": "The base URI where artifacts required by this template are located. For example, if stored on a public GitHub repo, you'd use the following URI: https://raw.githubusercontent.com/Azure/azure-quickstart-templates/master/201-vmss-windows-webapp-dsc-autoscale/."
           }
       },
       "_artifactsLocationSasToken": {
           "type": "securestring",
           "defaultValue": "",
           "metadata": {
               "description": "The sasToken required to access _artifactsLocation.  If your artifacts are stored on a public repo or public storage account you can leave this blank."
           }
       },
       "powershelldscZip": {
           "type": "string",
           "defaultValue": "DSC/InstallIIS.zip",
           "metadata": {
               "description": "Location of the PowerShell DSC zip file relative to the URI specified in the _artifactsLocation, i.e. DSC/IISInstall.ps1.zip"
           }
       },
       "webDeployPackage": {
           "type": "string",
           "defaultValue": "WebDeploy/DefaultASPWebApp.v1.0.zip",
           "metadata": {
               "description": "Location of the  of the WebDeploy package zip file relative to the URI specified in _artifactsLocation, i.e. WebDeploy/DefaultASPWebApp.v1.0.zip"
           }
       },
       "powershelldscUpdateTagVersion": {
           "type": "string",
           "defaultValue": "1.0",
           "metadata": {
               "description": "Version number of the DSC deployment. Changing this value on subsequent deployments will trigger the extension to run."
           }
       },
       "location": {
           "type": "string",
           "defaultValue": "[resourceGroup().location]",
           "metadata": {
               "description": "Location for all resources."
           }
       },
       "platformFaultDomainCount": {
           "type": "int",
           "defaultValue": 1,
           "metadata": {
               "description": "Fault Domain count for each placement group."
           }
       }
   },
   "variables": {
       "namingInfix": "[toLower(substring(concat(parameters('vmssName'), uniqueString(resourceGroup().id)), 0, 9))]",
       "longNamingInfix": "[toLower(parameters('vmssName'))]",
       "addressPrefix": "10.0.0.0/16",
       "subnetPrefix": "10.0.0.0/24",
       "virtualNetworkName": "[concat(variables('namingInfix'), 'vnet')]",
       "publicIPAddressName": "[concat(variables('namingInfix'), 'pip')]",
       "subnetName": "[concat(variables('namingInfix'), 'subnet')]",
       "loadBalancerName": "[concat(variables('namingInfix'), 'lb')]",
       "publicIPAddressID": "[resourceId('Microsoft.Network/publicIPAddresses',variables('publicIPAddressName'))]",
       "lbProbeID": "[resourceId('Microsoft.Network/loadBalancers/probes',variables('loadBalancerName'), 'tcpProbe')]",
       "natPoolName": "[concat(variables('namingInfix'), 'natpool')]",
       "bePoolName": "[concat(variables('namingInfix'), 'bepool')]",
       "lbPoolID": "[resourceId('Microsoft.Network/loadBalancers/backendAddressPools',variables('loadBalancerName'),variables('bePoolName'))]",
       "natStartPort": 50000,
       "natEndPort": 50119,
       "natBackendPort": 3389,
       "nicName": "[concat(variables('namingInfix'), 'nic')]",
       "ipConfigName": "[concat(variables('namingInfix'), 'ipconfig')]",
       "frontEndIPConfigID": "[resourceId('Microsoft.Network/loadBalancers/frontendIPConfigurations',variables('loadBalancerName'),'loadBalancerFrontEnd')]",
       "osType": {
           "publisher": "MicrosoftWindowsServer",
           "offer": "WindowsServer",
           "sku": "[parameters('windowsOSVersion')]",
           "version": "latest"
       },
       "imageReference": {
           "publisher": "MicrosoftWindowsServer",
           "offer": "WindowsServer",
           "sku": "[parameters('windowsOSVersion')]",
           "version": "latest"
         },
       "webDeployPackageFullPath": "[uri(parameters('_artifactsLocation'), concat(parameters('webDeployPackage'), parameters('_artifactsLocationSasToken')))]",
       "powershelldscZipFullPath": "[uri(parameters('_artifactsLocation'), concat(parameters('powershelldscZip'), parameters('_artifactsLocationSasToken')))]"
   },
   "resources": [
       {
           "type": "Microsoft.Network/loadBalancers",
           "apiVersion": "2020-06-01",
           "name": "[variables('loadBalancerName')]",
           "location": "[parameters('location')]",
           "dependsOn": [
               "[resourceId('Microsoft.Network/publicIPAddresses', variables('publicIPAddressName'))]"
           ],
           "properties": {
               "frontendIPConfigurations": [
                   {
                       "name": "LoadBalancerFrontEnd",
                       "properties": {
                           "publicIPAddress": {
                               "id": "[variables('publicIPAddressID')]"
                           }
                       }
                   }
               ],
               "backendAddressPools": [
                   {
                       "name": "[variables('bePoolName')]"
                   }
               ],
               "inboundNatPools": [
                   {
                       "name": "[variables('natPoolName')]",
                       "properties": {
                           "frontendIPConfiguration": {
                               "id": "[variables('frontEndIPConfigID')]"
                           },
                           "protocol": "Tcp",
                           "frontendPortRangeStart": "[variables('natStartPort')]",
                           "frontendPortRangeEnd": "[variables('natEndPort')]",
                           "backendPort": "[variables('natBackendPort')]"
                       }
                   }
               ],
               "loadBalancingRules": [
                   {
                       "name": "LBRule",
                       "properties": {
                           "frontendIPConfiguration": {
                               "id": "[variables('frontEndIPConfigID')]"
                           },
                           "backendAddressPool": {
                               "id": "[variables('lbPoolID')]"
                           },
                           "protocol": "Tcp",
                           "frontendPort": 80,
                           "backendPort": 80,
                           "enableFloatingIP": false,
                           "idleTimeoutInMinutes": 5,
                           "probe": {
                               "id": "[variables('lbProbeID')]"
                           }
                       }
                   }
               ],
               "probes": [
                   {
                       "name": "tcpProbe",
                       "properties": {
                           "protocol": "Tcp",
                           "port": 80,
                           "intervalInSeconds": 5,
                           "numberOfProbes": 2
                       }
                   }
               ]
           }
       },
       {
           "type": "Microsoft.Compute/virtualMachineScaleSets",
           "apiVersion": "2020-06-01",
           "name": "[variables('namingInfix')]",
           "location": "[parameters('location')]",
           "sku": {
               "name": "[parameters('vmSku')]",
               "tier": "Standard",
               "capacity": "[parameters('instanceCount')]"
           },
           "dependsOn": [
               "[resourceId('Microsoft.Network/loadBalancers', variables('loadBalancerName'))]",
               "[resourceId('Microsoft.Network/virtualNetworks', variables('virtualNetworkName'))]"
           ],
           "properties": {
               "overprovision": true,
               "upgradePolicy": {
                   "mode": "Automatic"
               },
               "singlePlacementGroup": "[parameters('singlePlacementGroup')]",
               "platformFaultDomainCount": "[parameters('platformFaultDomainCount')]",
               "virtualMachineProfile": {
                   "storageProfile": {
                       "osDisk": {
                           "caching": "ReadWrite",
                           "createOption": "FromImage"
                       },
                       "imageReference": "[variables('imageReference')]"
                   },
                   "osProfile": {
                       "computerNamePrefix": "[variables('namingInfix')]",
                       "adminUsername": "[parameters('adminUsername')]",
                       "adminPassword": "[parameters('adminPassword')]"
                   },
                   "networkProfile": {
                       "networkInterfaceConfigurations": [
                           {
                               "name": "[variables('nicName')]",
                               "properties": {
                                   "primary": true,
                                   "ipConfigurations": [
                                       {
                                           "name": "[variables('ipConfigName')]",
                                           "properties": {
                                               "subnet": {
                                                   "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('virtualNetworkName'), variables('subnetName'))]"
                                               },
                                               "loadBalancerBackendAddressPools": [
                                                   {
                                                       "id": "[variables('lbPoolID')]"
                                                   }
                                               ],
                                               "loadBalancerInboundNatPools": [
                                                   {
                                                       "id": "[resourceId('Microsoft.Network/loadBalancers/inboundNatPools', variables('loadBalancerName'),  variables('natPoolName'))]"
                                                   }
                                               ]
                                           }
                                       }
                                   ]
                               }
                           }
                       ]
                   },
                   "capacityReservation": {
                     "capacityReservationGroup": {
                        "id":"subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Compute/capacityReservationGroups/{CapacityReservationGroupName}"
                     }
                   }
               }
           }
       },
       {
           "type": "Microsoft.Network/publicIPAddresses",
           "apiVersion": "2020-06-01",
           "name": "[variables('publicIPAddressName')]",
           "location": "[parameters('location')]",
           "properties": {
               "publicIPAllocationMethod": "Static",
               "dnsSettings": {
                   "domainNameLabel": "[variables('longNamingInfix')]"
               }
           }
       },
       {
           "type": "Microsoft.Network/virtualNetworks",
           "apiVersion": "2020-06-01",
           "name": "[variables('virtualNetworkName')]",
           "location": "[parameters('location')]",
           "properties": {
               "addressSpace": {
                   "addressPrefixes": [
                       "[variables('addressPrefix')]"
                   ]
               },
               "subnets": [
                   {
                       "name": "[variables('subnetName')]",
                       "properties": {
                           "addressPrefix": "[variables('subnetPrefix')]"
                       }
                   }
               ]
           }
       },
       {
           "type": "Microsoft.Insights/autoscaleSettings",
           "apiVersion": "2015-04-01",
           "name": "autoscalehost",
           "location": "[parameters('location')]",
           "dependsOn": [
               "[resourceId('Microsoft.Compute/virtualMachineScaleSets/', variables('namingInfix'))]"
           ],
           "properties": {
               "name": "autoscalehost",
               "targetResourceUri": "[resourceId('Microsoft.Compute/virtualMachineScaleSets', variables('namingInfix'))]",
               "enabled": true,
               "profiles": [
                   {
                       "name": "Profile1",
                       "capacity": {
                           "minimum": "1",
                           "maximum": "10",
                           "default": "1"
                       },
                       "rules": [
                           {
                               "metricTrigger": {
                                   "metricName": "Percentage CPU",
                                   "metricResourceUri": "[resourceId('Microsoft.Compute/virtualMachineScaleSets', variables('namingInfix'))]",
                                   "timeGrain": "PT1M",
                                   "statistic": "Average",
                                   "timeWindow": "PT5M",
                                   "timeAggregation": "Average",
                                   "operator": "GreaterThan",
                                   "threshold": 50
                               },
                               "scaleAction": {
                                   "direction": "Increase",
                                   "type": "ChangeCount",
                                   "value": "1",
                                   "cooldown": "PT5M"
                               }
                           },
                           {
                               "metricTrigger": {
                                   "metricName": "Percentage CPU",
                                   "metricResourceUri": "[resourceId('Microsoft.Compute/virtualMachineScaleSets', variables('namingInfix'))]",
                                   "timeGrain": "PT1M",
                                   "statistic": "Average",
                                   "timeWindow": "PT5M",
                                   "timeAggregation": "Average",
                                   "operator": "LessThan",
                                   "threshold": 30
                               },
                               "scaleAction": {
                                   "direction": "Decrease",
                                   "type": "ChangeCount",
                                   "value": "1",
                                   "cooldown": "PT5M"
                               }
                           }
                       ]
                   }
               ]
           }
       }
   ],
   "outputs": {
       "applicationUrl": {
           "type": "string",
           "value": "[concat('http://', reference(variables('publicIPAddressName')).dnsSettings.fqdn, '/MyApp')]"
       }
   }
}
Associate an existing virtual machine scale set to a capacity reservation group
To add an existing capacity reservation group to an existing uniform scale set:
Stop the scale set to deallocate the VM instances.
Update the scale set to use a matching capacity reservation group.
Start the scale set.
This process ensures that the placement for the capacity reservations and scale set in the region are compatible.
Important notes on upgrade policies
Automatic upgrade: In this mode, the scale set VM instances are automatically associated to the capacity reservation group without any further action from you. When the scale set VMs are reallocated, they start consuming the reserved capacity.
Rolling upgrade: In this mode, scale set VM instances are associated to the capacity reservation group without any further action from you. However, they're updated in batches with an optional pause time between them. When the scale set VMs are reallocated, they start consuming the reserved capacity.
Manual upgrade: In this mode, nothing happens to the scale set VM instances when the virtual machine scale set is attached to a capacity reservation group. You need to update to each scale set VM byupgrading it with the latest scale set model.
API
CLI
PowerShell
Deallocate the virtual machine scale set:POST https://management.azure.com/subscriptions/{subscriptionId}/resourceGroups/{resourcegroupname}/providers/Microsoft.Compute/virtualMachineScaleSets/{VMScaleSetName}/deallocate?api-version=2021-04-01
Deallocate the virtual machine scale set:
POST https://management.azure.com/subscriptions/{subscriptionId}/resourceGroups/{resourcegroupname}/providers/Microsoft.Compute/virtualMachineScaleSets/{VMScaleSetName}/deallocate?api-version=2021-04-01
POST https://management.azure.com/subscriptions/{subscriptionId}/resourceGroups/{resourcegroupname}/providers/Microsoft.Compute/virtualMachineScaleSets/{VMScaleSetName}/deallocate?api-version=2021-04-01
Add thecapacityReservationGroupproperty to the scale set model. Construct the followingPUTrequest toMicrosoft.Computeprovider:PUT https://management.azure.com/subscriptions/{subscriptionId}/resourceGroups/{resourcegroupname}/providers/Microsoft.Compute/virtualMachineScaleSets/{VMScaleSetName}?api-version=2021-04-01In the request body, include thecapacityReservationGroupproperty:"location": "eastus",
"properties": {
    "virtualMachineProfile": {
         "capacityReservation": {
                  "capacityReservationGroup": {
                        "id": "/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Compute/capacityReservationGroups/{capacityReservationGroupName}"
                  }
            }
    }
}
Add thecapacityReservationGroupproperty to the scale set model. Construct the followingPUTrequest toMicrosoft.Computeprovider:
capacityReservationGroup
PUT
Microsoft.Compute
PUT https://management.azure.com/subscriptions/{subscriptionId}/resourceGroups/{resourcegroupname}/providers/Microsoft.Compute/virtualMachineScaleSets/{VMScaleSetName}?api-version=2021-04-01
PUT https://management.azure.com/subscriptions/{subscriptionId}/resourceGroups/{resourcegroupname}/providers/Microsoft.Compute/virtualMachineScaleSets/{VMScaleSetName}?api-version=2021-04-01
In the request body, include thecapacityReservationGroupproperty:
capacityReservationGroup
"location": "eastus",
"properties": {
    "virtualMachineProfile": {
         "capacityReservation": {
                  "capacityReservationGroup": {
                        "id": "/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Compute/capacityReservationGroups/{capacityReservationGroupName}"
                  }
            }
    }
}
"location": "eastus",
"properties": {
    "virtualMachineProfile": {
         "capacityReservation": {
                  "capacityReservationGroup": {
                        "id": "/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Compute/capacityReservationGroups/{capacityReservationGroupName}"
                  }
            }
    }
}
Deallocate the virtual machine scale set:az vmss deallocate 
--location eastus
--resource-group myResourceGroup 
--name myVMSS
Deallocate the virtual machine scale set:
az vmss deallocate 
--location eastus
--resource-group myResourceGroup 
--name myVMSS
az vmss deallocate 
--location eastus
--resource-group myResourceGroup 
--name myVMSS
Associate the scale set to the capacity reservation group:az vmss update 
--resource-group myResourceGroup 
--name myVMSS 
--capacity-reservation-group /subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Compute/capacityReservationGroups/{capacityReservationGroupName}
Associate the scale set to the capacity reservation group:
az vmss update 
--resource-group myResourceGroup 
--name myVMSS 
--capacity-reservation-group /subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Compute/capacityReservationGroups/{capacityReservationGroupName}
az vmss update 
--resource-group myResourceGroup 
--name myVMSS 
--capacity-reservation-group /subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Compute/capacityReservationGroups/{capacityReservationGroupName}
Deallocate the virtual machine scale set:Stop-AzVmss
-ResourceGroupName "myResourceGroupâ
-VMScaleSetName "myVmssâ
Deallocate the virtual machine scale set:
Stop-AzVmss
-ResourceGroupName "myResourceGroupâ
-VMScaleSetName "myVmssâ
Stop-AzVmss
-ResourceGroupName "myResourceGroupâ
-VMScaleSetName "myVmssâ
Associate the scale set to the capacity reservation group:$vmss =
Get-AzVmss
-ResourceGroupName "myResourceGroup"
-VMScaleSetName "myVmss"

Update-AzVmss
-ResourceGroupName "myResourceGroup"
-VMScaleSetName "myVmss"
-VirtualMachineScaleSet $vmss
-CapacityReservationGroupId "/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Compute/capacityReservationGroups/{capacityReservationGroupName}"
Associate the scale set to the capacity reservation group:
$vmss =
Get-AzVmss
-ResourceGroupName "myResourceGroup"
-VMScaleSetName "myVmss"

Update-AzVmss
-ResourceGroupName "myResourceGroup"
-VMScaleSetName "myVmss"
-VirtualMachineScaleSet $vmss
-CapacityReservationGroupId "/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Compute/capacityReservationGroups/{capacityReservationGroupName}"
$vmss =
Get-AzVmss
-ResourceGroupName "myResourceGroup"
-VMScaleSetName "myVmss"

Update-AzVmss
-ResourceGroupName "myResourceGroup"
-VMScaleSetName "myVmss"
-VirtualMachineScaleSet $vmss
-CapacityReservationGroupId "/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Compute/capacityReservationGroups/{capacityReservationGroupName}"
To learn more, see the Azure PowerShell commandsStop-AzVmss,Get-AzVmss, andUpdate-AzVmss.
View virtual machine scale set association with the Instance View
After the uniform virtual machine scale set is associated to the capacity reservation group, all the subsequent VM allocations will happen against the capacity reservation. Azure automatically finds the matching capacity reservation in the group and consumes a reserved slot.
API
CLI
PowerShell
Portal
The capacity reservation group Instance View reflects the new scale set VMs under thevirtualMachinesAssociatedandvirtualMachinesAllocatedproperties:
virtualMachinesAssociated
virtualMachinesAllocated
GET https://management.azure.com/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Compute/CapacityReservationGroups/{CapacityReservationGroupName}?$expand=instanceview&api-version=2021-04-01
GET https://management.azure.com/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Compute/CapacityReservationGroups/{CapacityReservationGroupName}?$expand=instanceview&api-version=2021-04-01
{ 
â¯â¯â¯â¯"name":â¯"<CapacityReservationGroupName>", 
â¯â¯â¯â¯"id":â¯"/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Compute/capacityReservationGroups/{CapacityReservationGroupName}", 
â¯â¯â¯â¯"type":â¯"Microsoft.Compute/capacityReservationGroups", 
â¯â¯â¯â¯"location":â¯"eastus" 
}, 
    "properties":â¯{ 
â¯â¯â¯â¯â¯â¯â¯â¯"capacityReservations":â¯[ 
â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯{ 
â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯"id":â¯"/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Compute/capacityReservationGroups/{CapacityReservationGroupName}/capacityReservations/{CapacityReservationName}" 
â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯} 
â¯â¯â¯â¯â¯â¯â¯â¯], 
â¯â¯â¯â¯â¯â¯â¯â¯"virtualMachinesAssociated":â¯[ 
â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯{ 
â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯"id":â¯"/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Compute/virtualMachineScaleSets/{VMScaleSetName}/virtualMachines/{VirtualMachineId}" 
â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯} 
â¯â¯â¯â¯â¯â¯â¯â¯], 
â¯â¯â¯â¯â¯â¯â¯â¯"instanceView":â¯{ 
â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯"capacityReservations":â¯[ 
â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯{ 
â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯"name":â¯"<CapacityReservationName>", 
â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯"utilizationInfo":â¯{ 
                        "virtualMachinesAllocated":â¯[ 
                â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯{ 
                â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯"id":â¯"/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Compute/virtualMachineScaleSets/{VMScaleSetName}/virtualMachines/{VirtualMachineId}" 
        â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯        } 
                        ] 
                    },
                    "statuses":â¯[ 
â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯{ 
â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯"code":â¯"ProvisioningState/succeeded", 
â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯"level":â¯"Info", 
â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯"displayStatus":â¯"Provisioningâ¯succeeded", 
â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯"time":â¯"2021-05-25T15:12:10.4165243+00:00" 
â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯} 
â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯] 
â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯} 
â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯] 
â¯â¯â¯â¯â¯â¯â¯â¯} 
â¯â¯â¯â¯} 
}
{ 
â¯â¯â¯â¯"name":â¯"<CapacityReservationGroupName>", 
â¯â¯â¯â¯"id":â¯"/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Compute/capacityReservationGroups/{CapacityReservationGroupName}", 
â¯â¯â¯â¯"type":â¯"Microsoft.Compute/capacityReservationGroups", 
â¯â¯â¯â¯"location":â¯"eastus" 
}, 
    "properties":â¯{ 
â¯â¯â¯â¯â¯â¯â¯â¯"capacityReservations":â¯[ 
â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯{ 
â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯"id":â¯"/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Compute/capacityReservationGroups/{CapacityReservationGroupName}/capacityReservations/{CapacityReservationName}" 
â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯} 
â¯â¯â¯â¯â¯â¯â¯â¯], 
â¯â¯â¯â¯â¯â¯â¯â¯"virtualMachinesAssociated":â¯[ 
â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯{ 
â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯"id":â¯"/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Compute/virtualMachineScaleSets/{VMScaleSetName}/virtualMachines/{VirtualMachineId}" 
â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯} 
â¯â¯â¯â¯â¯â¯â¯â¯], 
â¯â¯â¯â¯â¯â¯â¯â¯"instanceView":â¯{ 
â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯"capacityReservations":â¯[ 
â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯{ 
â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯"name":â¯"<CapacityReservationName>", 
â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯"utilizationInfo":â¯{ 
                        "virtualMachinesAllocated":â¯[ 
                â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯{ 
                â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯"id":â¯"/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Compute/virtualMachineScaleSets/{VMScaleSetName}/virtualMachines/{VirtualMachineId}" 
        â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯        } 
                        ] 
                    },
                    "statuses":â¯[ 
â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯{ 
â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯"code":â¯"ProvisioningState/succeeded", 
â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯"level":â¯"Info", 
â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯"displayStatus":â¯"Provisioningâ¯succeeded", 
â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯"time":â¯"2021-05-25T15:12:10.4165243+00:00" 
â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯} 
â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯] 
â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯} 
â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯] 
â¯â¯â¯â¯â¯â¯â¯â¯} 
â¯â¯â¯â¯} 
}
az capacity reservation group show 
-g myResourceGroup
-n myCapacityReservationGroup
az capacity reservation group show 
-g myResourceGroup
-n myCapacityReservationGroup
View the association of your virtual machine scale set and capacity reservation group by using Instance View in PowerShell.
$CapRes=
Get-AzCapacityReservationGroup
-ResourceGroupName <"ResourceGroupName">
-Name <"CapacityReservationGroupName">
-InstanceView

$CapRes.InstanceView.Utilizationinfo.VirtualMachinesAllocated
$CapRes=
Get-AzCapacityReservationGroup
-ResourceGroupName <"ResourceGroupName">
-Name <"CapacityReservationGroupName">
-InstanceView

$CapRes.InstanceView.Utilizationinfo.VirtualMachinesAllocated
To learn more, see the Azure PowerShell commandGet-AzCapacityReservationGroup.
OpenAzure portal.
Go to your capacity reservation group.
UnderSetting, selectResources.
In the table, you can see all the scale set VMs that are associated to the capacity reservation group.
Region and availability zone considerations
You can create virtual machine scale sets regionally or in one or more availability zones to help protect them from datacenter-level failure. To learn more about multizonal virtual machine scale sets, seeVirtual machine scale sets that use availability zones.
Important
The location (region and availability zones) of the virtual machine scale set and the capacity reservation group must match for the association to succeed. For a regional scale set, the region must match between the scale set and the capacity reservation group. For a zonal scale set, both the regions and the zones must match between the scale set and the capacity reservation group.
When a scale set is spread across multiple zones, it always attempts to deploy evenly across the included availability zones. Because of that even deployment, a capacity reservation group should always have the same quantity of reserved VMs in each zone. As an illustration of why this even deployment is important, consider the following example.
In this example, each zone has a different quantity reserved. Let's say that the virtual machine scale set scales out to 75 instances. Because a scale set always attempts to deploy evenly across zones, the VM distribution should look like this example:
In this case, the scale set incurs extra cost for 15 unused instances in Zone 1. The scale-out is also relying on 5 VMs in Zone 2 and 10 VMs in Zone 3 that aren't protected by capacity reservation. If each zone had 25 capacity instances reserved, then all 75 VMs would be protected by capacity reservation and the deployment wouldn't incur any extra cost for unused instances.
Because the reservations can be overallocated, the scale set can continue to scale normally beyond the limits of the reservation. The only difference is that the VMs allocated above the quantity reserved aren't covered by capacity reservation service-level agreement. To learn more, seeOverallocate capacity reservation.
Next step
Learn how to remove a scale set association from a capacity reservation
Feedback
Was this page helpful?
Additional resources