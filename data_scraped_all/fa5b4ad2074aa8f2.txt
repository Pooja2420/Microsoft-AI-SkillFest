Note
Access to this page requires authorization. You can trysigning inorchanging directories.
Access to this page requires authorization. You can trychanging directories.
Back up Azure Local virtual machines with Azure Backup Server
Article
2025-03-06
7 contributors
In this article
This article describes how to back up virtual machines running on Azure Local, versions23 H2and22 H2, using Microsoft Azure Backup Server (MABS).
Supported scenarios
MABS can back up Azure Local virtual machines in the following scenarios:
Azure Local Host: Back up and recover System State/BMR of the Azure Local host. The MABS protection agent must be installed on the host.
Azure Local Host: Back up and recover System State/BMR of the Azure Local host. The MABS protection agent must be installed on the host.
Virtual machines in cluster with local or direct storage: Back up guest virtual machines in a cluster that has local or directly attached storage. For example, a hard drive, a storage area network (SAN) device, or a network attached storage (NAS) device.
Virtual machines in cluster with local or direct storage: Back up guest virtual machines in a cluster that has local or directly attached storage. For example, a hard drive, a storage area network (SAN) device, or a network attached storage (NAS) device.
Virtual machines in a cluster with CSV storage: Back up guest virtual machines hosted on an Azure Local instance with Cluster Shared Volume (CSV) storage. The MABS protection agent is installed on each cluster node.
Virtual machines in a cluster with CSV storage: Back up guest virtual machines hosted on an Azure Local instance with Cluster Shared Volume (CSV) storage. The MABS protection agent is installed on each cluster node.
VM Move within a cluster: When VMs are moved within a stretched/normal cluster, MABS continues to protect the virtual machines as long as the MABS protection agent is installed on the Azure Local host. The way in which MABS protects the virtual machines depends on the type of live migration involved. With a VM Move within a cluster, MABS detects the migration, and backs up the virtual machine from the new cluster node without any requirement for user intervention. Because the storage location hasn't changed, MABS continues with express full backups.
VM Move within a cluster: When VMs are moved within a stretched/normal cluster, MABS continues to protect the virtual machines as long as the MABS protection agent is installed on the Azure Local host. The way in which MABS protects the virtual machines depends on the type of live migration involved. With a VM Move within a cluster, MABS detects the migration, and backs up the virtual machine from the new cluster node without any requirement for user intervention. Because the storage location hasn't changed, MABS continues with express full backups.
VM Move to a different stretched/normal cluster: VM Move to a different stretched/normal cluster is not supported.
VM Move to a different stretched/normal cluster: VM Move to a different stretched/normal cluster is not supported.
Arc VMs:Arc VMsadd fabric management capabilities in addition toArc-enabled servers. These allowIT adminsto create, modify, delete, and assign permissions and roles toapp owners, thereby enablingself-service VM management. Recovery of Arc VMs is supported in a limited capacity in Azure Local.The following table lists the various levels of backup and restore capabilities for Azure Arc VMs:Protection levelRecovery locationDescriptionGuest-level backups and recovery(which require an agent in the guest OS)Work as expected.Host-level backupsWork as expected.Host-level recoveryRecovery to the original VM instanceRecovery to the original VMs works as expected.Alternate location recovery (ALR)Recovery to the ALR is supported in a limited way as the ALR recovers to a Hyper-V VM. Currently, conversion of Hyper-V VM to an Arc VM isn't supported.
Arc VMs:Arc VMsadd fabric management capabilities in addition toArc-enabled servers. These allowIT adminsto create, modify, delete, and assign permissions and roles toapp owners, thereby enablingself-service VM management. Recovery of Arc VMs is supported in a limited capacity in Azure Local.
The following table lists the various levels of backup and restore capabilities for Azure Arc VMs:
Learn more about thesupported scenarios for MABS V3 UR2 and later.
Host versus guest backup
MABS can do a host or guest-level backup of VMs on Azure Local. At the host level, the MABS protection agent is installed on the Azure Local host machine or cluster and protects the entire VMs and data files running on that host.   At the guest level, the agent is installed on each virtual machine and protects the workload present on that machine.
Both methods have pros and cons:
Host-level backups are flexible because they work regardless of the type of OS running on the guest machines and don't require the installation of the MABS protection agent on each VM. If you deploy host level backup, you can recover an entire virtual machine, or files and folders (item-level recovery).
Host-level backups are flexible because they work regardless of the type of OS running on the guest machines and don't require the installation of the MABS protection agent on each VM. If you deploy host level backup, you can recover an entire virtual machine, or files and folders (item-level recovery).
Guest-level backup is useful if you want to protect specific workloads running on a virtual machine. At host-level you can recover an entire VM or specific files, but it won't provide recovery in the context of a specific application. For example, to recover specific SharePoint items from a backed-up VM, you should do guest-level backup of that VM. Use guest-level backup if you want to protect data stored on passthrough disks. Passthrough allows the virtual machine to directly access the storage device and doesn't store virtual volume data in a VHD file.NotePassthrough disksaren't supported in Azure Local.
Guest-level backup is useful if you want to protect specific workloads running on a virtual machine. At host-level you can recover an entire VM or specific files, but it won't provide recovery in the context of a specific application. For example, to recover specific SharePoint items from a backed-up VM, you should do guest-level backup of that VM. Use guest-level backup if you want to protect data stored on passthrough disks. Passthrough allows the virtual machine to directly access the storage device and doesn't store virtual volume data in a VHD file.
Note
Passthrough disksaren't supported in Azure Local.
Backup prerequisites
These are the prerequisites for backing up virtual machines with MABS:
If you want to perform item-level recovery for virtual machines (recover files, folders, volumes), then you'll need to install the  Hyper-V role on the MABS server. If you only want to recover the virtual machine and not item-level, then the role isn't required.
You can protect up to 800 virtual machines of 100 GB each on one MABS server and allow multiple MABS servers that support larger clusters.
MABS excludes the page file from incremental backups to improve virtual machine backup performance.
MABS can back up a  server or cluster in the same domain as the MABS server, or in a child or trusted domain. If you want to back up VMs in a workgroup or an untrusted domain, you'll need to set up authentication. For a single  server, you can use NTLM or certificate authentication. For a cluster, you can use certificate authentication only.
Using host-level backup to back up virtual machine data on passthrough disks isn't supported. In this scenario, we recommend you use host-level backup to back up VHD files and guest-level backup to back up the other data that isn't visible on the host.
You can back up VMs stored on deduplicated volumes.
The version of Integration Components that's running on the virtual machine should be the same as the version of the Azure Local host.
For each virtual machine backup you'll need free space on the volume hosting the virtual hard disk files to allow  enough room for differencing disks (AVHDs) during backup. The space must be at least equal to the calculation Initial disk sizeChurn rateBackup window time. If you're running multiple backups on a cluster, you'll need enough storage capacity to accommodate the AVHDs for each of the virtual machines using this calculation.
You can back up Linux virtual machines using MABS. Only file-consistent snapshots are supported.
Back up virtual machines
Set up yourMABS serverandyour storage. When setting up your storage, use these storage capacity guidelines.Average virtual machine size - 100 GBNumber of virtual machines per MABS server - 800Total size of 800 VMs - 80 TBRequired space for backup storage - 80 TB
Set up yourMABS serverandyour storage. When setting up your storage, use these storage capacity guidelines.
Average virtual machine size - 100 GB
Number of virtual machines per MABS server - 800
Total size of 800 VMs - 80 TB
Required space for backup storage - 80 TB
Set up the MABS protection agent on the server or each cluster node.NoteIfAzure Benefitsis enabled on the Azure VM, disable the Firewall ruleAzsHci-ImdsAttestation-Block-TCP-Into allow theAgent WMI Queries. To disable the Firewall, run the following cmdlet from PowerShell prompt on each node of the cluster:Get-ClusterNode | % {$session = New-PsSession -ComputerName $_ ; Invoke-Command -Session $session -ScriptBlock {$env:COMPUTERNAME ; Disable-NetFirewallRule AzsHci-ImdsAttestation-Block-TCP-In }}
Set up the MABS protection agent on the server or each cluster node.
Note
IfAzure Benefitsis enabled on the Azure VM, disable the Firewall ruleAzsHci-ImdsAttestation-Block-TCP-Into allow theAgent WMI Queries. To disable the Firewall, run the following cmdlet from PowerShell prompt on each node of the cluster:
AzsHci-ImdsAttestation-Block-TCP-In
Get-ClusterNode | % {$session = New-PsSession -ComputerName $_ ; Invoke-Command -Session $session -ScriptBlock {$env:COMPUTERNAME ; Disable-NetFirewallRule AzsHci-ImdsAttestation-Block-TCP-In }}
Get-ClusterNode | % {$session = New-PsSession -ComputerName $_ ; Invoke-Command -Session $session -ScriptBlock {$env:COMPUTERNAME ; Disable-NetFirewallRule AzsHci-ImdsAttestation-Block-TCP-In }}
To deploy the agent, choose one of the following methods:Attach agents: Select an agent that's already installed.Install agent: If you don't have the agent installed:To install the agent on each cluster node, run the following command:Install DPMAgentInstaller.exe`After the installation is complete, run the following command to configure the agent on the node:.\SetDpmServer.exe -dpmServerName winvm01To add the agent to the MABS server, selectAttach agent.
To deploy the agent, choose one of the following methods:
Attach agents: Select an agent that's already installed.
Install agent: If you don't have the agent installed:To install the agent on each cluster node, run the following command:Install DPMAgentInstaller.exe`After the installation is complete, run the following command to configure the agent on the node:.\SetDpmServer.exe -dpmServerName winvm01To add the agent to the MABS server, selectAttach agent.
To install the agent on each cluster node, run the following command:Install DPMAgentInstaller.exe`
To install the agent on each cluster node, run the following command:
Install DPMAgentInstaller.exe`
Install DPMAgentInstaller.exe`
After the installation is complete, run the following command to configure the agent on the node:.\SetDpmServer.exe -dpmServerName winvm01
After the installation is complete, run the following command to configure the agent on the node:
.\SetDpmServer.exe -dpmServerName winvm01
.\SetDpmServer.exe -dpmServerName winvm01
To add the agent to the MABS server, selectAttach agent.
To add the agent to the MABS server, selectAttach agent.

On  the MABS Administrator console, selectProtection>Create protection groupto open theCreate New Protection Groupwizard.
On  the MABS Administrator console, selectProtection>Create protection groupto open theCreate New Protection Groupwizard.
On theSelect Group Memberspage, select the VMs you want to protect from the host servers on which they're located. We recommend that you put all VMs that will have the same protection policy into one protection group. To make efficient use of space, enable colocation. Colocation allows you to locate data from different protection groups on the same disk or tape storage, so that multiple data sources have a single replica and recovery point volume.During VM selection, you can choose one of the following VM type:Hyper-v VMs: Select this VM type from the individual node.Clustered HA VMs: Select this VM type from the cluster.
On theSelect Group Memberspage, select the VMs you want to protect from the host servers on which they're located. We recommend that you put all VMs that will have the same protection policy into one protection group. To make efficient use of space, enable colocation. Colocation allows you to locate data from different protection groups on the same disk or tape storage, so that multiple data sources have a single replica and recovery point volume.
During VM selection, you can choose one of the following VM type:
Hyper-v VMs: Select this VM type from the individual node.
Hyper-v VMs: Select this VM type from the individual node.

Clustered HA VMs: Select this VM type from the cluster.
Clustered HA VMs: Select this VM type from the cluster.

On theSelect Data Protection Methodpage, specify a protection group name. SelectI want short-term protection using Diskand selectI want online protectionif you want to back up data to Azure using the Azure Backup service.
On theSelect Data Protection Methodpage, specify a protection group name. SelectI want short-term protection using Diskand selectI want online protectionif you want to back up data to Azure using the Azure Backup service.
OnSpecify Short-Term Goals>Retention range, specify how long you want to retain disk data. InSynchronization frequency, specify how often incremental backups of the data should run. Alternatively, instead of selecting an interval for incremental backups you can enableJust before a recovery point. With this setting enabled, MABS will run an express full backup just before each scheduled recovery point.NoteIf you're protecting application workloads, recovery points are created in accordance with Synchronization frequency, provided the application supports incremental backups. If it doesn't, then MABS runs an express full backup, instead of an incremental backup, and creates recovery points in accordance with the express backup schedule.The backup process doesn't back up the checkpoints associated with VMs.
OnSpecify Short-Term Goals>Retention range, specify how long you want to retain disk data. InSynchronization frequency, specify how often incremental backups of the data should run. Alternatively, instead of selecting an interval for incremental backups you can enableJust before a recovery point. With this setting enabled, MABS will run an express full backup just before each scheduled recovery point.
Note
If you're protecting application workloads, recovery points are created in accordance with Synchronization frequency, provided the application supports incremental backups. If it doesn't, then MABS runs an express full backup, instead of an incremental backup, and creates recovery points in accordance with the express backup schedule.The backup process doesn't back up the checkpoints associated with VMs.
In theReview disk allocationpage, review the storage pool disk space allocated for the protection group.Total Data sizeis the size of the data you want to back up, andDisk space to be provisioned on MABSis the space that MABS recommends for the protection group. MABS chooses the ideal backup volume, based on the settings. However, you can edit the backup volume choices in theDisk allocation details. For the workloads, select the preferred storage in the dropdown menu. Your edits change the values forTotal StorageandFree Storagein theAvailable Disk Storagepane. Underprovisioned space is the amount of storage MABS suggests you add to the volume, to continue with backups smoothly in the future.
In theReview disk allocationpage, review the storage pool disk space allocated for the protection group.
Total Data sizeis the size of the data you want to back up, andDisk space to be provisioned on MABSis the space that MABS recommends for the protection group. MABS chooses the ideal backup volume, based on the settings. However, you can edit the backup volume choices in theDisk allocation details. For the workloads, select the preferred storage in the dropdown menu. Your edits change the values forTotal StorageandFree Storagein theAvailable Disk Storagepane. Underprovisioned space is the amount of storage MABS suggests you add to the volume, to continue with backups smoothly in the future.
On theChoose Replica Creation Methodpage, specify how the initial replication of data in the protection group will be performed. If you select toAutomatically replicate over the network, we recommended you choose an off-peak time. For large amounts of data or less than optimal network conditions, consider selectingManually, which requires replicating the data offline using removable media.
On theChoose Replica Creation Methodpage, specify how the initial replication of data in the protection group will be performed. If you select toAutomatically replicate over the network, we recommended you choose an off-peak time. For large amounts of data or less than optimal network conditions, consider selectingManually, which requires replicating the data offline using removable media.
On theConsistency Check Optionspage, select how you want to automate consistency checks. You can enable a check to run only when replica data becomes inconsistent, or according to a schedule. If you don't want to configure automatic consistency checking, you can run a manual check at any time by right-clicking the protection group and selectingPerform Consistency Check.After you create the protection group, initial replication of the data occurs in accordance with the method you selected. After initial replication, each backup takes place in line with the protection group settings. If you need to recover backed up data, note the following:
On theConsistency Check Optionspage, select how you want to automate consistency checks. You can enable a check to run only when replica data becomes inconsistent, or according to a schedule. If you don't want to configure automatic consistency checking, you can run a manual check at any time by right-clicking the protection group and selectingPerform Consistency Check.
After you create the protection group, initial replication of the data occurs in accordance with the method you selected. After initial replication, each backup takes place in line with the protection group settings. If you need to recover backed up data, note the following:
Back up replica virtual machines
If MABS is running on Windows Server 2012 R2 or later, then you can back up replica virtual machines. This is useful for several reasons:
Reduces the impact of backups on the running workload- Taking a backup of a virtual machine incurs some overhead as a snapshot is created. When you offload the backup process to a secondary remote site, the running workload is no longer affected by the backup operation. This is applicable only to deployments where the backup copy is stored on a remote site. For example, you might take daily backups and store data locally to ensure quick restore times, but take monthly or quarterly backups from replica virtual machines stored remotely for long-term retention.
Saves bandwidth- In a typical remote branch office/headquarters deployment you need an appropriate amount of provisioned bandwidth to transfer backup data between sites. If you create a replication and failover strategy, in addition to your data backup strategy, you can reduce the amount of redundant data sent over the network. By backing up the replica virtual machine data rather than the primary, you save the overhead of sending the backed-up data over the network.
Enables hoster backup- You can use a hosted datacenter as a replica site, with no need for a secondary datacenter. In this case, the hoster SLA requires consistent backup of replica virtual machines.
A replica virtual machine is turned off until a failover is initiated, and VSS can't guarantee an application-consistent backup for a replica virtual machine. So the backup of a replica virtual machine will be crash-consistent only. If crash-consistency can't be guaranteed, then the backup will fail and this might occur in a number of conditions:
The replica virtual machine isn't healthy and is in a critical state.
The replica virtual machine isn't healthy and is in a critical state.
The replica virtual machine is resynchronizing (in the Resynchronization in Progress or Resynchronization Required state).
The replica virtual machine is resynchronizing (in the Resynchronization in Progress or Resynchronization Required state).
Initial replication between the primary and secondary site is in progress or pending for the virtual machine.
Initial replication between the primary and secondary site is in progress or pending for the virtual machine.
.hrl logs are being applied to the replica virtual machine, or a previous action to apply the .hrl logs on the virtual disk failed, or was canceled or interrupted.
.hrl logs are being applied to the replica virtual machine, or a previous action to apply the .hrl logs on the virtual disk failed, or was canceled or interrupted.
Migration or failover of the replica virtual machine is in progress.
Migration or failover of the replica virtual machine is in progress.
Recover backed up virtual machines
When you can recover a backed up virtual machine, you use the Recovery wizard to select the virtual machine and the specific recovery point. To open the Recovery Wizard and recover a virtual machine:
In the MABS Administrator console, type the name of the VM, or expand the list of protected items, navigate toAll Protected HyperV Data, and select the VM you want to recover.NoteAll the Clustered HA VMs are recovered by selecting these Virtual machines under the cluster.Both Hyper-V and Clustered VMs are restored as Hyper-V Virtual Machines.
In the MABS Administrator console, type the name of the VM, or expand the list of protected items, navigate toAll Protected HyperV Data, and select the VM you want to recover.
Note
All the Clustered HA VMs are recovered by selecting these Virtual machines under the cluster.
Both Hyper-V and Clustered VMs are restored as Hyper-V Virtual Machines.
In theRecovery points forpane, on the calendar, select any date to see the recovery points available. Then in thePathpane, select the recovery point you want to use in the Recovery wizard.
In theRecovery points forpane, on the calendar, select any date to see the recovery points available. Then in thePathpane, select the recovery point you want to use in the Recovery wizard.
From theActionsmenu, selectRecoverto open the Recovery Wizard.The VM and recovery point you selected appear in theReview Recovery Selectionscreen. SelectNext.
From theActionsmenu, selectRecoverto open the Recovery Wizard.
The VM and recovery point you selected appear in theReview Recovery Selectionscreen. SelectNext.
In theSelect Recovery Typescreen, select where you want to restore the data and then selectNext.Recover to original instance: When you recover to the original instance, the original VHD and all associated checkpoints are deleted. MABS recovers the VHD and other configuration files to the original location using Hyper-V VSS writer. At the end of the recovery process, virtual machines are still highly available.
The resource group must be present for recovery. If it isn't available, recover to an alternate location and then make the virtual machine highly available.Recover as virtual machine to any host: MABS supports alternate location recovery (ALR), which provides a seamless recovery of a protected Azure Local virtual machine to a different host within the same cluster,  independent of processor architecture. Azure Local virtual machines that are recovered to a cluster node won't be highly available. If you choose this option, the Recovery Wizard presents you with an additional screen for identifying the destination and destination path.NoteThere's limited support for Alternate location recovery (ALR) for Arc VMs. The VM is recovered as a Hyper-V VM, instead of an Arc VM. Currently, conversion of Hyper-V VMs to Arc VMs isn't supported once you create them.If you select the original host, the behavior is the same asRecover to original instance. The original VHD and all associated checkpoints will be deleted.Copy to a network folder: MABS supports item-level recovery (ILR), which allows you to do item-level recovery of files, folders, volumes, and virtual hard disks (VHDs) from a host-level backup of  Azure Local virtual machines to a network share or a volume on a MABS protected server. The MABS protection agent doesn't have to be installed inside the guest to perform item-level recovery. If you choose this option, the Recovery Wizard presents you with an additional screen for identifying the destination and destination path.
In theSelect Recovery Typescreen, select where you want to restore the data and then selectNext.
Recover to original instance: When you recover to the original instance, the original VHD and all associated checkpoints are deleted. MABS recovers the VHD and other configuration files to the original location using Hyper-V VSS writer. At the end of the recovery process, virtual machines are still highly available.
The resource group must be present for recovery. If it isn't available, recover to an alternate location and then make the virtual machine highly available.
Recover to original instance: When you recover to the original instance, the original VHD and all associated checkpoints are deleted. MABS recovers the VHD and other configuration files to the original location using Hyper-V VSS writer. At the end of the recovery process, virtual machines are still highly available.
The resource group must be present for recovery. If it isn't available, recover to an alternate location and then make the virtual machine highly available.
Recover as virtual machine to any host: MABS supports alternate location recovery (ALR), which provides a seamless recovery of a protected Azure Local virtual machine to a different host within the same cluster,  independent of processor architecture. Azure Local virtual machines that are recovered to a cluster node won't be highly available. If you choose this option, the Recovery Wizard presents you with an additional screen for identifying the destination and destination path.NoteThere's limited support for Alternate location recovery (ALR) for Arc VMs. The VM is recovered as a Hyper-V VM, instead of an Arc VM. Currently, conversion of Hyper-V VMs to Arc VMs isn't supported once you create them.If you select the original host, the behavior is the same asRecover to original instance. The original VHD and all associated checkpoints will be deleted.
Recover as virtual machine to any host: MABS supports alternate location recovery (ALR), which provides a seamless recovery of a protected Azure Local virtual machine to a different host within the same cluster,  independent of processor architecture. Azure Local virtual machines that are recovered to a cluster node won't be highly available. If you choose this option, the Recovery Wizard presents you with an additional screen for identifying the destination and destination path.
Note
There's limited support for Alternate location recovery (ALR) for Arc VMs. The VM is recovered as a Hyper-V VM, instead of an Arc VM. Currently, conversion of Hyper-V VMs to Arc VMs isn't supported once you create them.
If you select the original host, the behavior is the same asRecover to original instance. The original VHD and all associated checkpoints will be deleted.
Copy to a network folder: MABS supports item-level recovery (ILR), which allows you to do item-level recovery of files, folders, volumes, and virtual hard disks (VHDs) from a host-level backup of  Azure Local virtual machines to a network share or a volume on a MABS protected server. The MABS protection agent doesn't have to be installed inside the guest to perform item-level recovery. If you choose this option, the Recovery Wizard presents you with an additional screen for identifying the destination and destination path.
Copy to a network folder: MABS supports item-level recovery (ILR), which allows you to do item-level recovery of files, folders, volumes, and virtual hard disks (VHDs) from a host-level backup of  Azure Local virtual machines to a network share or a volume on a MABS protected server. The MABS protection agent doesn't have to be installed inside the guest to perform item-level recovery. If you choose this option, the Recovery Wizard presents you with an additional screen for identifying the destination and destination path.
InSpecify Recovery Options, configure the recovery options and selectNext:If you are recovering a VM over low bandwidth, selectModifyto enableNetwork bandwidth usage throttling. After turning on the throttling option, you can specify the amount of bandwidth you want to make available and the time when that bandwidth is available.SelectEnable SAN based recovery using hardware snapshotsif you've configured your network.SelectSend an e-mail when the recovery completesand then provide the email addresses, if you want email notifications sent once the recovery process completes.
InSpecify Recovery Options, configure the recovery options and selectNext:
If you are recovering a VM over low bandwidth, selectModifyto enableNetwork bandwidth usage throttling. After turning on the throttling option, you can specify the amount of bandwidth you want to make available and the time when that bandwidth is available.
SelectEnable SAN based recovery using hardware snapshotsif you've configured your network.
SelectSend an e-mail when the recovery completesand then provide the email addresses, if you want email notifications sent once the recovery process completes.
In the Summary screen, make sure all details are correct. If the details aren't correct, or you want to make a change, selectBack. If you're satisfied with the settings, selectRecoverto start the recovery process.
In the Summary screen, make sure all details are correct. If the details aren't correct, or you want to make a change, selectBack. If you're satisfied with the settings, selectRecoverto start the recovery process.
TheRecovery Statusscreen provides information about the recovery job.
TheRecovery Statusscreen provides information about the recovery job.
Next steps
Recover data from Azure Backup Server
Feedback
Was this page helpful?
Additional resources