Note
Access to this page requires authorization. You can trysigning inorchanging directories.
Access to this page requires authorization. You can trychanging directories.
API Management policy expressions
Article
2023-03-14
21 contributors
In this article
APPLIES TO: All API Management tiers
This article discusses policy expressions syntax in C# 7. Each expression has access to:
The implicitly providedcontextvariable.
An allowedsubsetof .NET Framework types.
Syntax
Single statement expressions:Enclosed in@(expression), whereexpressionis a well-formed C# expression statement.
Enclosed in@(expression), whereexpressionis a well-formed C# expression statement.
@(expression)
expression
Multi-statement expressions:Enclosed in@{expression}.All code paths within multi-statement expressions must end with areturnstatement.
Enclosed in@{expression}.
@{expression}
All code paths within multi-statement expressions must end with areturnstatement.
return
Examples
@(true)

@((1+1).ToString())

@("Hi There".Length)

@(Regex.Match(context.Response.Headers.GetValueOrDefault("Cache-Control",""), @"max-age=(?<maxAge>\d+)").Groups["maxAge"]?.Value)

@(context.Variables.ContainsKey("maxAge") ? int.Parse((string)context.Variables["maxAge"]) : 3600)

@{
  string[] value;
  if (context.Request.Headers.TryGetValue("Authorization", out value))
  {
      if(value != null && value.Length > 0)
      {
          return Encoding.UTF8.GetString(Convert.FromBase64String(value[0]));
      }
  }
  return null;

}
@(true)

@((1+1).ToString())

@("Hi There".Length)

@(Regex.Match(context.Response.Headers.GetValueOrDefault("Cache-Control",""), @"max-age=(?<maxAge>\d+)").Groups["maxAge"]?.Value)

@(context.Variables.ContainsKey("maxAge") ? int.Parse((string)context.Variables["maxAge"]) : 3600)

@{
  string[] value;
  if (context.Request.Headers.TryGetValue("Authorization", out value))
  {
      if(value != null && value.Length > 0)
      {
          return Encoding.UTF8.GetString(Convert.FromBase64String(value[0]));
      }
  }
  return null;

}
Usage
Unless the policy reference specifies otherwise, expressions can be used as attribute values or text values in any API Managementpolicy.
Important
When the policy is defined, policy expressions only have limited verification. Expressions are executed by the gateway at run-time. Any exceptions generated by policy expressions result in a runtime error.
.NET Framework types allowed in policy expressions
The following table lists the .NET Framework types and members allowed in policy expressions.
Newtonsoft.Json.Formatting
Newtonsoft.Json.JsonConvert
SerializeObject
DeserializeObject
Newtonsoft.Json.Linq.Extensions
Newtonsoft.Json.Linq.JArray
Newtonsoft.Json.Linq.JConstructor
Newtonsoft.Json.Linq.JContainer
Newtonsoft.Json.Linq.JObject
Newtonsoft.Json.Linq.JProperty
Newtonsoft.Json.Linq.JRaw
Newtonsoft.Json.Linq.JToken
Newtonsoft.Json.Linq.JTokenType
Newtonsoft.Json.Linq.JValue
System.Array
System.BitConverter
System.Boolean
System.Byte
System.Char
System.Collections.Generic.Dictionary<TKey, TValue>
System.Collections.Generic.HashSet<T>
System.Collections.Generic.ICollection<T>
System.Collections.Generic.IDictionary<TKey, TValue>
System.Collections.Generic.IEnumerable<T>
System.Collections.Generic.IEnumerator<T>
System.Collections.Generic.IList<T>
System.Collections.Generic.IReadOnlyCollection<T>
System.Collections.Generic.IReadOnlyDictionary<TKey, TValue>
System.Collections.Generic.ISet<T>
System.Collections.Generic.KeyValuePair<TKey, TValue>
System.Collections.Generic.List<T>
System.Collections.Generic.Queue<T>
System.Collections.Generic.Stack<T>
System.Convert
System.DateTime
Add
AddDays
AddHours
AddMilliseconds
AddMinutes
AddMonths
AddSeconds
AddTicks
AddYears
Date
Day
DayOfWeek
DayOfYear
DaysInMonth
Hour
IsDaylightSavingTime
IsLeapYear
MaxValue
Millisecond
Minute
MinValue
Month
Now
Parse
Second
Subtract
Ticks
TimeOfDay
Today
ToString
UtcNow
Year
System.DateTimeKind
Utc
System.DateTimeOffset
System.Decimal
System.Double
System.Enum
Parse
TryParse
ToString
System.Exception
System.Guid
System.Int16
System.Int32
System.Int64
System.IO.StringReader
System.IO.StringWriter
System.Linq.Enumerable
System.Math
System.MidpointRounding
System.Net.IPAddress
AddressFamily
Equals
GetAddressBytes
IsLoopback
Parse
TryParse
ToString
System.Net.WebUtility
System.Nullable
System.Random
System.SByte
System.Security.Cryptography.AsymmetricAlgorithm
System.Security.Cryptography.CipherMode
System.Security.Cryptography.HashAlgorithm
System.Security.Cryptography.HashAlgorithmName
System.Security.Cryptography.HMAC
System.Security.Cryptography.HMACMD5
System.Security.Cryptography.HMACSHA1
System.Security.Cryptography.HMACSHA256
System.Security.Cryptography.HMACSHA384
System.Security.Cryptography.HMACSHA512
System.Security.Cryptography.KeyedHashAlgorithm
System.Security.Cryptography.MD5
System.Security.Cryptography.Oid
System.Security.Cryptography.PaddingMode
System.Security.Cryptography.RNGCryptoServiceProvider
System.Security.Cryptography.RSA
System.Security.Cryptography.RSAEncryptionPadding
System.Security.Cryptography.RSASignaturePadding
System.Security.Cryptography.SHA1
System.Security.Cryptography.SHA1Managed
System.Security.Cryptography.SHA256
System.Security.Cryptography.SHA256Managed
System.Security.Cryptography.SHA384
System.Security.Cryptography.SHA384Managed
System.Security.Cryptography.SHA512
System.Security.Cryptography.SHA512Managed
System.Security.Cryptography.SymmetricAlgorithm
System.Security.Cryptography.X509Certificates.PublicKey
System.Security.Cryptography.X509Certificates.RSACertificateExtensions
System.Security.Cryptography.X509Certificates.X500DistinguishedName
Name
System.Security.Cryptography.X509Certificates.X509Certificate
System.Security.Cryptography.X509Certificates.X509Certificate2
System.Security.Cryptography.X509Certificates.X509ContentType
System.Security.Cryptography.X509Certificates.X509NameType
System.Single
System.String
System.StringComparer
System.StringComparison
System.StringSplitOptions
System.Text.Encoding
System.Text.RegularExpressions.Capture
Index
Length
Value
System.Text.RegularExpressions.CaptureCollection
Count
Item
System.Text.RegularExpressions.Group
Captures
Success
System.Text.RegularExpressions.GroupCollection
Count
Item
System.Text.RegularExpressions.Match
Empty
Groups
Result
System.Text.RegularExpressions.Regex
IsMatch
Match
Matches
Replace
Unescape
Split
System.Text.RegularExpressions.RegexOptions
System.Text.StringBuilder
System.TimeSpan
System.TimeZone
System.TimeZoneInfo.AdjustmentRule
System.TimeZoneInfo.TransitionTime
System.TimeZoneInfo
System.Tuple
System.UInt16
System.UInt32
System.UInt64
System.Uri
System.UriPartial
System.Xml.Linq.Extensions
System.Xml.Linq.XAttribute
System.Xml.Linq.XCData
System.Xml.Linq.XComment
System.Xml.Linq.XContainer
System.Xml.Linq.XDeclaration
System.Xml.Linq.XDocument
Load
System.Xml.Linq.XDocumentType
System.Xml.Linq.XElement
System.Xml.Linq.XName
System.Xml.Linq.XNamespace
System.Xml.Linq.XNode
System.Xml.Linq.XNodeDocumentOrderComparer
System.Xml.Linq.XNodeEqualityComparer
System.Xml.Linq.XObject
System.Xml.Linq.XProcessingInstruction
System.Xml.Linq.XText
System.Xml.XmlNodeType
Context variable
Thecontextvariable is implicitly available in every policyexpression. Its members:
context
Provide information relevant to the APIrequestandresponse, and related properties.
Are all read-only.
context
Api
IApi
Deployment
TimeSpan
Timestamp
GraphQL
LastError
Operation
Request
RequestId
Guid
Response
Subscription
Timestamp
DateTime
Tracing
bool
Variables
IReadOnlyDictionary<string, object>
void Trace(message: string)
Workspace
context.Api
Id
string
IsCurrentRevision
bool
Name
string
Path
string
Revision
string
ServiceUrl
IUrl
Version
string
context.Deployment
Gateway
GatewayId
string
Region
string
ServiceId
string
ServiceName
string
Certificates
IReadOnlyDictionary<string, X509Certificate2>
context.Deployment.Gateway
Id
string
InstanceId
string
IsManaged
bool
context.GraphQL
GraphQLArguments
IGraphQLDataObject
Parent
IGraphQLDataObject
context.LastError
Source
string
Reason
string
Message
string
Scope
string
Section
string
Path
string
PolicyId
string
context.LastError
context.Operation
Id
string
Method
string
Name
string
UrlTemplate
string
context.Product
ApprovalRequired
bool
Groups
IEnumerable<
IGroup
>
Id
string
Name
string
State
enum ProductState {NotPublished, Published}
SubscriptionsLimit
int?
SubscriptionRequired
bool
context.Request
Body
IMessageBody
null
Certificate
System.Security.Cryptography.X509Certificates.X509Certificate2
Headers
IReadOnlyDictionary<string, string[]>
IpAddress
string
MatchedParameters
IReadOnlyDictionary<string, string>
Method
string
OriginalUrl
IUrl
Url
IUrl
PrivateEndpointConnection
IPrivateEndpointConnection
null
string context.Request.Headers.GetValueOrDefault(headerName: string, defaultValue: string)
headerName
string
defaultValue
string
defaultValue
context.Response
Body
IMessageBody
Headers
IReadOnlyDictionary<string, string[]>
StatusCode
int
StatusReason
string
string context.Response.Headers.GetValueOrDefault(headerName: string, defaultValue: string)
headerName
string
defaultValue
string
defaultValue
context.Subscription
CreatedDate
DateTime
EndDate
DateTime?
Id
string
Key
string
Name
string
PrimaryKey
string
SecondaryKey
string
StartDate
DateTime?
context.User
Email
string
FirstName
string
Groups
IEnumerable<
IGroup
>
Id
string
Identities
IEnumerable<
IUserIdentity
>
LastName
string
Note
string
RegistrationDate
DateTime
context.Workspace
Id
string
Name
string
IApi
Id
string
Name
string
Path
string
Protocols
IEnumerable<string>
ServiceUrl
IUrl
SubscriptionKeyParameterNames
ISubscriptionKeyParameterNames
IGraphQLDataObject
IGroup
Id
string
Name
string
IMessageBody
As<T>(bool preserveContent = false): Where T: string, byte[], JObject, JToken, JArray, XNode, XElement, XDocument
context.Request.Body.As<T>
context.Response.Body.As<T>
T
AsFormUrlEncodedContent(bool preserveContent = false)
context.Request.Body.AsFormUrlEncodedContent()
context.Response.Body.AsFormUrlEncodedContent()
IDictionary<string, IList<string>
IDictionary
ToQueryString()
JsonConvert.SerializeObject()
ToFormUrlEncodedContent().
As<T>
AsFormUrlEncodedContent()
Use the original message body stream.
Render it unavailable after it returns.
preserveContent
true
IPrivateEndpointConnection
Name
string
GroupId
string
MemberName
string
IUrl
Host
string
Path
string
Port
int
Query
IReadOnlyDictionary<string, string[]>
QueryString
string
Scheme
string
ISubscriptionKeyParameterNames
Header
string
Query
string
string IUrl.Query.GetValueOrDefault(queryParameterName: string, defaultValue: string)
queryParameterName
string
defaultValue
string
defaultValue
IUserIdentity
Id
string
Provider
string
T context.Variables.GetValueOrDefault<T>(variableName: string, defaultValue: T)
variableName
string
defaultValue
T
T
defaultValue
BasicAuthCredentials AsBasic(input: this string)
input
string
BasicAuthCredentials
bool TryParseBasic(input: this string, result: out BasicAuthCredentials)
input
string
result
out BasicAuthCredentials
true
BasicAuthCredentials
false
BasicAuthCredentials
Password
string
UserId
string
Jwt AsJwt(input: this string)
input
string
Jwt
null
bool TryParseJwt(input: this string, result: out Jwt)
input
string
result
out Jwt
true
Jwt
false
Jwt
Algorithm
string
Audiences
IEnumerable<string>
Claims
IReadOnlyDictionary<string, string[]>
ExpirationTime
DateTime?
Id
string
Issuer
string
IssuedAt
DateTime?
NotBefore
DateTime?
Subject
string
Type
string
string Jwt.Claims.GetValueOrDefault(claimName: string, defaultValue: string)
claimName
string
defaultValue
string
defaultValue
byte[] Encrypt(input: this byte[], alg: string, key:byte[], iv:byte[])
input
alg
key
iv
byte[] Encrypt(input: this byte[], alg: System.Security.Cryptography.SymmetricAlgorithm)
input
alg
byte[] Encrypt(input: this byte[], alg: System.Security.Cryptography.SymmetricAlgorithm, key:byte[], iv:byte[])
input
alg
key
iv
byte[] Decrypt(input: this byte[], alg: string, key:byte[], iv:byte[])
input
alg
key
iv
byte[] Decrypt(input: this byte[], alg: System.Security.Cryptography.SymmetricAlgorithm)
input
alg
byte[] Decrypt(input: this byte[], alg: System.Security.Cryptography.SymmetricAlgorithm, key:byte[], iv:byte[])
input
alg
key
iv
bool VerifyNoRevocation(input: this System.Security.Cryptography.X509Certificates.X509Certificate2)
input
true
false
Related content
For more information about working with policies, see:
Tutorial: Transform and protect your API
Policy referencefor a full list of policy statements and their settings
Policy expressions
Set or edit policies
Reuse policy configurations
Policy snippets repo
Azure API Management policy toolkit
Get Copilot assistance to create, explain, and troubleshoot policies
For more information:
See how to supply context information to your backend service. Use theSet query string parameterandSet HTTP headerpolicies to supply this information.
See how to use theValidate JWTpolicy to pre-authorize access to operations based on token claims.
See how to useAPI tracingto detect how policies are evaluated and the results of those evaluations.
See how to use expressions with theGet from cacheandStore to cachepolicies to configure API Management response caching. Set a duration that matches the response caching of the backend service as specified by the backed service'sCache-Controldirective.
Cache-Control
See how to perform content filtering. Remove data elements from the response received from the backend using theControl flowandSet bodypolicies.
To download the policy statements, see theapi-management-samples/policiesGitHub repo.
Feedback
Was this page helpful?
Additional resources