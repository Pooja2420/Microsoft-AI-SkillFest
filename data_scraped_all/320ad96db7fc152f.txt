Note
Access to this page requires authorization. You can trysigning inorchanging directories.
Access to this page requires authorization. You can trychanging directories.
Configure a load balancer & availability group listener (SQL Server on Azure VMs)
Article
2024-06-18
17 contributors
In this article
Applies to:SQL Server on Azure VM
Tip
There are manymethods to deploy an availability group. Simplify your deployment and eliminate the need for an Azure Load Balancer or distributed network name (DNN) for your Always On availability group by creating your SQL Server virtual machines (VMs) inmultiple subnetswithin the same Azure virtual network. If you've already created your availability group in a single subnet, you canmigrate it to a multi-subnet environment.
This article explains how to create a load balancer for a SQL Server Always On availability group in Azure Virtual Machines within a single subnet that are running with Azure Resource Manager. An availability group requires a load balancer when the SQL Server instances are on Azure Virtual Machines. The load balancer stores the IP address for the availability group listener. If an availability group spans multiple regions, each region needs a load balancer.
To complete this task, you need to have a SQL Server Always On availability group deployed in Azure VMs that are running with Resource Manager. Both SQL Server virtual machines must belong to the same availability set. You can use theMicrosoft templateto automatically create the availability group in Resource Manager. This template automatically creates an internal load balancer for you.
If you prefer, you canmanually configure an availability group.
This article requires that your availability groups are already configured.
View related articles:
Configure Always On availability groups in Azure VM (GUI)
Configure a VNet-to-VNet connection by using Azure Resource Manager and PowerShell
By walking through this article, you create and configure a load balancer in the Azure portal. After the process is complete, you configure the cluster to use the IP address from the load balancer for the availability group listener.
Create & configure load balancer
In this portion of the task, do the following steps:
In the Azure portal, create the load balancer and configure the IP address.
Configure the back-end pool.
Create the probe.
Set the load-balancing rules.
Note
If the SQL Server instances are in multiple resource groups and regions, perform each step twice, once in each resource group.
Important
On September 30, 2025, the Basic SKU for the Azure Load Balancer will be retired. For more information, see theofficial announcement. If you're currently using Basic Load Balancer, upgrade to Standard Load Balancer prior to the retirement date. For guidance, reviewupgrade load balancer.
Step 1: Create the load balancer and configure the IP address
First, create the load balancer.
In the Azure portal, open the resource group that contains the SQL Server virtual machines.
In the Azure portal, open the resource group that contains the SQL Server virtual machines.
In the resource group, select+ Create.
In the resource group, select+ Create.
Search forload balancer. ChooseLoad Balancer(published byMicrosoft) in the search results.
Search forload balancer. ChooseLoad Balancer(published byMicrosoft) in the search results.
On theLoad Balancerpane, selectCreate.
On theLoad Balancerpane, selectCreate.
Configure the following parameters for the load balancer.SettingFieldSubscriptionUse the same subscription as the virtual machine.Resource GroupUse the same resource group as the virtual machine.NameUse a text name for the load balancer, for examplesqlLB.RegionUse the same region as the virtual machine.SKUStandardTypeInternalThe Azure portal pane should look like this:
Configure the following parameters for the load balancer.
The Azure portal pane should look like this:

SelectNext: Frontend IP Configuration
SelectNext: Frontend IP Configuration
SelectAdd a frontend IP Configuration
SelectAdd a frontend IP Configuration

Set up the frontend IP using the following values:Name: A name that identifies the frontend IP configurationVirtual network: The same network as the virtual machines.Subnet: The subnet as the virtual machines.IP address assignment: Static.IP address: Use an available address from subnet.Use this address for your availability group listener. Notice this is different from your cluster IP address.Availability zone: Optionally choose and availability zone to deploy your IP to.The following image shows theAdd frontend IP ConfigurationUI:
Set up the frontend IP using the following values:
Name: A name that identifies the frontend IP configuration
Virtual network: The same network as the virtual machines.
Subnet: The subnet as the virtual machines.
IP address assignment: Static.
IP address: Use an available address from subnet.Use this address for your availability group listener. Notice this is different from your cluster IP address.
Availability zone: Optionally choose and availability zone to deploy your IP to.
The following image shows theAdd frontend IP ConfigurationUI:

SelectAddto create the frontend IP.
SelectAddto create the frontend IP.
ChooseReview + Createto validate the configuration, and thenCreateto create the load balancer and the frontend IP.
ChooseReview + Createto validate the configuration, and thenCreateto create the load balancer and the frontend IP.
Azure creates the load balancer. The load balancer belongs to a specific network, subnet, resource group, and location. After Azure completes the task, verify the load balancer settings in Azure.
To configure the load balancer, you need to create a backend pool, a probe, and set the load balancing rules. Do these in the Azure portal.
Step 2: Configure the backend pool
Azure calls the back-end address poolbackend pool. In this case, the backend pool is the addresses of the two SQL Server instances in your availability group.
In the Azure portal, go to your availability group. You might need to refresh the view to see the newly created load balancer.
In the Azure portal, go to your availability group. You might need to refresh the view to see the newly created load balancer.

Select the load balancer, selectBackend pools, and select+Add.
Select the load balancer, selectBackend pools, and select+Add.
Provide aNamefor the Backend pool.
Provide aNamefor the Backend pool.
SelectNICfor Backend Pool Configuration.
SelectNICfor Backend Pool Configuration.
SelectAddto associate the backend pool with the availability set that contains the VMs.
SelectAddto associate the backend pool with the availability set that contains the VMs.
UnderVirtual machinechoose the SQL Server virtual machines that will host availability group replicas.NoteIf both virtual machines are not specified, connections will only succeed to the primary replica.
UnderVirtual machinechoose the SQL Server virtual machines that will host availability group replicas.
Note
If both virtual machines are not specified, connections will only succeed to the primary replica.
SelectAddto add the virtual machines to the backend pool.
SelectAddto add the virtual machines to the backend pool.
SelectSaveto create the backend pool.
SelectSaveto create the backend pool.
Azure updates the settings for the back-end address pool. Now your availability set has a pool of two SQL Server instances.
Step 3: Create a probe
The probe defines how Azure verifies which of the SQL Server instances currently owns the availability group listener. Azure probes the service based on the IP address on a port that you define when you create the probe.
Select the load balancer, chooseHealth probes, and then select+Add.
Select the load balancer, chooseHealth probes, and then select+Add.
Set the listener health probe as follows:SettingDescriptionExampleNameTextSQLAlwaysOnEndPointProbeProtocolChoose TCPTCPPortAny unused port59999IntervalThe amount of time between probe attempts in seconds5
Set the listener health probe as follows:
SelectAddto set the health probe.
SelectAddto set the health probe.
Note
Make sure that the port you specify is open on the firewall of both SQL Server instances. Both instances require an inbound rule for the TCP port that you use. For more information, seeAdd or Edit Firewall Rule.
Azure creates the probe and then uses it to test which SQL Server instance has the listener for the availability group.
Step 4: Set the load-balancing rules
The load-balancing rules configure how the load balancer routes traffic to the SQL Server instances. For this load balancer, you enable direct server return because only one of the two SQL Server instances owns the availability group listener resource at a time.
Select the load balancer, chooseLoad balancing rules, and select+Add.
Select the load balancer, chooseLoad balancing rules, and select+Add.
Set the listener load balancing rules as follows.SettingDescriptionExampleNameTextSQLAlwaysOnEndPointListenerFrontend IP addressChoose an addressUse the address that you created when you created the load balancer.Backend poolChoose the backend poolSelect the backend pool containing the virtual machines targeted for the load balancer.ProtocolChoose TCPTCPPortUse the port for the availability group listener1433Backend PortThis field isn't used when Floating IP is set for direct server return1433Health ProbeThe name you specified for the probeSQLAlwaysOnEndPointProbeSession PersistenceDropdown listNoneIdle TimeoutMinutes to keep a TCP connection open4Floating IP (direct server return)A flow topology and an IP address mapping schemeEnabledWarningDirect server return is set during creation. It cannot be changed.NoteYou might have to scroll down the pane to view all the settings.
Set the listener load balancing rules as follows.
Warning
Direct server return is set during creation. It cannot be changed.
Note
You might have to scroll down the pane to view all the settings.
SelectSaveto set the listener load balancing rules.
SelectSaveto set the listener load balancing rules.
Azure configures the load-balancing rule. Now the load balancer is configured to route traffic to the SQL Server instance that hosts the listener for the availability group.
At this point, the resource group has a load balancer that connects to both SQL Server machines. The load balancer also contains an IP address for the SQL Server Always On availability group listener, so that either machine can respond to requests for the availability groups.
Note
If your SQL Server instances are in two separate regions, repeat the steps in the other region. Each region requires a load balancer.
Add the cluster core IP address for the Windows Server Failover Cluster (WSFC)
The WSFC IP address also needs to be on the load balancer. If you're using Windows Server 2019, skip this process as the cluster creates aDistributed Server Nameinstead of theCluster Network Name.
In the Azure portal, go to the same Azure load balancer. SelectFrontend IP configurationand select+Add. Use the IP Address you configured for the WSFC in the cluster core resources. Set the IP address as static.
In the Azure portal, go to the same Azure load balancer. SelectFrontend IP configurationand select+Add. Use the IP Address you configured for the WSFC in the cluster core resources. Set the IP address as static.
On the load balancer, selectHealth probes, and then select+Add.
On the load balancer, selectHealth probes, and then select+Add.
Set the WSFC cluster core IP address health probe as follows:SettingDescriptionExampleNameTextWSFCEndPointProbeProtocolChoose TCPTCPPortAny unused port58888IntervalThe amount of time between probe attempts in seconds5
Set the WSFC cluster core IP address health probe as follows:
SelectAddto set the health probe.
SelectAddto set the health probe.
Set the load balancing rules. SelectLoad balancing rules, and select+Add.
Set the load balancing rules. SelectLoad balancing rules, and select+Add.
Set the cluster core IP address load balancing rules as follows.SettingDescriptionExampleNameTextWSFCEndPointFrontend IP addressChoose an addressUse the address that you created when you configured the WSFC IP address. This is different from the listener IP addressBackend poolChoose the backend poolSelect the backend pool containing the virtual machines targeted for the load balancer.ProtocolChoose TCPTCPPortUse the port for the cluster IP address. This is an available port that isn't used for the listener probe port.58888Backend PortThis field isn't used when Floating IP is set for direct server return58888ProbeThe name you specified for the probeWSFCEndPointProbeSession PersistenceDropdown listNoneIdle TimeoutMinutes to keep a TCP connection open4Floating IP (direct server return)A flow topology and an IP address mapping schemeEnabledWarningDirect server return is set during creation. It cannot be changed.
Set the cluster core IP address load balancing rules as follows.
Warning
Direct server return is set during creation. It cannot be changed.
SelectOKto set the load balancing rules.
SelectOKto set the load balancing rules.
Configure the cluster to use the load balancer IP address
The next step is to configure the listener on the cluster, and bring the listener online. Do the following steps:
Create the availability group listener on the failover cluster.
Create the availability group listener on the failover cluster.
Bring the listener online.
Bring the listener online.
Step 5: Create the availability group listener on the failover cluster
In this step, you manually create the availability group listener in Failover Cluster Manager and SQL Server Management Studio.
The availability group listener is an IP address and network name that the SQL Server availability group listens on. To create the availability group listener:
Get the name of the cluster network resource:a. Use RDP to connect to the Azure virtual machine that hosts the primary replica.b. OpenFailover Cluster Manager.c. Select theNetworksnode, and note the cluster network name. Use this name in the$ClusterNetworkNamevariable in the PowerShell script. In the following image, the cluster network name isCluster Network 1:
Get the name of the cluster network resource:
a. Use RDP to connect to the Azure virtual machine that hosts the primary replica.
b. OpenFailover Cluster Manager.
c. Select theNetworksnode, and note the cluster network name. Use this name in the$ClusterNetworkNamevariable in the PowerShell script. In the following image, the cluster network name isCluster Network 1:
$ClusterNetworkName

Add the client access point. The client access point is the network name that applications use to connect to the databases in an availability group.a. InFailover Cluster Manager, expand the cluster name, and then selectRoles.b. On theRolespane, right-click the availability group name, and then selectAdd Resource>Client Access Point.c. In theNamebox, create a name for this new listener.
The name for the new listener is the network name that applications use to connect to databases in the SQL Server availability group.d. To finish creating the listener, selectNexttwice, and then selectFinish. Don't bring the listener or resource online at this point.
Add the client access point. The client access point is the network name that applications use to connect to the databases in an availability group.
a. InFailover Cluster Manager, expand the cluster name, and then selectRoles.
b. On theRolespane, right-click the availability group name, and then selectAdd Resource>Client Access Point.

c. In theNamebox, create a name for this new listener.
The name for the new listener is the network name that applications use to connect to databases in the SQL Server availability group.
d. To finish creating the listener, selectNexttwice, and then selectFinish. Don't bring the listener or resource online at this point.
Take the cluster role for the availability group offline. InFailover Cluster Manager, underRoles, right-click the role, and then selectStop Role.
Take the cluster role for the availability group offline. InFailover Cluster Manager, underRoles, right-click the role, and then selectStop Role.
Configure the IP resource for the availability group:a. Select theResourcestab, and then expand the client access point that you created. The client access point is offline.b. Right-click the IP resource, and then selectProperties. Note the name of the IP address, and use it in the$IPResourceNamevariable in the PowerShell script.c. UnderIP Address, selectStatic IP Address. Set the IP address as the same address that you used when you set the load balancer address on the Azure portal.
Configure the IP resource for the availability group:
a. Select theResourcestab, and then expand the client access point that you created. The client access point is offline.

b. Right-click the IP resource, and then selectProperties. Note the name of the IP address, and use it in the$IPResourceNamevariable in the PowerShell script.
$IPResourceName
c. UnderIP Address, selectStatic IP Address. Set the IP address as the same address that you used when you set the load balancer address on the Azure portal.

Make the SQL Server availability group dependent on the client access point:a. InFailover Cluster Manager, selectRoles, and then select your availability group.b. On theResourcestab, underOther Resources, right-click the availability group resource, and then selectProperties.c. On theDependenciestab, add the name of the client access point (the listener).d. SelectOK.
Make the SQL Server availability group dependent on the client access point:
a. InFailover Cluster Manager, selectRoles, and then select your availability group.
b. On theResourcestab, underOther Resources, right-click the availability group resource, and then selectProperties.
c. On theDependenciestab, add the name of the client access point (the listener).

d. SelectOK.
Make the client access point dependent on the IP address:a. InFailover Cluster Manager, selectRoles, and then select your availability group.b. On theResourcestab, right-click the client access point underServer Name, and then selectProperties.c. Select theDependenciestab. Verify that the IP address is a dependency. If it isn't, set a dependency on the IP address. If multiple resources are listed, verify that the IP addresses haveOR, notAND, dependencies. Then selectOK.TipYou can validate that the dependencies are correctly configured. InFailover Cluster Manager, go toRoles, right-click the availability group, selectMore Actions, and then selectShow Dependency Report. When the dependencies are correctly configured, the availability group is dependent on the network name, and the network name is dependent on the IP address.
Make the client access point dependent on the IP address:
a. InFailover Cluster Manager, selectRoles, and then select your availability group.
b. On theResourcestab, right-click the client access point underServer Name, and then selectProperties.

c. Select theDependenciestab. Verify that the IP address is a dependency. If it isn't, set a dependency on the IP address. If multiple resources are listed, verify that the IP addresses haveOR, notAND, dependencies. Then selectOK.

Tip
You can validate that the dependencies are correctly configured. InFailover Cluster Manager, go toRoles, right-click the availability group, selectMore Actions, and then selectShow Dependency Report. When the dependencies are correctly configured, the availability group is dependent on the network name, and the network name is dependent on the IP address.
Set the cluster parameters in PowerShell:a. Copy the following PowerShell script to one of your SQL Server instances. Update the variables for your environment.$ClusterNetworkNamefind the name in theFailover Cluster Managerby selectingNetworks, right-click the network and selectProperties. The$ClusterNetworkNameis underNameon the General tab.$IPResourceNameis the name given to the IP Address resource in theFailover Cluster Manager. This is found in theFailover Cluster Managerby selectingRoles, select theSQL Server AG or FCI name, select theResourcestab underServer Name, right-click the IP address resource and selectProperties. The correct value is underNameon the General tab.$ListenerILBIPis the IP address that you created on the Azure load balancer for the availability group listener. Find the$ListenerILBIPin theFailover Cluster Manageron the same properties page as the SQL Server AG/FCI Listener Resource Name.$ListenerProbePortis the port that you configured on the Azure load balancer for the availability group listener, such as 59999. Any unused TCP port is valid.$ClusterNetworkName = "<MyClusterNetworkName>" # The cluster network name. Use Get-ClusterNetwork on Windows Server 2012 or later to find the name.
$IPResourceName = "<IPResourceName>" # The IP address resource name.
$ListenerILBIP = "<n.n.n.n>" # The IP address of the internal load balancer. This is the static IP address for the load balancer that you configured in the Azure portal.
[int]$ListenerProbePort = <nnnnn>

Import-Module FailoverClusters

Get-ClusterResource $IPResourceName | Set-ClusterParameter -Multiple @{"Address"="$ListenerILBIP";"ProbePort"=$ListenerProbePort;"SubnetMask"="255.255.255.255";"Network"="$ClusterNetworkName";"EnableDhcp"=0}b. Set the cluster parameters by running the PowerShell script on one of the cluster nodes.NoteIf your SQL Server instances are in separate regions, you need to run the PowerShell script twice. The first time, use the$ListenerILBIPand$ListenerProbePortvalues from the first region. The second time, use the$ListenerILBIPand$ListenerProbePortvalues from the second region. The cluster network name and the cluster IP resource name are also different for each region.
Set the cluster parameters in PowerShell:
a. Copy the following PowerShell script to one of your SQL Server instances. Update the variables for your environment.
$ClusterNetworkNamefind the name in theFailover Cluster Managerby selectingNetworks, right-click the network and selectProperties. The$ClusterNetworkNameis underNameon the General tab.
$ClusterNetworkNamefind the name in theFailover Cluster Managerby selectingNetworks, right-click the network and selectProperties. The$ClusterNetworkNameis underNameon the General tab.
$ClusterNetworkName
$IPResourceNameis the name given to the IP Address resource in theFailover Cluster Manager. This is found in theFailover Cluster Managerby selectingRoles, select theSQL Server AG or FCI name, select theResourcestab underServer Name, right-click the IP address resource and selectProperties. The correct value is underNameon the General tab.
$IPResourceNameis the name given to the IP Address resource in theFailover Cluster Manager. This is found in theFailover Cluster Managerby selectingRoles, select theSQL Server AG or FCI name, select theResourcestab underServer Name, right-click the IP address resource and selectProperties. The correct value is underNameon the General tab.
$IPResourceName
$ListenerILBIPis the IP address that you created on the Azure load balancer for the availability group listener. Find the$ListenerILBIPin theFailover Cluster Manageron the same properties page as the SQL Server AG/FCI Listener Resource Name.
$ListenerILBIPis the IP address that you created on the Azure load balancer for the availability group listener. Find the$ListenerILBIPin theFailover Cluster Manageron the same properties page as the SQL Server AG/FCI Listener Resource Name.
$ListenerILBIP
$ListenerProbePortis the port that you configured on the Azure load balancer for the availability group listener, such as 59999. Any unused TCP port is valid.
$ListenerProbePortis the port that you configured on the Azure load balancer for the availability group listener, such as 59999. Any unused TCP port is valid.
$ListenerProbePort
$ClusterNetworkName = "<MyClusterNetworkName>" # The cluster network name. Use Get-ClusterNetwork on Windows Server 2012 or later to find the name.
$IPResourceName = "<IPResourceName>" # The IP address resource name.
$ListenerILBIP = "<n.n.n.n>" # The IP address of the internal load balancer. This is the static IP address for the load balancer that you configured in the Azure portal.
[int]$ListenerProbePort = <nnnnn>

Import-Module FailoverClusters

Get-ClusterResource $IPResourceName | Set-ClusterParameter -Multiple @{"Address"="$ListenerILBIP";"ProbePort"=$ListenerProbePort;"SubnetMask"="255.255.255.255";"Network"="$ClusterNetworkName";"EnableDhcp"=0}
$ClusterNetworkName = "<MyClusterNetworkName>" # The cluster network name. Use Get-ClusterNetwork on Windows Server 2012 or later to find the name.
$IPResourceName = "<IPResourceName>" # The IP address resource name.
$ListenerILBIP = "<n.n.n.n>" # The IP address of the internal load balancer. This is the static IP address for the load balancer that you configured in the Azure portal.
[int]$ListenerProbePort = <nnnnn>

Import-Module FailoverClusters

Get-ClusterResource $IPResourceName | Set-ClusterParameter -Multiple @{"Address"="$ListenerILBIP";"ProbePort"=$ListenerProbePort;"SubnetMask"="255.255.255.255";"Network"="$ClusterNetworkName";"EnableDhcp"=0}
b. Set the cluster parameters by running the PowerShell script on one of the cluster nodes.
Note
If your SQL Server instances are in separate regions, you need to run the PowerShell script twice. The first time, use the$ListenerILBIPand$ListenerProbePortvalues from the first region. The second time, use the$ListenerILBIPand$ListenerProbePortvalues from the second region. The cluster network name and the cluster IP resource name are also different for each region.
$ListenerILBIP
$ListenerProbePort
$ListenerILBIP
$ListenerProbePort
Bring the cluster role for the availability group online. InFailover Cluster Manager, underRoles, right-click the role, and then selectStart Role.
Bring the cluster role for the availability group online. InFailover Cluster Manager, underRoles, right-click the role, and then selectStart Role.
If necessary, repeat the preceding steps to set the cluster parameters for the IP address of the Windows Server failover cluster:
Get the IP address name of the Windows Server failover cluster. InFailover Cluster Manager, underCluster Core Resources, locateServer Name.
Get the IP address name of the Windows Server failover cluster. InFailover Cluster Manager, underCluster Core Resources, locateServer Name.
Right-clickIP Address, and then selectProperties.
Right-clickIP Address, and then selectProperties.
Copy the name of the IP address fromName. It might beCluster IP Address.
Copy the name of the IP address fromName. It might beCluster IP Address.
Set the cluster parameters in PowerShell:a. Copy the following PowerShell script to one of your SQL Server instances. Update the variables for your environment.$ClusterCoreIPis the IP address that you created on the Azure load balancer for the Windows Server failover cluster's core cluster resource. It's different from the IP address for the availability group listener.$ClusterProbePortis the port that you configured on the Azure load balancer for the Windows Server failover cluster's health probe. It's different from the probe for the availability group listener.$ClusterNetworkName = "<MyClusterNetworkName>" # The cluster network name. Use Get-ClusterNetwork on Windows Server 2012 or later to find the name.
$IPResourceName = "<ClusterIPResourceName>" # The IP address resource name.
$ClusterCoreIP = "<n.n.n.n>" # The IP address of the cluster IP resource. This is the static IP address for the load balancer that you configured in the Azure portal.
[int]$ClusterProbePort = <nnnnn> # The probe port from WSFCEndPointprobe in the Azure portal. This port must be different from the probe port for the availability group listener.

Import-Module FailoverClusters

Get-ClusterResource $IPResourceName | Set-ClusterParameter -Multiple @{"Address"="$ClusterCoreIP";"ProbePort"=$ClusterProbePort;"SubnetMask"="255.255.255.255";"Network"="$ClusterNetworkName";"EnableDhcp"=0}b. Set the cluster parameters by running the PowerShell script on one of the cluster nodes.
Set the cluster parameters in PowerShell:
a. Copy the following PowerShell script to one of your SQL Server instances. Update the variables for your environment.
$ClusterCoreIPis the IP address that you created on the Azure load balancer for the Windows Server failover cluster's core cluster resource. It's different from the IP address for the availability group listener.
$ClusterCoreIPis the IP address that you created on the Azure load balancer for the Windows Server failover cluster's core cluster resource. It's different from the IP address for the availability group listener.
$ClusterCoreIP
$ClusterProbePortis the port that you configured on the Azure load balancer for the Windows Server failover cluster's health probe. It's different from the probe for the availability group listener.
$ClusterProbePortis the port that you configured on the Azure load balancer for the Windows Server failover cluster's health probe. It's different from the probe for the availability group listener.
$ClusterProbePort
$ClusterNetworkName = "<MyClusterNetworkName>" # The cluster network name. Use Get-ClusterNetwork on Windows Server 2012 or later to find the name.
$IPResourceName = "<ClusterIPResourceName>" # The IP address resource name.
$ClusterCoreIP = "<n.n.n.n>" # The IP address of the cluster IP resource. This is the static IP address for the load balancer that you configured in the Azure portal.
[int]$ClusterProbePort = <nnnnn> # The probe port from WSFCEndPointprobe in the Azure portal. This port must be different from the probe port for the availability group listener.

Import-Module FailoverClusters

Get-ClusterResource $IPResourceName | Set-ClusterParameter -Multiple @{"Address"="$ClusterCoreIP";"ProbePort"=$ClusterProbePort;"SubnetMask"="255.255.255.255";"Network"="$ClusterNetworkName";"EnableDhcp"=0}
$ClusterNetworkName = "<MyClusterNetworkName>" # The cluster network name. Use Get-ClusterNetwork on Windows Server 2012 or later to find the name.
$IPResourceName = "<ClusterIPResourceName>" # The IP address resource name.
$ClusterCoreIP = "<n.n.n.n>" # The IP address of the cluster IP resource. This is the static IP address for the load balancer that you configured in the Azure portal.
[int]$ClusterProbePort = <nnnnn> # The probe port from WSFCEndPointprobe in the Azure portal. This port must be different from the probe port for the availability group listener.

Import-Module FailoverClusters

Get-ClusterResource $IPResourceName | Set-ClusterParameter -Multiple @{"Address"="$ClusterCoreIP";"ProbePort"=$ClusterProbePort;"SubnetMask"="255.255.255.255";"Network"="$ClusterNetworkName";"EnableDhcp"=0}
b. Set the cluster parameters by running the PowerShell script on one of the cluster nodes.
If any SQL resource is configured to use a port between 49152 and 65536 (thedefault dynamic port range for TCP/IP), add an exclusion for each port. Such resources might include:
SQL Server database engine
Always On availability group listener
Health probe for the failover cluster instance
Database mirroring endpoint
Cluster core IP resource
Adding an exclusion will prevent other system processes from being dynamically assigned to the same port. For this scenario, configure the following exclusions on all cluster nodes:
netsh int ipv4 add excludedportrange tcp startport=58888 numberofports=1 store=persistent
netsh int ipv4 add excludedportrange tcp startport=58888 numberofports=1 store=persistent
netsh int ipv4 add excludedportrange tcp startport=59999 numberofports=1 store=persistent
netsh int ipv4 add excludedportrange tcp startport=59999 numberofports=1 store=persistent
It's important to configure the port exclusion when the port is not in use. Otherwise, the command will fail with a message like "The process cannot access the file because it is being used by another process."
To confirm that the exclusions are configured correctly, use the following command:netsh int ipv4 show excludedportrange tcp.
netsh int ipv4 show excludedportrange tcp
Warning
The port for the availability group listener's health probe has to be different from the port for the cluster core IP address's health probe. In these examples, the listener port is 59999 and the cluster core IP address's health probe port is 58888. Both ports require an "allow inbound" firewall rule.
Verify the configuration of the listener
If the cluster resources and dependencies are correctly configured, you should be able to view the listener in SQL Server Management Studio. To set the listener port, do the following steps:
Start SQL Server Management Studio, and then connect to the primary replica.
Start SQL Server Management Studio, and then connect to the primary replica.
Go toAlways On High Availability>Availability Groups>Availability Group Listeners.You should now see the listener name that you created in Failover Cluster Manager.
Go toAlways On High Availability>Availability Groups>Availability Group Listeners.
You should now see the listener name that you created in Failover Cluster Manager.
Right-click the listener name, and then selectProperties.
Right-click the listener name, and then selectProperties.
In thePortbox, specify the port number for the availability group listener by using the $EndpointPort you used earlier (1433 was the default), and then selectOK.
In thePortbox, specify the port number for the availability group listener by using the $EndpointPort you used earlier (1433 was the default), and then selectOK.
You now have an availability group in Azure virtual machines running in Resource Manager mode.
Test the connection to the listener
Test the connection by doing the following steps:
UseBastionto connect to a SQL Server instance that's in the same virtual network, but doesn't own the replica. This server can be the other SQL Server instance in the cluster.
UseBastionto connect to a SQL Server instance that's in the same virtual network, but doesn't own the replica. This server can be the other SQL Server instance in the cluster.
Usesqlcmdutility to test the connection. For example, the following script establishes asqlcmdconnection to the primary replica through the listener with Windows authentication:sqlcmd -S <listenerName> -E
Usesqlcmdutility to test the connection. For example, the following script establishes asqlcmdconnection to the primary replica through the listener with Windows authentication:
sqlcmd -S <listenerName> -E
sqlcmd -S <listenerName> -E
The SQLCMD connection automatically connects to the SQL Server instance that hosts the primary replica.
Create an IP address for an additional availability group
Each availability group uses a separate listener. Each listener has its own IP address. Use the same load balancer to hold the IP address for additional listeners. Add only the primary IP address of the VM to the back-end pool of the load balancer as thesecondary VM IP address doesn't support floating IP.
To add an IP address to a load balancer with the Azure portal, do the following steps:
In the Azure portal, open the resource group that contains the load balancer, and then select the load balancer.
In the Azure portal, open the resource group that contains the load balancer, and then select the load balancer.
UnderSettings, selectFrontend IP configuration, and then select+ Add.
UnderSettings, selectFrontend IP configuration, and then select+ Add.
UnderAdd frontend IP address, assign a name for the front end.
UnderAdd frontend IP address, assign a name for the front end.
Verify that theVirtual networkand theSubnetare the same as the SQL Server instances.
Verify that theVirtual networkand theSubnetare the same as the SQL Server instances.
Set the IP address for the listener.TipYou can set the IP address to static and type an address that is not currently used in the subnet. Alternatively, you can set the IP address to dynamic and save the new front-end IP pool. When you do so, the Azure portal automatically assigns an available IP address to the pool. You can then reopen the front-end IP pool and change the assignment to static.
Set the IP address for the listener.
Tip
You can set the IP address to static and type an address that is not currently used in the subnet. Alternatively, you can set the IP address to dynamic and save the new front-end IP pool. When you do so, the Azure portal automatically assigns an available IP address to the pool. You can then reopen the front-end IP pool and change the assignment to static.
Save the IP address for the listener by selectingAdd.
Save the IP address for the listener by selectingAdd.
Add a health probe selectingHealth probesunderSettingsand use the following settings:SettingValueNameA name to identify the probe.ProtocolTCPPortAn unused TCP port, which must be available on all virtual machines. It can't be used for any other purpose. No two listeners can use the same probe port.IntervalThe amount of time between probe attempts. Use the default (5).
Add a health probe selectingHealth probesunderSettingsand use the following settings:
SelectAddto save the probe.
SelectAddto save the probe.
Create a load-balancing rule. UnderSettings, selectLoad balancing rules, and then select+ Add.
Create a load-balancing rule. UnderSettings, selectLoad balancing rules, and then select+ Add.
Configure the new load-balancing rule by using the following settings:SettingValueNameA name to identify the load-balancing rule.Frontend IP addressSelect the IP address you created.Backend poolThe pool that contains the virtual machines with the SQL Server instances.ProtocolTCPPortUse the port that the SQL Server instances are using. A default instance uses port 1433, unless you changed it.Backend portUse the same value asPort.Health probeChoose the probe you created.Session persistenceNoneIdle timeout (minutes)Default (4)Floating IP (direct server return)Enabled
Configure the new load-balancing rule by using the following settings:
Configure the availability group to use the new IP address
To finish configuring the cluster, repeat the steps that you followed when you made the first availability group. That is, configure thecluster to use the new IP address.
After you've added an IP address for the listener, configure the additional availability group by doing the following steps:
Verify that the probe port for the new IP address is open on both SQL Server virtual machines.
Verify that the probe port for the new IP address is open on both SQL Server virtual machines.
In Cluster Manager, add the client access point.
In Cluster Manager, add the client access point.
Configure the IP resource for the availability group.ImportantWhen you create the IP address, use the IP address that you added to the load balancer.
Configure the IP resource for the availability group.
Important
When you create the IP address, use the IP address that you added to the load balancer.
Make the SQL Server availability group resource dependent on the client access point.
Make the SQL Server availability group resource dependent on the client access point.
Make the client access point resource dependent on the IP address.
Make the client access point resource dependent on the IP address.
Set the cluster parameters in PowerShell.
Set the cluster parameters in PowerShell.
If you're on the secondary replica VM, and you're unable to connect to the listener, it's possible the probe port was not configured correctly.
You can use the following script to validate the probe port is correctly configured for the availability group:
Clear-Host
Get-ClusterResource `
| Where-Object {$_.ResourceType.Name -like "IP Address"} `
| Get-ClusterParameter `
| Where-Object {($_.Name -like "Network") -or ($_.Name -like "Address") -or ($_.Name -like "ProbePort") -or ($_.Name -like "SubnetMask")}
Clear-Host
Get-ClusterResource `
| Where-Object {$_.ResourceType.Name -like "IP Address"} `
| Get-ClusterParameter `
| Where-Object {($_.Name -like "Network") -or ($_.Name -like "Address") -or ($_.Name -like "ProbePort") -or ($_.Name -like "SubnetMask")}
Add load-balancing rule for distributed availability group
If an availability group participates in a distributed availability group, the load balancer needs an additional rule. This rule stores the port used by the distributed availability group listener.
Important
This step only applies if the availability group participates in adistributed availability group.
On each server that participates in the distributed availability group, create an inbound rule on the distributed availability group listener TCP port. In many examples, documentation uses 5022.
On each server that participates in the distributed availability group, create an inbound rule on the distributed availability group listener TCP port. In many examples, documentation uses 5022.
In the Azure portal, select the load balancer and selectLoad balancing rules, and then select+Add.
In the Azure portal, select the load balancer and selectLoad balancing rules, and then select+Add.
Create the load balancing rule with the following settings:SettingValueNameA name to identify the load balancing rule for the distributed availability group.Frontend IP addressUse the same frontend IP address as the availability group.Backend poolThe pool that contains the virtual machines with the SQL Server instances.ProtocolTCPPort5022 - The port for thedistributed availability group endpoint listener.Can be any available port.Backend port5022 - Use the same value asPort.Health probeChoose the probe you created.Session persistenceNoneIdle timeout (minutes)Default (4)Floating IP (direct server return)Enabled
Create the load balancing rule with the following settings:
Repeat these steps for the load balancer on the other availability groups that participate in the distributed availability groups.
If you have an Azure Network Security Group to restrict access, make sure that the allow rules include:
The backend SQL Server VM IP addresses
The load balancer floating IP addresses for the AG listener
The cluster core IP address, if applicable.
Related content
Windows Server Failover Cluster with SQL Server on Azure VMs
Always On availability groups with SQL Server on Azure VMs
Always On availability groups overview
HADR settings for SQL Server on Azure VMs
Feedback
Was this page helpful?
Additional resources