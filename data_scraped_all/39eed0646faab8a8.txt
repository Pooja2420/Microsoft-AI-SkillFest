Note
Access to this page requires authorization. You can trysigning inorchanging directories.
Access to this page requires authorization. You can trychanging directories.
Add session hosts to a host pool
Article
2025-03-18
8 contributors
In this article
Important
The following features are currently in preview:
Azure Virtual Desktop on Azure Local for Azure Government and for Azure operated by 21Vianet (Azure in China).
Azure Virtual Desktop on Azure Local for Azure Government and for Azure operated by 21Vianet (Azure in China).
Azure Virtual Desktop on Azure Extended Zones.
Azure Virtual Desktop on Azure Extended Zones.
Managing session hosts using a session host configuration. This limited preview is provided as-is, with all faults and as available, and are excluded from the service-level agreements (SLAs) or any limited warranties Microsoft provides for Azure services in general availability.
Managing session hosts using a session host configuration. This limited preview is provided as-is, with all faults and as available, and are excluded from the service-level agreements (SLAs) or any limited warranties Microsoft provides for Azure services in general availability.
For legal terms that apply to Azure features that are in beta, in preview, or otherwise not yet released into general availability, seeSupplemental Terms of Use for Microsoft Azure Previews.
After you create a host pool, a workspace, and an application group, you need to add session hosts to the host pool for your users to connect to. You might also need to add more session hosts for extra capacity.
When you add session hosts to a host pool, the method you use depends on yourhost pool's management approach:
For a host pool using asession host configuration(preview), you use the Azure portal to specify the number of session hosts you want to add, then Azure Virtual Desktop automatically creates them based on thesession host configuration.
For a host pool using asession host configuration(preview), you use the Azure portal to specify the number of session hosts you want to add, then Azure Virtual Desktop automatically creates them based on thesession host configuration.
For a host pool using standard management, you can create new virtual machines (VMs) to use as session hosts and add them to a host pool natively by using the Azure Virtual Desktop service in the Azure portal. Alternatively, you can create VMs outside the Azure Virtual Desktop service, such as using an automated pipeline, the Azure CLI, or Azure PowerShell, and then add them as session hosts to a host pool separately.For Azure Local, you can create new VMs to use as session hosts and add them to a host pool natively by using the Azure Virtual Desktop service in the Azure portal. If you want to create the VMs outside the Azure Virtual Desktop service, follow the steps inCreate Azure Arc virtual machines on Azure Local, and then add the VMs as session hosts to a host pool separately.
For a host pool using standard management, you can create new virtual machines (VMs) to use as session hosts and add them to a host pool natively by using the Azure Virtual Desktop service in the Azure portal. Alternatively, you can create VMs outside the Azure Virtual Desktop service, such as using an automated pipeline, the Azure CLI, or Azure PowerShell, and then add them as session hosts to a host pool separately.
For Azure Local, you can create new VMs to use as session hosts and add them to a host pool natively by using the Azure Virtual Desktop service in the Azure portal. If you want to create the VMs outside the Azure Virtual Desktop service, follow the steps inCreate Azure Arc virtual machines on Azure Local, and then add the VMs as session hosts to a host pool separately.
Tip
Select a button at the top of this article to choose between host pools using standard management or host pools using session host configuration to see the relevant documentation.
This article shows you how to add session hosts to a host pool using the Azure portal. Azure PowerShell isn't available for adding session hosts to a host pool with a session host configuration.
This article shows you how to generate a registration key by using the Azure portal, the Azure CLI, or Azure PowerShell. It also shows you how to add session hosts to a host pool by using the Azure Virtual Desktop service or add them to a host pool separately.
Prerequisites
For a general idea of what's required, such as supported operating systems, virtual networks, and identity providers, review theprerequisites for Azure Virtual Desktop. In addition:
You need an existing host pool with a session host configuration.
You need an existing host pool with standard management. Each host pool must only contain session hosts on Azure or on Azure Local. You can't mix session hosts on Azure and on Azure Local in the same host pool.
If you have existing session hosts in the host pool, make a note of the virtual machine size, the image, and name prefix that you used. All session hosts in a host pool should have the same configuration, including the same identity provider. For example, a host pool shouldn't contain some session hosts joined to Microsoft Entra ID and some session hosts joined to an Active Directory domain.
The Azure account you use must have the following built-in role-based access control (RBAC) roles or equivalent as a minimum on the resource group:ActionRBAC roleCreate and add session hosts using the Azure portalDesktop Virtualization Host Pool ContributorVirtual Machine Contributor
The Azure account you use must have the following built-in role-based access control (RBAC) roles or equivalent as a minimum on the resource group:
The Azure account you use must have the following built-in role-based access control (RBAC) roles or equivalent as a minimum on the resource group:ActionRBAC role or rolesGenerate a registration key for the host poolDesktop Virtualization Host Pool ContributorCreate and add session hosts by using the Azure portal (Azure and Azure Extended Zones)Desktop Virtualization Host Pool ContributorVirtual Machine ContributorCreate and add session hosts by using the Azure portal (Azure Local)Desktop Virtualization Host Pool ContributorAzure Stack HCI VM Contributor
The Azure account you use must have the following built-in role-based access control (RBAC) roles or equivalent as a minimum on the resource group:
Don't disableWindows Remote Management(WinRM) when you're creating and adding session hosts by using the Azure portal.PowerShell DSCrequires it.
Don't disableWindows Remote Management(WinRM) when you're creating and adding session hosts by using the Azure portal.PowerShell DSCrequires it.
To add session hosts on Azure Local, you also need:AnAzure Local instance registered with Azure. Your Azure Local instances need to be running a minimum of version 23H2. For more information, seeAbout Azure Stack HCI, version 23H2 deployment.Azure Arc VM managementis installed automatically.A stable connection to Azure from your on-premises network.At least one Windows OS image available on the instance. For more information, see how tocreate VM images by using Azure Marketplace images,use images in an Azure Storage account, anduse images in a local share.TheAzure Connected Machine agenton Azure Local machines created outside the Azure Virtual Desktop service, such as with an automated pipeline. The virtual machines use the agent to communicate withAzure Instance Metadata Service, which is arequired endpoint for Azure Virtual Desktop.A logical network that you created on your Azure Local instance. DHCP logical networks or static logical networks with automatic IP allocation are supported. For more information, seeCreate logical networks for Azure Local.
To add session hosts on Azure Local, you also need:
AnAzure Local instance registered with Azure. Your Azure Local instances need to be running a minimum of version 23H2. For more information, seeAbout Azure Stack HCI, version 23H2 deployment.Azure Arc VM managementis installed automatically.
AnAzure Local instance registered with Azure. Your Azure Local instances need to be running a minimum of version 23H2. For more information, seeAbout Azure Stack HCI, version 23H2 deployment.Azure Arc VM managementis installed automatically.
A stable connection to Azure from your on-premises network.
A stable connection to Azure from your on-premises network.
At least one Windows OS image available on the instance. For more information, see how tocreate VM images by using Azure Marketplace images,use images in an Azure Storage account, anduse images in a local share.
At least one Windows OS image available on the instance. For more information, see how tocreate VM images by using Azure Marketplace images,use images in an Azure Storage account, anduse images in a local share.
TheAzure Connected Machine agenton Azure Local machines created outside the Azure Virtual Desktop service, such as with an automated pipeline. The virtual machines use the agent to communicate withAzure Instance Metadata Service, which is arequired endpoint for Azure Virtual Desktop.
TheAzure Connected Machine agenton Azure Local machines created outside the Azure Virtual Desktop service, such as with an automated pipeline. The virtual machines use the agent to communicate withAzure Instance Metadata Service, which is arequired endpoint for Azure Virtual Desktop.
A logical network that you created on your Azure Local instance. DHCP logical networks or static logical networks with automatic IP allocation are supported. For more information, seeCreate logical networks for Azure Local.
A logical network that you created on your Azure Local instance. DHCP logical networks or static logical networks with automatic IP allocation are supported. For more information, seeCreate logical networks for Azure Local.
To deploy session hosts toAzure Extended Zones, you also need:Your Azure subscription registered with the respective Azure Extended Zone. For more information, seeRequest access to an Azure Extended Zone.AnAzure load balancerwith an outbound rule on the virtual network to which you're deploying session hosts. You can use an existing load balancer or you create a new one when adding session hosts.
To deploy session hosts toAzure Extended Zones, you also need:
Your Azure subscription registered with the respective Azure Extended Zone. For more information, seeRequest access to an Azure Extended Zone.
Your Azure subscription registered with the respective Azure Extended Zone. For more information, seeRequest access to an Azure Extended Zone.
AnAzure load balancerwith an outbound rule on the virtual network to which you're deploying session hosts. You can use an existing load balancer or you create a new one when adding session hosts.
AnAzure load balancerwith an outbound rule on the virtual network to which you're deploying session hosts. You can use an existing load balancer or you create a new one when adding session hosts.
If you want to use the Azure CLI or Azure PowerShell locally, seeUse the Azure CLI and Azure PowerShell with Azure Virtual Desktopto make sure you have thedesktopvirtualizationAzure CLI extension or theAz.DesktopVirtualizationAzure PowerShell module installed. Alternatively, useAzure Cloud Shell.
If you want to use the Azure CLI or Azure PowerShell locally, seeUse the Azure CLI and Azure PowerShell with Azure Virtual Desktopto make sure you have thedesktopvirtualizationAzure CLI extension or theAz.DesktopVirtualizationAzure PowerShell module installed. Alternatively, useAzure Cloud Shell.
Important
If you want to create Microsoft Entra joined session hosts, we only support this using theAADLoginForWindowsVM extension, which is added and configured automatically when using the Azure portal or ARM template with the Azure Virtual Desktop service.
AADLoginForWindows
Generate a registration key
When you add session hosts to a host pool, first you need to generate a registration key for that host pool. A registration key authorizes session hosts to join the host pool. It's valid only for the duration that you specify.
To generate a registration key, select the relevant tab for your scenario and follow the steps.
Azure portal
Azure PowerShell
Azure CLI
Here's how to generate a registration key by using the Azure portal:
Sign in to theAzure portal.
Sign in to theAzure portal.
On the search bar, enterAzure Virtual Desktopand select the matching service entry.
On the search bar, enterAzure Virtual Desktopand select the matching service entry.
SelectHost pools, and then select the name of the host pool for which you want to generate a registration key.
SelectHost pools, and then select the name of the host pool for which you want to generate a registration key.
On the host pool overview, selectRegistration key.
On the host pool overview, selectRegistration key.
SelectGenerate new key, enter an expiration date and time, and then selectOK. The registration key is created.
SelectGenerate new key, enter an expiration date and time, and then selectOK. The registration key is created.
SelectDownloadto download a text file that contains the newly created registration key, or copy the registration key to your clipboard to use it later. You can also retrieve the registration key later by returning to the host pool overview.
SelectDownloadto download a text file that contains the newly created registration key, or copy the registration key to your clipboard to use it later. You can also retrieve the registration key later by returning to the host pool overview.
Here's how to generate a registration key by using theAz.DesktopVirtualizationAzure PowerShell module. In the following examples, be sure to change the<placeholder>values for your own.
<placeholder>
OpenAzure Cloud Shellin the Azure portal with thePowerShellterminal type, or run PowerShell on your local device.If you're using Cloud Shell, make sure yourAzure context is set to the subscription that you want to use.If you're using PowerShell locally, firstsign in with Azure PowerShell, and then make sure yourAzure context is set to the subscription that you want to use.
OpenAzure Cloud Shellin the Azure portal with thePowerShellterminal type, or run PowerShell on your local device.
If you're using Cloud Shell, make sure yourAzure context is set to the subscription that you want to use.
If you're using Cloud Shell, make sure yourAzure context is set to the subscription that you want to use.
If you're using PowerShell locally, firstsign in with Azure PowerShell, and then make sure yourAzure context is set to the subscription that you want to use.
If you're using PowerShell locally, firstsign in with Azure PowerShell, and then make sure yourAzure context is set to the subscription that you want to use.
Use theNew-AzWvdRegistrationInfocmdlet by using the following example to generate a registration key that's valid for 24 hours.$parameters = @{
    HostPoolName = '<HostPoolName>'
    ResourceGroupName = '<ResourceGroupName>'
    ExpirationTime = $((Get-Date).ToUniversalTime().AddHours(24).ToString('yyyy-MM-ddTHH:mm:ss.fffffffZ'))
}

New-AzWvdRegistrationInfo @parameters
Use theNew-AzWvdRegistrationInfocmdlet by using the following example to generate a registration key that's valid for 24 hours.
New-AzWvdRegistrationInfo
$parameters = @{
    HostPoolName = '<HostPoolName>'
    ResourceGroupName = '<ResourceGroupName>'
    ExpirationTime = $((Get-Date).ToUniversalTime().AddHours(24).ToString('yyyy-MM-ddTHH:mm:ss.fffffffZ'))
}

New-AzWvdRegistrationInfo @parameters
$parameters = @{
    HostPoolName = '<HostPoolName>'
    ResourceGroupName = '<ResourceGroupName>'
    ExpirationTime = $((Get-Date).ToUniversalTime().AddHours(24).ToString('yyyy-MM-ddTHH:mm:ss.fffffffZ'))
}

New-AzWvdRegistrationInfo @parameters
Get the registration key and copy it to your clipboard to use later. You can also retrieve the registration key later by running this command anytime while the registration key is valid.$parameters = @{
    HostPoolName = '<HostPoolName>'
    ResourceGroupName = '<ResourceGroupName>'
}

(Get-AzWvdHostPoolRegistrationToken @parameters).Token
Get the registration key and copy it to your clipboard to use later. You can also retrieve the registration key later by running this command anytime while the registration key is valid.
$parameters = @{
    HostPoolName = '<HostPoolName>'
    ResourceGroupName = '<ResourceGroupName>'
}

(Get-AzWvdHostPoolRegistrationToken @parameters).Token
$parameters = @{
    HostPoolName = '<HostPoolName>'
    ResourceGroupName = '<ResourceGroupName>'
}

(Get-AzWvdHostPoolRegistrationToken @parameters).Token
Here's how to generate a registration key by using thedesktopvirtualizationextension for the Azure CLI. In the following examples, be sure to change the<placeholder>values for your own.
<placeholder>
OpenAzure Cloud Shellin the Azure portal with theBashterminal type, or run the Azure CLI on your local device.If you're using Cloud Shell, make sure yourAzure context is set to the subscription that you want to use.If you're using the Azure CLI locally, firstsign in with the Azure CLI, and then make sure yourAzure context is set to the subscription that you want to use.
OpenAzure Cloud Shellin the Azure portal with theBashterminal type, or run the Azure CLI on your local device.
If you're using Cloud Shell, make sure yourAzure context is set to the subscription that you want to use.
If you're using Cloud Shell, make sure yourAzure context is set to the subscription that you want to use.
If you're using the Azure CLI locally, firstsign in with the Azure CLI, and then make sure yourAzure context is set to the subscription that you want to use.
If you're using the Azure CLI locally, firstsign in with the Azure CLI, and then make sure yourAzure context is set to the subscription that you want to use.
Use theaz desktopvirtualization workspace updatecommand by using the following example to generate a registration key that's valid for 24 hours.az desktopvirtualization hostpool update \
    --name <Name> \
    --resource-group <ResourceGroupName> \
    --registration-info expiration-time=$(date -d '+24 hours' --iso-8601=ns) registration-token-operation="Update"
Use theaz desktopvirtualization workspace updatecommand by using the following example to generate a registration key that's valid for 24 hours.
az desktopvirtualization workspace update
az desktopvirtualization hostpool update \
    --name <Name> \
    --resource-group <ResourceGroupName> \
    --registration-info expiration-time=$(date -d '+24 hours' --iso-8601=ns) registration-token-operation="Update"
az desktopvirtualization hostpool update \
    --name <Name> \
    --resource-group <ResourceGroupName> \
    --registration-info expiration-time=$(date -d '+24 hours' --iso-8601=ns) registration-token-operation="Update"
Get the registration key and copy it to your clipboard to use later. You can also retrieve the registration key later by running this command anytime while the registration key is valid.az desktopvirtualization hostpool retrieve-registration-token \
    --name <Name> \
    --resource-group <ResourceGroupName> \
    --query token --output tsv
Get the registration key and copy it to your clipboard to use later. You can also retrieve the registration key later by running this command anytime while the registration key is valid.
az desktopvirtualization hostpool retrieve-registration-token \
    --name <Name> \
    --resource-group <ResourceGroupName> \
    --query token --output tsv
az desktopvirtualization hostpool retrieve-registration-token \
    --name <Name> \
    --resource-group <ResourceGroupName> \
    --query token --output tsv
Add session hosts
You can use the Azure portal to specify the number of session hosts you want to add, then Azure Virtual Desktop automatically creates them based on the session host configuration. You can't use PowerShell to add session hosts to a host pool with a session host configuration.
Here's how to add session hosts:
Sign in to theAzure portal.
Sign in to theAzure portal.
In the search bar, typeAzure Virtual Desktopand select the matching service entry.
In the search bar, typeAzure Virtual Desktopand select the matching service entry.
SelectHost pools, then select the name of the host pool you want to add session hosts to.
SelectHost pools, then select the name of the host pool you want to add session hosts to.
On the host pool overview, selectSession hosts, then select+ Add.
On the host pool overview, selectSession hosts, then select+ Add.
ForNumber of session hosts to be added, enter the number of session hosts you want to create. If you want to review the session host configuration that is used, seeView session host configuration. To edit the session host configuration, seeSchedule an update and edit session host configuration.
ForNumber of session hosts to be added, enter the number of session hosts you want to create. If you want to review the session host configuration that is used, seeView session host configuration. To edit the session host configuration, seeSchedule an update and edit session host configuration.
SelectAdd. The number of session hosts you entered is created and added to the host pool.
SelectAdd. The number of session hosts you entered is created and added to the host pool.
Create and register session hosts with the Azure Virtual Desktop service
You can create session hosts and register them to a host pool in a single end-to-end process with the Azure Virtual Desktop service by using the Azure portal or an Azure Resource Manager template (ARM template). You can find some example ARM templates inthis GitHub repo.
Important
If you want to create virtual machines by using an alternative method outside Azure Virtual Desktop, such as an automated pipeline, you need to register them separately as session hosts to a host pool. Skip to the sectionRegister session hosts to a host pool.
Here's how to create session hosts and register them to a host pool by using the Azure Virtual Desktop service in the Azure portal. Make sure that you generated a registration key first.
Sign in to theAzure portal.
Sign in to theAzure portal.
On the search bar, enterAzure Virtual Desktopand select the matching service entry.
On the search bar, enterAzure Virtual Desktopand select the matching service entry.
SelectHost pools, and then select the name of the host pool to which you want to add session hosts.
SelectHost pools, and then select the name of the host pool to which you want to add session hosts.
On the host pool overview, selectSession hosts, and then select+ Add.
On the host pool overview, selectSession hosts, and then select+ Add.
TheBasicstab is unavailable because you're using the existing host pool. SelectNext: Virtual Machines.
TheBasicstab is unavailable because you're using the existing host pool. SelectNext: Virtual Machines.
On theVirtual machinestab, expand one of the following sections and complete the information, depending on whether you want to create session hosts on Azure or on Azure Local. For guidance on sizing session host virtual machines, seeSession host virtual machine sizing guidelines.To add session hosts onAzure, expand this section.ParameterValue/DescriptionResource groupThis value defaults to the same resource group as your host pool, but you can select a different one from the dropdown list.Name prefixEnter a name prefix for your session hosts, such ashp01-sh.Each session host has a suffix of a hyphen and then a sequential number added to the end, such ashp01-sh-0.This name prefix can be a maximum of 11 characters and is used in the computer name in the operating system. The prefix and the suffix combined can be a maximum of 15 characters. Session host names must be unique.Virtual machine locationSelect the Azure region where you want to deploy your session hosts. It must be the same region that contains your virtual network.Availability optionsSelect fromavailability zones,availability set, orNo infrastructure redundancy required. If you selectavailability zonesoravailability set, complete the extra parameters that appear.Security typeSelect fromStandard,Trusted launch virtual machines, orConfidential virtual machines.- If you selectTrusted launch virtual machines, options forsecure bootandvTPMare automatically selected.- If you selectConfidential virtual machines, options forsecure boot,vTPM, andintegrity monitoringare automatically selected. You can't opt out of vTPM when using a confidential VM.ImageSelect the OS image that you want to use from the list, or selectSee all imagesto see more. The full list includes any images that you created and stored as anAzure Compute Gallery shared imageor amanaged image.Virtual machine sizeSelect a size. If you want to use a different size, selectChange size, and then select from the list.HibernateSelect the box to enable hibernation. Hibernation is available only for personal host pools. For more information, seeHibernation in virtual machines. If you're using Microsoft Teams media optimizations, you should update theWebRTC redirector service to 1.45.2310.13001.FSLogix and app attach currently don't support hibernation. Don't enable hibernation if you're using FSLogix or app attach for your personal host pools.Number of VMsEnter the number of virtual machines that you want to deploy. You can deploy up to 400 session hosts at this point if you want (depending on yoursubscription quota), or you can add more later.For more information, seeAzure Virtual Desktop service limitsandVirtual Machines limits.OS disk typeSelect the disk type to use for your session hosts. We recommend that you use onlyPremium SSDfor production workloads.OS disk sizeSelect a size for the OS disk.If you enable hibernation, ensure that the OS disk is large enough to store the contents of the memory in addition to the OS and other applications.Confidential computing encryptionIf you're using a confidential VM, you must select theConfidential compute encryptioncheckbox to enable OS disk encryption.This checkbox appears only if you selectedConfidential virtual machinesas your security type.Boot DiagnosticsSelect whether you want to enableboot diagnostics.Network and securityVirtual networkSelect your virtual network. An option to select a subnet appears.SubnetSelect a subnet from your virtual network.Network security groupSelect whether you want to use a network security group (NSG).-Nonedoesn't create a new NSG.-Basiccreates a new NSG for the VM network adapter.-Advancedenables you to select an existing NSG.We recommend that you don't create an NSG here, butcreate an NSG on the subnet instead.Public inbound portsYou can select a port to allow from the list. Azure Virtual Desktop doesn't require public inbound ports, so we recommend that you selectNo.Domain to joinSelect which directory you would like to joinSelect fromMicrosoft Entra IDorActive Directoryand complete the relevant parameters for the selected option.To learn more about joining session hosts to Microsoft Entra ID, seeMicrosoft Entra joined session hosts.Virtual Machine Administrator accountUsernameEnter a name to use as the local administrator account for the new session hosts.PasswordEnter a password for the local administrator account.Confirm passwordReenter the password.Custom configurationCustom configuration script URLIf you want to run a PowerShell script during deployment, you can enter the URL here.To add session hosts onAzure Local, expand this section.ParameterValue/DescriptionResource groupThis value defaults to the resource group that you chose to contain your host pool on theBasicstab, but you can select an alternative.Name prefixEnter a name prefix for your session hosts, such ashp01-sh.Each session host has a suffix of a hyphen and then a sequential number added to the end, such ashp01-sh-0.This name prefix can be a maximum of 11 characters and is used in the computer name in the operating system. The prefix and the suffix combined can be a maximum of 15 characters. Session host names must be unique.Virtual machine typeSelectAzure Local.Custom locationIn the dropdown list, select the Azure Local instance where you want to deploy your session hosts.ImagesSelect the OS image that you want to use from the list, or selectManage VM imagesto manage the images available on the instance that you selected.Number of VMsEnter the number of virtual machines that you want to deploy. You can add more later.Virtual processor countEnter the number of virtual processors that you want to assign to each session host. This value isn't validated against the resources available in the instance.Memory typeSelectStaticfor a fixed memory allocation, or selectDynamicfor a dynamic memory allocation.Memory (GB)Enter a number for the amount of memory, in gigabytes, that you want to assign to each session host. This value isn't validated against the resources available in the instance.Network and securityNetwork dropdownSelect an existing network to connect each session to.Domain to joinSelect which directory you would like to joinActive Directoryis the only available option.AD domain join UPNEnter the user principal name (UPN) of an Active Directory user who has permission to join the session hosts to your domain.PasswordEnter the password for the Active Directory user.Specify domain or unitSelectyesif you want to join session hosts to a specific domain or be placed in a specific organizational unit (OU). If you selectno, the suffix of the UPN is used as the domain.Virtual Machine Administrator accountUsernameEnter a name to use as the local administrator account for the new session hosts.PasswordEnter a password for the local administrator account.Confirm passwordReenter the password.To add session hosts onAzure Extended Zones, expand this section.ParameterValue/DescriptionResource groupThis value defaults to the resource group that you chose to contain your host pool on theBasicstab, but you can select an alternative.Name prefixEnter a name prefix for your session hosts, such ashp01-sh.Each session host has a suffix of a hyphen and then a sequential number added to the end, such ashp01-sh-0.This name prefix can be a maximum of 11 characters and is used in the computer name in the operating system. The prefix and the suffix combined can be a maximum of 15 characters. Session host names must be unique.Virtual machine typeSelectAzure virtual machine.Virtual machine locationSelectDeploy to an Azure Extended Zone.Azure Extended ZoneSelect the Extended Zone you require.Network and securitySelect a load balancerSelect an existing Azure load balancer on the same virtual network you want to use for your session hosts, or selectCreate a load balancerto create a new load balancer.Select a backend poolSelect a backend pool on the load balancer you want to use for your session hosts. If you're creating a new load balancer, selectCreate newto create a new backend pool for the new load balancer.Add outbound ruleIf you're creating a new load balancer, selectCreate newto create a new outbound rule for it.After you complete this tab, selectNext: Tags.
On theVirtual machinestab, expand one of the following sections and complete the information, depending on whether you want to create session hosts on Azure or on Azure Local. For guidance on sizing session host virtual machines, seeSession host virtual machine sizing guidelines.
After you complete this tab, selectNext: Tags.
On theTagstab, you can optionally enter any name/value pairs that you need, and then selectNext: Review + create.
On theTagstab, you can optionally enter any name/value pairs that you need, and then selectNext: Review + create.
On theReview + createtab, ensure that validation passes and review the information that will be used during deployment. If validation doesn't pass, review the error message and check what you entered on each tab.
On theReview + createtab, ensure that validation passes and review the information that will be used during deployment. If validation doesn't pass, review the error message and check what you entered on each tab.
SelectCreate. After your deployment is complete, the session hosts should appear in the host pool.
SelectCreate. After your deployment is complete, the session hosts should appear in the host pool.
Important
After you add session hosts by using the Azure Virtual Desktop service, skip to the sectionPost-deployment tasksfor some extra configuration that you might need to do.
Register session hosts to a host pool
If you created virtual machines by using an alternative method outside Azure Virtual Desktop, such as an automated pipeline, you need to register them separately as session hosts to a host pool.
To register session hosts to a host pool, you need to install the Azure Virtual Desktop Agent and the Azure Virtual Desktop Agent Boot Loader on each virtual machine and use the registration key that you generated. You can register session hosts to a host pool by using the agent installers' graphical user interface (GUI) or by usingmsiexecfrom a command line.
msiexec
After you finish, four applications are listed as installed applications:
Remote Desktop Agent Boot Loader
Remote Desktop Services Infrastructure Agent
Remote Desktop Services Infrastructure Geneva Agent
Remote Desktop Services SxS Network Stack
Select the relevant tab for your scenario and follow the steps.
GUI
Command line
Make sure the virtual machines that you want to use as session hosts are joined to Microsoft Entra ID or an Active Directory domain (Active Directory Domain Services or Microsoft Entra Domain Services).
Make sure the virtual machines that you want to use as session hosts are joined to Microsoft Entra ID or an Active Directory domain (Active Directory Domain Services or Microsoft Entra Domain Services).
If your virtual machines are running a Windows Server OS, you need to install theRemote Desktop Session Hostrole and then restart the virtual machine. For more information, seeInstall roles, role services, and features by using the Add Roles and Features Wizard.
If your virtual machines are running a Windows Server OS, you need to install theRemote Desktop Session Hostrole and then restart the virtual machine. For more information, seeInstall roles, role services, and features by using the Add Roles and Features Wizard.
Sign in to your virtual machine as an administrator.
Sign in to your virtual machine as an administrator.
Download the installation files for the Agent and the Agent Boot Loader by using the following links. If you need to unblock them, right-click each file, selectProperties, selectUnblock, and finally selectOK.Azure Virtual Desktop AgentAzure Virtual Desktop Agent BootloaderTipThe Azure Virtual Desktop Agent download link is for the latest production version innon-validation environments. This download link is updated after the automatic production rollout is complete, so you might see a delay between the release of a production version and the update of the download link. After you install the Azure Virtual Desktop Agent, it's updated automatically. For more information about the rollout of new versions of the agent, seeWhat's new in the Azure Virtual Desktop Agent?.
Download the installation files for the Agent and the Agent Boot Loader by using the following links. If you need to unblock them, right-click each file, selectProperties, selectUnblock, and finally selectOK.
Azure Virtual Desktop Agent
Azure Virtual Desktop Agent Bootloader
Tip
The Azure Virtual Desktop Agent download link is for the latest production version innon-validation environments. This download link is updated after the automatic production rollout is complete, so you might see a delay between the release of a production version and the update of the download link. After you install the Azure Virtual Desktop Agent, it's updated automatically. For more information about the rollout of new versions of the agent, seeWhat's new in the Azure Virtual Desktop Agent?.
Run theMicrosoft.RDInfra.RDAgent.Installer-x64-<version>.msifile to install the Remote Desktop Services Infrastructure Agent.
Run theMicrosoft.RDInfra.RDAgent.Installer-x64-<version>.msifile to install the Remote Desktop Services Infrastructure Agent.
Microsoft.RDInfra.RDAgent.Installer-x64-<version>.msi
Follow the prompts. When the installer prompts you for the registration token, paste it into the text box, which appears on a single line. SelectNext, and then complete the installation.
Follow the prompts. When the installer prompts you for the registration token, paste it into the text box, which appears on a single line. SelectNext, and then complete the installation.

Run theMicrosoft.RDInfra.RDAgentBootLoader.Installer-x64-<version>.msifile to install the remaining components.
Run theMicrosoft.RDInfra.RDAgentBootLoader.Installer-x64-<version>.msifile to install the remaining components.
Microsoft.RDInfra.RDAgentBootLoader.Installer-x64-<version>.msi
Follow the prompts and complete the installation.
Follow the prompts and complete the installation.
After a short time, the virtual machines are listed as session hosts in the host pool. The status of the session hosts might initially appear asUnavailable. If a newer agent version is available, it's upgraded automatically.
After a short time, the virtual machines are listed as session hosts in the host pool. The status of the session hosts might initially appear asUnavailable. If a newer agent version is available, it's upgraded automatically.
After the status of the session hosts isAvailable, restart the virtual machines.
After the status of the session hosts isAvailable, restart the virtual machines.
You can usemsiexecto install the agent and the boot loader from the command line by using automated deployment tools, such as Intune or Configuration Manager. In the following examples, be sure to change the<placeholder>values for your own.
msiexec
<placeholder>
Make sure the virtual machines that you want to use as session hosts are joined to Microsoft Entra ID or an Active Directory domain (Active Directory Domain Services or Microsoft Entra Domain Services).
Make sure the virtual machines that you want to use as session hosts are joined to Microsoft Entra ID or an Active Directory domain (Active Directory Domain Services or Microsoft Entra Domain Services).
If your virtual machines are running a Windows Server OS, you need to install theRemote Desktop Session Hostrole by running the following PowerShell command as an administrator, which also restarts the virtual machines.Install-WindowsFeature -Name RDS-RD-Server -Restart
If your virtual machines are running a Windows Server OS, you need to install theRemote Desktop Session Hostrole by running the following PowerShell command as an administrator, which also restarts the virtual machines.
Install-WindowsFeature -Name RDS-RD-Server -Restart
Install-WindowsFeature -Name RDS-RD-Server -Restart
Download the installation files for the Agent and the Agent Boot Loader, and unblock them by running the following commands. The files are downloaded to the current working directory.$uris = @(
    "https://go.microsoft.com/fwlink/?linkid=2310011"
    "https://go.microsoft.com/fwlink/?linkid=2311028"
)

$installers = @()
foreach ($uri in $uris) {
    $expandedUri = (Invoke-WebRequest -MaximumRedirection 0 -Uri $uri -ErrorAction SilentlyContinue).Headers.Location
    $fileName = ($expandedUri).Split('/')[-1]

    Invoke-WebRequest -Uri $expandedUri -UseBasicParsing -OutFile $fileName
    $installers += "$pwd\$fileName"
}

foreach ($installer in $installers) {
    Unblock-File -Path "$installer"
}

Write-Host "`nFiles downloaded:`n"
$installersTipThis version of the Azure Virtual Desktop Agent is the latest downloadable version innon-validation environments. For more information about the rollout of new versions of the agent, seeWhat's new in the Azure Virtual Desktop Agent?.
Download the installation files for the Agent and the Agent Boot Loader, and unblock them by running the following commands. The files are downloaded to the current working directory.
$uris = @(
    "https://go.microsoft.com/fwlink/?linkid=2310011"
    "https://go.microsoft.com/fwlink/?linkid=2311028"
)

$installers = @()
foreach ($uri in $uris) {
    $expandedUri = (Invoke-WebRequest -MaximumRedirection 0 -Uri $uri -ErrorAction SilentlyContinue).Headers.Location
    $fileName = ($expandedUri).Split('/')[-1]

    Invoke-WebRequest -Uri $expandedUri -UseBasicParsing -OutFile $fileName
    $installers += "$pwd\$fileName"
}

foreach ($installer in $installers) {
    Unblock-File -Path "$installer"
}

Write-Host "`nFiles downloaded:`n"
$installers
$uris = @(
    "https://go.microsoft.com/fwlink/?linkid=2310011"
    "https://go.microsoft.com/fwlink/?linkid=2311028"
)

$installers = @()
foreach ($uri in $uris) {
    $expandedUri = (Invoke-WebRequest -MaximumRedirection 0 -Uri $uri -ErrorAction SilentlyContinue).Headers.Location
    $fileName = ($expandedUri).Split('/')[-1]

    Invoke-WebRequest -Uri $expandedUri -UseBasicParsing -OutFile $fileName
    $installers += "$pwd\$fileName"
}

foreach ($installer in $installers) {
    Unblock-File -Path "$installer"
}

Write-Host "`nFiles downloaded:`n"
$installers
Tip
This version of the Azure Virtual Desktop Agent is the latest downloadable version innon-validation environments. For more information about the rollout of new versions of the agent, seeWhat's new in the Azure Virtual Desktop Agent?.
To install the Remote Desktop Services Infrastructure Agent, run the following command as an administrator:msiexec /i Microsoft.RDInfra.RDAgent.Installer-x64-<version>.msi /quiet REGISTRATIONTOKEN=<RegistrationToken>
To install the Remote Desktop Services Infrastructure Agent, run the following command as an administrator:
msiexec /i Microsoft.RDInfra.RDAgent.Installer-x64-<version>.msi /quiet REGISTRATIONTOKEN=<RegistrationToken>
msiexec /i Microsoft.RDInfra.RDAgent.Installer-x64-<version>.msi /quiet REGISTRATIONTOKEN=<RegistrationToken>
To install the remaining components, run the following command as an administrator:msiexec /i Microsoft.RDInfra.RDAgentBootLoader.Installer-x64.msi /quiet
To install the remaining components, run the following command as an administrator:
msiexec /i Microsoft.RDInfra.RDAgentBootLoader.Installer-x64.msi /quiet
msiexec /i Microsoft.RDInfra.RDAgentBootLoader.Installer-x64.msi /quiet
After a short time, the virtual machines are listed as session hosts in the host pool. The status of the session hosts might initially appear asUnavailable. If a newer agent version is available, it's upgraded automatically.
After a short time, the virtual machines are listed as session hosts in the host pool. The status of the session hosts might initially appear asUnavailable. If a newer agent version is available, it's upgraded automatically.
After the status of the session hosts isAvailable, restart the virtual machines.
After the status of the session hosts isAvailable, restart the virtual machines.
Post-deployment tasks
After you add session hosts to your host pool, you might need to do some extra configuration, as described in the following sections.
To ensure that your session hosts have licenses applied correctly, you need to do the following tasks:
If you have the correct licenses to run Azure Virtual Desktop workloads, you can apply a Windows or Windows Server license to your session hosts as part of Azure Virtual Desktop and run them without paying for a separate license. This license is automatically applied when you create session hosts by using the Azure Virtual Desktop service, but you might have to apply the license separately if you create session hosts outside Azure Virtual Desktop. For more information, seeApply a Windows license to session host virtual machines.
If you have the correct licenses to run Azure Virtual Desktop workloads, you can apply a Windows or Windows Server license to your session hosts as part of Azure Virtual Desktop and run them without paying for a separate license. This license is automatically applied when you create session hosts by using the Azure Virtual Desktop service, but you might have to apply the license separately if you create session hosts outside Azure Virtual Desktop. For more information, seeApply a Windows license to session host virtual machines.
If your session hosts are running a Windows Server OS, you also need to issue them a Remote Desktop Services (RDS) client access license (CAL) from an RDS license server. For more information, seeLicense your RDS deployment with client access licenses.
If your session hosts are running a Windows Server OS, you also need to issue them a Remote Desktop Services (RDS) client access license (CAL) from an RDS license server. For more information, seeLicense your RDS deployment with client access licenses.
For session hosts on Azure Local, you must license and activate the virtual machines before you use them with Azure Virtual Desktop. For activating VMs that use Windows 10 Enterprise multi-session, Windows 11 Enterprise multi-session, and Windows Server 2022 Datacenter: Azure Edition, useAzure verification for VMs. For all other OS images (such as Windows 10 Enterprise, Windows 11 Enterprise, and other editions of Windows Server), you should continue to use existing activation methods. For more information, seeActivate Windows Server VMs on Azure Local.
For session hosts on Azure Local, you must license and activate the virtual machines before you use them with Azure Virtual Desktop. For activating VMs that use Windows 10 Enterprise multi-session, Windows 11 Enterprise multi-session, and Windows Server 2022 Datacenter: Azure Edition, useAzure verification for VMs. For all other OS images (such as Windows 10 Enterprise, Windows 11 Enterprise, and other editions of Windows Server), you should continue to use existing activation methods. For more information, seeActivate Windows Server VMs on Azure Local.

For session hosts on Azure that are joined to Microsoft Entra ID, you also need to enable single sign-on or earlier authentication protocols, assign an RBAC role to users, and review your multifactor authentication policies so that users can sign in to the VMs. For more information, seeMicrosoft Entra joined session hosts.
Related content
Now that you've expanded your existing host pool, you can sign in to an Azure Virtual Desktop client to test the hosts as part of a user session. You can connect to a session by using any of the following clients:
Connect with the Windows desktop client
Connect with the web client
Connect with the Android client
Connect with the macOS client
Connect with the iOS client
Feedback
Was this page helpful?
Additional resources