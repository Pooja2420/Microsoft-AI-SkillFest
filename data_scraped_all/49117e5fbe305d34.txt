Note
Access to this page requires authorization. You can trysigning inorchanging directories.
Access to this page requires authorization. You can trychanging directories.
Logging and analyzing the protection usage from Azure Information Protection
Article
2022-10-04
7 contributors
In this article
Note
Are you looking forMicrosoft Purview Information Protection, formerly Microsoft Information Protection (MIP)?
The Azure Information Protection add-in isretiredand replaced with labels that arebuilt in to your Microsoft 365 apps and services. Learn more about thesupport status of other Azure Information Protection components.
TheMicrosoft Purview Information Protection client(without the add-in) isgenerally available.
Use this information to help you understand how you can use usage logging for the protection service (Azure Rights Management) from Azure Information Protection. This protection service provides the data protection for your organization's documents and emails and it can log every request to it. These requests include when users protect documents and email and also consume this content, actions performed by your administrators for this service, and actions performed by Microsoft operators to support your Azure Information Protection deployment.
You can then use these protection usage logs to support the following business scenarios:
Analyze for business insightsThe logs generated by the protection service can be imported into a repository of your choice (such as a database, an online analytical processing (OLAP) system, or a map-reduce system) to analyze the information and produce reports. As an example, you could identify who is accessing your protected data. You can determine what protected data people are accessing, and from what devices and from where. You can find out whether people can successfully read protected content. You can also identify which people have read an important document that was protected.
Analyze for business insights
The logs generated by the protection service can be imported into a repository of your choice (such as a database, an online analytical processing (OLAP) system, or a map-reduce system) to analyze the information and produce reports. As an example, you could identify who is accessing your protected data. You can determine what protected data people are accessing, and from what devices and from where. You can find out whether people can successfully read protected content. You can also identify which people have read an important document that was protected.
Monitor for abuseLogging information about the protection use is available to you in near-real time, so that you can continuously monitor your companyâs use of the protection service. 99.9% of logs are available within 15 minutes of an initiated action to the service.For example, you might want to be alerted if there is a sudden increase of people reading protected data outside standard working hours, which could indicate that a malicious user is collecting information to sell to competitors. Or, if the same user apparently accesses data from two different IP addresses within a short time frame, which could indicate that a user account has been compromised.
Monitor for abuse
Logging information about the protection use is available to you in near-real time, so that you can continuously monitor your companyâs use of the protection service. 99.9% of logs are available within 15 minutes of an initiated action to the service.
For example, you might want to be alerted if there is a sudden increase of people reading protected data outside standard working hours, which could indicate that a malicious user is collecting information to sell to competitors. Or, if the same user apparently accesses data from two different IP addresses within a short time frame, which could indicate that a user account has been compromised.
Perform forensic analysisIf you have an information leak, you are likely to be asked who recently accessed specific documents and what information did a suspected person access recently. You can answer these types of questions when you use this logging because people who use protected content must always get a Rights Management license to open documents and pictures that are protected by Azure Information Protection, even if these files are moved by email or copied to USB drives or other storage devices. This means that you can use these logs as a definitive source of information for forensic analysis when you protect your data by using Azure Information Protection.
Perform forensic analysis
If you have an information leak, you are likely to be asked who recently accessed specific documents and what information did a suspected person access recently. You can answer these types of questions when you use this logging because people who use protected content must always get a Rights Management license to open documents and pictures that are protected by Azure Information Protection, even if these files are moved by email or copied to USB drives or other storage devices. This means that you can use these logs as a definitive source of information for forensic analysis when you protect your data by using Azure Information Protection.
In addition to this usage logging, you also have the following logging options:
In addition, information from the Azure Information Protection client usage logs and the Azure Information Protection scanner is collected and aggregated to create reports in the Azure portal. For more information, seeReporting for Azure Information Protection.
Use the following sections for more information about the usage logging for the protection service.
How to enable logging for protection usage
Protection usage logging is enabled by default for all customers.
There is no extra cost for the log storage or for the logging feature functionality.
How to access and use your protection usage logs
Azure Information Protection writes logs as a series of blobs to an Azure storage account that it automatically creates for your tenant. Each blob contains one or more log records, in W3C extended log format. The blob names are numbers, in the order in which they were created. TheHow to interpret your Azure Rights Management usage logssection later in this document contains more information about the log contents and their creation.
It can take a while for logs to appear in your storage account after a protection action. Most logs appear within 15 minutes. Usage logs are only available when the "date" field name contains a value of a previous date (in UTC time). Usage logs from the current date are not available. We recommend that you download the logs to local storage, such as a local folder, a database, or a map-reduce repository.
To download your usage logs, you will use the AIPService PowerShell module for Azure Information Protection. For installation instructions, seeInstalling the AIPService PowerShell module.
To download your usage logs by using PowerShell
Start Windows PowerShell with theRun as administratoroption and use theConnect-AipServicecmdlet to connect to Azure Information Protection:Connect-AipService
Start Windows PowerShell with theRun as administratoroption and use theConnect-AipServicecmdlet to connect to Azure Information Protection:
Connect-AipService
Connect-AipService
Run the following command to download the logs for a specific date:Get-AipServiceUserLog -Path <location> -fordate <date>For example, after creating a folder called Logs on your E: drive:To download logs for a specific date (such as 2/1/2016), run the following command:Get-AipServiceUserLog -Path E:\Logs -fordate 2/1/2016To download logs for a date range (such as from 2/1/2016 through 2/14/2016), run the following command:Get-AipServiceUserLog -Path E:\Logs -fromdate 2/1/2016 âtodate 2/14/2016
Run the following command to download the logs for a specific date:
Get-AipServiceUserLog -Path <location> -fordate <date>
Get-AipServiceUserLog -Path <location> -fordate <date>
For example, after creating a folder called Logs on your E: drive:
To download logs for a specific date (such as 2/1/2016), run the following command:Get-AipServiceUserLog -Path E:\Logs -fordate 2/1/2016
To download logs for a specific date (such as 2/1/2016), run the following command:Get-AipServiceUserLog -Path E:\Logs -fordate 2/1/2016
Get-AipServiceUserLog -Path E:\Logs -fordate 2/1/2016
To download logs for a date range (such as from 2/1/2016 through 2/14/2016), run the following command:Get-AipServiceUserLog -Path E:\Logs -fromdate 2/1/2016 âtodate 2/14/2016
To download logs for a date range (such as from 2/1/2016 through 2/14/2016), run the following command:Get-AipServiceUserLog -Path E:\Logs -fromdate 2/1/2016 âtodate 2/14/2016
Get-AipServiceUserLog -Path E:\Logs -fromdate 2/1/2016 âtodate 2/14/2016
When you specify the day only, as in our examples, the time is assumed to be 00:00:00 in your local time, and then converted to UTC. When you specify a time with your -fromdate or -todate parameters (for example, -fordate "2/1/2016 15:00:00"), that date and time is converted to UTC. The Get-AipServiceUserLog command then gets the logs for that UTC time period.
You cannot specify less than a whole day to download.
By default, this cmdlet uses three threads to download the logs. If you have sufficient network bandwidth and want to decrease the time required to download the logs, use the -NumberOfThreads parameter, which supports a value from 1 through 32. For example, if you run the following command, the cmdlet spawns 10 threads to download the logs:Get-AipServiceUserLog -Path E:\Logs -fromdate 2/1/2016 âtodate 2/14/2016 -numberofthreads 10
Get-AipServiceUserLog -Path E:\Logs -fromdate 2/1/2016 âtodate 2/14/2016 -numberofthreads 10
Tip
You can aggregate all your downloaded log files into a CSV format by usingMicrosoftâs Log Parser, which is a tool to convert between various well-known log formats. You can also use this tool to convert data to SYSLOG format, or import it into a database. After you have installed the tool, runLogParser.exe /?for help and information to use this tool.
LogParser.exe /?
For example, you might run the following command to import all information into a .log file format:logparser âi:w3c âo:csv "SELECT * INTO AllLogs.csv FROM *.log"
logparser âi:w3c âo:csv "SELECT * INTO AllLogs.csv FROM *.log"
How to interpret your usage logs
Use the following information to help you interpret the protection usage logs.
The log sequence
Azure Information Protection writes the logs as a series of blobs.
Each entry in the log has a UTC timestamp. Because the protection service runs on multiple servers across multiple data centers, sometimes the logs might seem to be out of sequence, even when they are sorted by their timestamp. However, the difference is small and usually within a minute. In most cases, this is not an issue that would be a problem for log analysis.
The blob format
Each blob is in W3C extended log format. It starts with the following two lines:
#Software: RMS
#Version: 1.1
The first line identifies that these are protection logs from Azure Information Protection. The second line identifies that the rest of the blob follows the version 1.1 specification. We recommend that any applications that parse these logs verify these two lines before continuing to parse the rest of the blob.
The third line enumerates a list of field names that are separated by tabs:
#Fields: date            time            row-id        request-type           user-id       result          correlation-id          content-id                owner-email           issuer                     template-id             file-name                  date-published      c-info         c-ip            admin-action            acting-as-user
Each of the subsequent lines is a log record. The values of the fields are in the same order as the preceding line, and are separated by tabs. Use the following table to interpret the fields.
Although the user-id field usually indicates the user who made the request, there are two exceptions where the value does not map to a real user:
The value'microsoftrmsonline@<YourTenantID>.rms.<region>.aadrm.com'.This indicates an Office 365 service, such as Exchange Online or Microsoft SharePoint, is making the request. In the string,<YourTenantID>is the GUID for your tenant and<region>is the region where your tenant is registered. For example,narepresents North America,eurepresents Europe, andaprepresents Asia.
The value'microsoftrmsonline@<YourTenantID>.rms.<region>.aadrm.com'.
This indicates an Office 365 service, such as Exchange Online or Microsoft SharePoint, is making the request. In the string,<YourTenantID>is the GUID for your tenant and<region>is the region where your tenant is registered. For example,narepresents North America,eurepresents Europe, andaprepresents Asia.
If you are using the RMS connector.Requests from this connector are logged with the service principal name ofAadrm_S-1-7-0, which is automatically generated when you install the RMS connector.
If you are using the RMS connector.
Requests from this connector are logged with the service principal name ofAadrm_S-1-7-0, which is automatically generated when you install the RMS connector.
There are many request types for the protection service but the following table identifies some of the most typically used request types.
File access and denied events do not currently include file name and are not accessible in the Microsoft 365 unified audit log. These events will be enhanced to be standalone useful and added from the Rights Management Service at a later date.
PowerShell reference
The only PowerShell cmdlet that you need to access your protection usage logging isGet-AipServiceUserLog.
For more information about using PowerShell for Azure Information Protection, seeAdministering protection from Azure Information Protection by using PowerShell.
Feedback
Was this page helpful?
Additional resources